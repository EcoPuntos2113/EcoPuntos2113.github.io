
<!DOCTYPE html>
<html lang="en" data-theme="default">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EcoScore Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
      :root {
        --primary-hue: 158;
        --secondary-hue: 239;
        
        --bg-color: #f8fafc; /* slate-50 */
        --text-color: #0f172a; /* slate-900 */
        --text-subtle: #475569; /* slate-600 */
        --card-bg: rgba(255, 255, 255, 0.6);
        --sidebar-bg: rgba(4, 120, 87, 0.85); /* emerald-700/85 */
        --sidebar-text: #d1fae5; /* emerald-100 */
        --sidebar-text-strong: var(--primary-light);
        --sidebar-hover-bg: rgba(6, 95, 70, 0.7); /* emerald-800/70 */
        --border-color: #e2e8f0; /* slate-200 */
        --hover-bg: #f1f5f9; /* slate-100 */

        --primary-color: #10b981; /* emerald-500 */
        --primary-dark: #059669; /* emerald-600 */
        --primary-light: #34d399; /* emerald-400 */
        --secondary-color: #6366f1; /* indigo-500 */
        --warning-color: #f59e0b; /* amber-500 */
        --success-color: #22c55e; /* green-500 */
        --dark-text: #ffffff;
      }
      .dark {
        --bg-color: #0f172a; /* slate-900 */
        --text-color: #f8fafc; /* slate-50 */
        --text-subtle: #94a3b8; /* slate-400 */
        --card-bg: rgba(30, 41, 59, 0.6); /* slate-800/60 */
        --sidebar-bg: rgba(6, 95, 70, 0.8); /* emerald-800/80 */
        --sidebar-text: #d1fae5; /* emerald-100 */
        --sidebar-text-strong: var(--primary-light);
        --sidebar-hover-bg: rgba(4, 120, 87, 0.7); /* emerald-700/70 */
        --border-color: #334155; /* slate-700 */
        --hover-bg: #1e293b; /* slate-800 */

        --primary-color: #10b981;
        --primary-dark: #059669;
        --primary-light: #34d399;
        --secondary-color: #818cf8; /* indigo-400 */
        --warning-color: #f59e0b;
        --success-color: #22c55e;
        --dark-text: #ffffff;
      }
      
      /* START: Custom Color Themes */
      html[data-theme='emerald-white'] {
        --primary-hue: 150; --secondary-hue: 150;
        --primary-color: #2ECC71; --primary-dark: #27AE60; --primary-light: #A2D9A0;
        --secondary-color: #A2D9A0; --bg-color: #FFFFFF; --text-color: #1A202C; --text-subtle: #4A5568;
        --card-bg: rgba(247, 250, 252, 0.8); --sidebar-bg: rgba(30, 132, 73, 0.95); --sidebar-text: #ffffff;
        --sidebar-hover-bg: rgba(39, 174, 96, 0.8); --border-color: #EDF2F7; --hover-bg: #F7FAFC; --dark-text: #ffffff;
        --sidebar-text-strong: #d1fae5;
      }
      html[data-theme='emerald-white'].dark {
        --bg-color: #1A202C; --text-color: #F7FAFC; --text-subtle: #A0AEC0; --card-bg: rgba(45, 55, 72, 0.7);
        --sidebar-bg: rgba(39, 174, 96, 0.9); --border-color: #2D3748; --hover-bg: #2D3748;
        --sidebar-text: #dcfce7; --sidebar-text-strong: #f0fdf4;
      }

      html[data-theme='sky-forest'] {
        --primary-hue: 146; --secondary-hue: 204;
        --primary-color: #27AE60; --primary-dark: #229954; --primary-light: #52BE80;
        --secondary-color: #3498DB; --bg-color: #F5F5DC; --text-color: #3D4852; --text-subtle: #606F7B;
        --card-bg: rgba(255, 255, 255, 0.6); --sidebar-bg: rgba(30, 132, 73, 0.95); --sidebar-text: #ffffff;
        --sidebar-hover-bg: rgba(34, 153, 84, 0.8); --border-color: #DAE1E7; --hover-bg: #FFFFFF; --dark-text: #ffffff;
        --sidebar-text-strong: #dcfce7;
      }
      html[data-theme='sky-forest'].dark {
        --bg-color: #2C3A47; --text-color: #F0F4F8; --text-subtle: #9FB3C8; --card-bg: rgba(45, 55, 72, 0.6);
        --sidebar-bg: rgba(34, 153, 84, 0.9); --border-color: #485563; --hover-bg: #485563;
        --sidebar-text: #dcfce7; --sidebar-text-strong: #f0fdf4;
      }

      html[data-theme='earth-nature'] {
        --primary-hue: 60; --secondary-hue: 40;
        --primary-color: #808000; --primary-dark: #666600; --primary-light: #999900;
        --secondary-color: #D2B48C; --bg-color: #F9F9F9; --text-color: #4F4F4F; --text-subtle: #828282;
        --card-bg: rgba(255, 255, 255, 0.7); --sidebar-bg: rgba(92, 76, 60, 0.95); --sidebar-text: #F9F9F9;
        --sidebar-hover-bg: rgba(102, 102, 0, 0.8); --border-color: #E0E0E0; --hover-bg: #FFFFFF; --dark-text: #ffffff;
        --sidebar-text-strong: #ffffff;
      }
      html[data-theme='earth-nature'].dark {
        --bg-color: #2F2F2F; --text-color: #F2F2F2; --text-subtle: #BDBDBD; --card-bg: rgba(79, 79, 79, 0.6);
        --sidebar-bg: rgba(102, 102, 0, 0.9); --border-color: #4F4F4F; --hover-bg: #4F4F4F;
        --sidebar-text-strong: #fefce8;
      }

      html[data-theme='sunny-apple'] {
        --primary-hue: 147; --secondary-hue: 47;
        --primary-color: #7DCEA0; --primary-dark: #52BE80; --primary-light: #ABEBC6;
        --secondary-color: #F1C40F; --bg-color: #EAECEE; --text-color: #2C3E50; --text-subtle: #566573;
        --card-bg: rgba(255, 255, 255, 0.7); --sidebar-bg: rgba(82, 190, 128, 0.95); --sidebar-text: #ffffff;
        --sidebar-hover-bg: rgba(82, 190, 128, 0.8); --border-color: #D5DBDB; --hover-bg: #F4F6F6; --dark-text: #ffffff;
        --sidebar-text-strong: #d1fae5;
      }
      html[data-theme='sunny-apple'].dark {
        --bg-color: #283747; --text-color: #E5E7E9; --text-subtle: #909497; --card-bg: rgba(86, 101, 115, 0.6);
        --sidebar-bg: rgba(82, 190, 128, 0.9); --sidebar-text: #ffffff; --border-color: #566573; --hover-bg: #566573; --secondary-color: #F39C12;
        --sidebar-text-strong: #ffffff;
      }

      html[data-theme='pastel-tones'] {
        --primary-hue: 118; --secondary-hue: 207;
        --primary-color: #A2D9A0; --primary-dark: #7DCEA0; --primary-light: #D5F5E3;
        --secondary-color: #AED6F1; --bg-color: #FFFFFF; --text-color: #5D6D7E; --text-subtle: #85929E;
        --card-bg: rgba(244, 246, 247, 0.8); --sidebar-bg: rgba(125, 206, 160, 0.95); --sidebar-text: #ffffff;
        --sidebar-hover-bg: rgba(125, 206, 160, 0.8); --border-color: #E5E8E8; --hover-bg: #F4F6F7; --dark-text: #ffffff;
        --sidebar-text-strong: #dcfce7;
      }
      html[data-theme='pastel-tones'].dark {
        --bg-color: #2C3E50; --text-color: #ECF0F1; --text-subtle: #B3B6B7; --card-bg: rgba(93, 109, 126, 0.7);
        --sidebar-bg: rgba(125, 206, 160, 0.9); --sidebar-text: #212F3D; --border-color: #5D6D7E; --hover-bg: #5D6D7E;
        --sidebar-text-strong: #1e3b2a;
      }

      html[data-theme='aquatic-colors'] {
        --primary-hue: 168; --secondary-hue: 210;
        --primary-color: #1ABC9C; --primary-dark: #16A085; --primary-light: #48C9B0;
        --secondary-color: #A9CCE3; --bg-color: #2C3E50; --text-color: #ECF0F1; --text-subtle: #BDC3C7;
        --card-bg: rgba(52, 73, 94, 0.7); --sidebar-bg: rgba(22, 160, 133, 0.9); --sidebar-text: #ffffff;
        --sidebar-hover-bg: rgba(26, 188, 156, 0.7); --border-color: #34495E; --hover-bg: #34495E; --dark-text: #ffffff;
        --sidebar-text-strong: #ecf0f1;
      }
      html[data-theme='aquatic-colors'].dark {
        --card-bg: rgba(44, 62, 80, 0.8); --hover-bg: #405467;
        --sidebar-text-strong: #ecf0f1;
      }

      html[data-theme='dark-light-green'] {
        --primary-hue: 151; --secondary-hue: 151;
        --primary-color: #58D68D; --primary-dark: #28B463; --primary-light: #82E0AA;
        --secondary-color: #1E8449; --bg-color: #EAECEE; --text-color: #273746; --text-subtle: #515A5A;
        --card-bg: rgba(251, 252, 252, 0.7); --sidebar-bg: rgba(30, 132, 73, 0.9); --sidebar-text: #ffffff;
        --sidebar-hover-bg: rgba(40, 180, 99, 0.8); --border-color: #D6DBDF; --hover-bg: #F2F4F4; --dark-text: #ffffff;
        --sidebar-text-strong: #dcfce7;
      }
      html[data-theme='dark-light-green'].dark {
        --bg-color: #1B2631; --text-color: #E5E7E9; --text-subtle: #7B7D7D; --card-bg: rgba(40, 55, 71, 0.7);
        --sidebar-bg: rgba(40, 180, 99, 0.9); --border-color: #2E4053; --hover-bg: #2E4053;
        --sidebar-text: #dcfce7; --sidebar-text-strong: #f0fdf4;
      }
      /* END: Custom Color Themes */
      
      body {
        font-family: 'Be Vietnam Pro', sans-serif;
        background-color: var(--bg-color);
      }
      
      :focus-visible {
          outline: 2px solid var(--primary-color);
          outline-offset: 2px;
          border-radius: 4px;
      }

      /* Animated Gradient Text */
      .gradient-text {
        background-image: linear-gradient(90deg, var(--primary-color), var(--primary-dark));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-fill-color: transparent;
      }
      
      /* Fix for low-contrast headers on certain light themes */
      html[data-theme='emerald-white']:not(.dark) .gradient-text,
      html[data-theme='sunny-apple']:not(.dark) .gradient-text,
      html[data-theme='pastel-tones']:not(.dark) .gradient-text,
      html[data-theme='dark-light-green']:not(.dark) .gradient-text {
        background-image: none;
        -webkit-text-fill-color: var(--text-color);
        text-fill-color: var(--text-color);
      }
      
      /* Override sidebar logo color on specific themes for legibility */
      html[data-theme='sky-forest'] .sidebar-logo,
      html[data-theme='aquatic-colors'] .sidebar-logo,
      html[data-theme='dark-light-green'] .sidebar-logo {
          background-image: none !important;
          -webkit-text-fill-color: var(--sidebar-text-strong) !important;
          text-fill-color: var(--sidebar-text-strong) !important;
      }

      /* Aurora Background */
      .aurora-bg {
        position: relative;
        overflow: hidden;
      }
      .aurora-bg::before, .aurora-bg::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 150vw;
        height: 150vw;
        border-radius: 50%;
        opacity: 0.15;
        filter: blur(100px);
        z-index: -1;
        animation: rotate 40s linear infinite;
        background-blend-mode: overlay;
      }
      .dark .aurora-bg::before, .dark .aurora-bg::after {
        opacity: 0.25;
      }
      
      .aurora-bg::before {
        background-color: hsla(var(--primary-hue), 100%, 70%, 1);
        transform: translate(-30%, -60%);
      }
      
      .aurora-bg::after {
        background-color: hsla(var(--secondary-hue), 100%, 70%, 1);
        transform: translate(-70%, -40%);
        animation-direction: reverse;
        animation-duration: 30s;
      }

      @keyframes rotate {
        from { transform: translate(-30%, -60%) rotate(0deg); }
        to { transform: translate(-30%, -60%) rotate(360deg); }
      }

      @keyframes pure-rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
      
      /* Old animations - keep for now, might be used */
      @keyframes toast-in { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      @keyframes toast-out { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-100%); opacity: 0; } }
      .toast-in { animation: toast-in 0.5s ease-out forwards; }
      .toast-out { animation: toast-out 0.5s ease-in forwards; }
      .frame-wood { border: 10px solid #854d0e; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); background-color: #a16207; }
      .frame-aura { box-shadow: 0 0 15px var(--primary-light), inset 0 0 5px var(--primary-light); animation: pulse-green 2s infinite; }
      .frame-gold { border: 6px solid #ca8a04; box-shadow: 0 0 15px #ca8a04, inset 0 0 5px #facc15; }
      .frame-tech { border: 4px solid #0ea5e9; box-shadow: 0 0 10px #0ea5e9, inset 0 0 10px #0ea5e9; animation: pulse-blue 2s infinite; }
      .frame-leafy { border: 6px solid #10b981; box-shadow: 0 0 12px #34d399, inset 0 0 6px #34d399; animation: pulse-green 2.5s infinite; }
      .frame-water { border: 4px solid #3b82f6; animation: ripple-border 3s infinite ease-out; }
      @keyframes pulse-blue { 0% { box-shadow: 0 0 10px #0ea5e9, inset 0 0 10px #0ea5e9; } 50% { box-shadow: 0 0 20px #38bdf8, inset 0 0 15px #38bdf8; } 100% { box-shadow: 0 0 10px #0ea5e9, inset 0 0 10px #0ea5e9; } }
      @keyframes pulse-green { 0% { box-shadow: 0 0 10px var(--primary-color), inset 0 0 5px var(--primary-color); } 50% { box-shadow: 0 0 20px var(--primary-light), inset 0 0 10px var(--primary-light); } 100% { box-shadow: 0 0 10px var(--primary-color), inset 0 0 5px var(--primary-color); } }
      @keyframes cloud-fly { from { transform: translateX(-150%); } to { transform: translateX(calc(100vw + 150%)); } }
      @keyframes ripple-border { 0% { box-shadow: 0 0 0 0px rgba(59, 130, 246, 0.5); } 100% { box-shadow: 0 0 0 12px rgba(59, 130, 246, 0); } }
      @keyframes ripple { 0% { transform: scale(1); opacity: 0.7; } 50% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(1); opacity: 0.7; } }
      @keyframes twinkle { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.3; transform: scale(0.8); } }
      @keyframes sun-ray-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
      @keyframes gentle-sway { 0%, 100% { transform: rotate(-1deg); } 50% { transform: rotate(1deg); } }
      @keyframes falling-petal { 0% { transform: translateY(-10%) translateX(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(150px) translateX(30px) rotate(360deg); opacity: 0; } }
      .animate-twinkle { animation: twinkle 4s ease-in-out infinite; }
      .animate-sun-ray-spin { animation: sun-ray-spin linear infinite; }
      .animate-gentle-sway { animation: gentle-sway 8s ease-in-out infinite alternate; }
      .animate-falling-petal { animation: falling-petal linear infinite; }
      
      /* --- From GlobalStyles.tsx --- */
      body {
            font-family: 'Be Vietnam Pro', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .prose {
            color: var(--text-color);
        }
        .prose h3 {
            color: var(--text-color);
            margin-bottom: 0.5em;
        }
         .prose p, .prose ul, .prose ol {
            color: var(--text-subtle);
        }
        .prose strong {
            color: var(--text-color);
        }
        .prose li::marker {
            color: var(--primary-color);
        }
        
        .glass-card {
            background-color: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
        }

        /* Custom Scrollbar Styles */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--hover-bg);
        }
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        ::-webkit-scrollbar-track {
            background: var(--hover-bg);
        }
        ::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 20px;
            border: 3px solid var(--hover-bg);
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary-dark);
        }

        @keyframes fade-in {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        .animate-fade-in {
            animation: fade-in 0.6s ease-out forwards;
        }
        @keyframes fade-in-down {
            0% {
                opacity: 0;
                transform: translateY(-20px) scale(0.98);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .animate-fade-in-down {
            animation: fade-in-down 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        @keyframes fade-out-up {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
        .animate-fade-out-up {
            animation: fade-out-up 0.4s ease-in forwards;
        }
        @keyframes stagger-in {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-stagger-in {
            animation: stagger-in 0.5s ease-out backwards;
            animation-fill-mode: backwards;
        }
        @keyframes shake { 
            0%, 100% { transform: translateX(0); } 
            25% { transform: translateX(-5px); } 
            75% { transform: translateX(5px); } 
        }
        .animate-shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes scan { 
            0% { transform: translateY(-100%); } 
            100% { transform: translateY(100%); }
        }
        .animate-scan {
            animation: scan 2.5s cubic-bezier(0.86, 0, 0.07, 1) infinite;
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }
        .animate-float {
            animation: float 4s ease-in-out infinite;
        }
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: .8; transform: scale(0.98); }
        }
        .animate-pulse-slow {
            animation: pulse-slow 4s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: {
              sans: ['Be Vietnam Pro', 'sans-serif'],
            },
            colors: {
              background: 'var(--bg-color)',
              text: 'var(--text-color)',
              'text-subtle': 'var(--text-subtle)',
              card: 'var(--card-bg)',
              sidebar: 'var(--sidebar-bg)',
              'sidebar-text': 'var(--sidebar-text)',
              'sidebar-text-strong': 'var(--sidebar-text-strong)',
              'sidebar-hover': 'var(--sidebar-hover-bg)',
              border: 'var(--border-color)',
              hover: 'var(--hover-bg)',
              primary: {
                DEFAULT: 'var(--primary-color)',
                dark: 'var(--primary-dark)',
                light: 'var(--primary-light)',
              },
              secondary: 'var(--secondary-color)',
              warning: 'var(--warning-color)',
              success: 'var(--success-color)',
              'dark-text': 'var(--dark-text)',
            },
            boxShadow: {
                'primary-glow-sm': '0 0 15px -3px var(--primary-color)',
                'primary-glow-md': '0 0 25px -5px var(--primary-color)',
                'primary-glow-lg': '0 0 40px -10px var(--primary-color)',
            }
          }
        }
      }
    </script>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19.1.0",
    "react-dom/client": "https://esm.sh/react-dom@19.1.0/client",
    "react-dom/": "https://esm.sh/react-dom@^19.1.0/",
    "react/": "https://esm.sh/react@^19.1.0/",
    "@google/genai": "https://esm.sh/@google/genai@^1.8.0"
  }
}
</script>
</head>
  <body class="bg-background text-text transition-colors duration-300">
    <div id="root"></div>
    <script type="module">
// --- START OF SCRIPT ---
import React, { useState, useEffect, useCallback, useRef, useContext, createContext, useMemo } from 'react';
import ReactDOM from 'react-dom/client';

// --- START OF FILE: constants.ts ---
const mainNavItems = [
  { name: 'Inicio', icon: 'fa-solid fa-house' },
  { name: 'Escáner', icon: 'fa-solid fa-qrcode' },
  { name: 'Tienda', icon: 'fa-solid fa-store' },
  { name: 'Educación', icon: 'fa-solid fa-book-open' },
  { name: 'Minijuegos', icon: 'fa-solid fa-gamepad' },
  { name: 'Comunidad', icon: 'fa-solid fa-users' },
  { name: 'Ranking', icon: 'fa-solid fa-trophy' },
  { name: 'Eco-Jardín', icon: 'fa-solid fa-tree' },
  { name: 'Eco-Calculadora', icon: 'fa-solid fa-calculator' },
  { name: 'Perfil', icon: 'fa-solid fa-user' },
];
// --- END OF FILE: constants.ts ---

// --- START OF FILE: mockData.ts ---
const allAchievements = [
    // Fácil
    {id:'a1', name:'Primeros Pasos', description: 'Completa tu primer escaneo de producto reciclable', icon: 'fa-solid fa-qrcode', isUnlocked: false, difficulty: 'Fácil'},
    {id:'a2', name:'Aprendiz de Eco', description: 'Completa tu primera lección educativa', icon: 'fa-solid fa-graduation-cap', isUnlocked: false, difficulty: 'Fácil'},
    {id:'a3', name:'Socialité', description: 'Publica tu primer consejo en la comunidad', icon: 'fa-solid fa-users', isUnlocked: false, difficulty: 'Fácil'},
    {id:'a4', name:'Juguetón', description: 'Juega tu primer minijuego', icon: 'fa-solid fa-gamepad', isUnlocked: false, difficulty: 'Fácil'},
    {id:'a5', name:'Comprador Consciente', description: 'Canjea tu primera recompensa en la tienda', icon: 'fa-solid fa-store', isUnlocked: false, progress: {current: 0, total: 1}, difficulty: 'Fácil'},
    {id:'a6', name:'Racha de 3 Días', description: 'Inicia sesión en la app por 3 días seguidos', icon: 'fa-solid fa-calendar-days', isUnlocked: false, progress: {current: 0, total: 3}, difficulty: 'Fácil'},
    {id:'a7', name:'Curioso', description: 'Visita todas las secciones principales de la app', icon: 'fa-solid fa-compass', isUnlocked: false, difficulty: 'Fácil'},
    {id:'a8', name:'Buen Samaritano', description: 'Dale "Me gusta" a 5 publicaciones en la comunidad', icon: 'fa-solid fa-thumbs-up', isUnlocked: false, progress: {current: 0, total: 5}, difficulty: 'Fácil'},
    {id:'a36', name:'Colaborador Pro', description: 'Apoya la app con una suscripción Pro', icon: 'fa-solid fa-gem', isUnlocked: false, difficulty: 'Fácil'},

    // Intermedio
    {id:'ach-lp1', name:'Guardián del Plástico', description: 'Completa la ruta de aprendizaje sobre plásticos.', icon: 'fa-solid fa-shield-halved', isUnlocked: false, difficulty: 'Intermedio'},
    {id:'ach-lp2', name:'Maestro del Compostaje', description: 'Completa la ruta de aprendizaje sobre compostaje.', icon: 'fa-solid fa-leaf', isUnlocked: false, difficulty: 'Intermedio'},
    {id:'ach-lp3', name:'Campeón de la Energía', description: 'Completa la ruta de aprendizaje sobre energía.', icon: 'fa-solid fa-bolt', isUnlocked: false, difficulty: 'Intermedio'},
    {id:'ach-lp4', name:'Consumidor Consciente', description: 'Completa la ruta de aprendizaje sobre consumo.', icon: 'fa-solid fa-cart-shopping', isUnlocked: false, difficulty: 'Intermedio'},
    {id:'ach-lp5', name:'Héroe del Agua', description: 'Completa la ruta de aprendizaje sobre la conservación del agua.', icon: 'fa-solid fa-tint', isUnlocked: false, difficulty: 'Intermedio'},
    {id:'a9', name:'Reciclador Novato', description: 'Recicla 25 productos diferentes', icon: 'fa-solid fa-recycle', isUnlocked: false, progress: {current: 0, total: 25}, difficulty: 'Intermedio'},
    {id:'a10', name:'Estudiante Aplicado', description: 'Completa 5 lecciones educativas', icon: 'fa-solid fa-book-open', isUnlocked: false, progress: {current: 0, total: 5}, difficulty: 'Intermedio'},
    {id:'a11', name:'Racha de una Semana', description: 'Inicia sesión en la app por 7 días seguidos', icon: 'fa-solid fa-calendar-week', isUnlocked: false, progress: {current: 0, total: 7}, difficulty: 'Intermedio'},
    {id:'a13', name:'Acumulador de Puntos', description: 'Alcanza los 2,500 puntos EcoScore', icon: 'fa-solid fa-coins', isUnlocked: false, progress: {current: 0, total: 2500}, difficulty: 'Intermedio'},
    {id:'a15', name:'Conversador', description: 'Deja 10 comentarios en la comunidad', icon: 'fa-solid fa-comments', isUnlocked: false, progress: {current: 0, total: 10}, difficulty: 'Intermedio'},
    {id:'a16', name:'Guardabosques', description: 'Planta un árbol a través de la tienda EcoScore', icon: 'fa-solid fa-tree', isUnlocked: false, difficulty: 'Intermedio'},
    {id:'a32', name:'Eco-Chef', description: 'Composta 20 artículos orgánicos', icon: 'fa-solid fa-utensils', isUnlocked: false, difficulty: 'Intermedio', progress: {current: 0, total: 20}},
    {id:'a33', name:'Game Master', description: 'Obtén más de 100 puntos en cualquier minijuego', icon: 'fa-solid fa-star', isUnlocked: false, difficulty: 'Intermedio'},

    // Difícil
    {id:'ach-lp6', name:'Innovador Circular', description: 'Completa la ruta de aprendizaje Pro sobre economía circular.', icon: 'fa-solid fa-infinity', isUnlocked: false, difficulty: 'Difícil'},
    {id:'a19', name:'Reciclador Avanzado', description: 'Recicla 100 productos diferentes', icon: 'fa-solid fa-award', isUnlocked: false, progress: {current: 0, total: 100}, difficulty: 'Difícil'},
    {id:'a20', name:'EcoHéroe', description: 'Alcanza los 5,000 puntos EcoScore', icon: 'fa-solid fa-trophy', isUnlocked: false, progress: {current: 0, total: 5000}, difficulty: 'Difícil'},
    {id:'a21', name:'Top 100 Nacional', description: 'Alcanza el top 100 del ranking nacional', icon: 'fa-solid fa-ranking-star', isUnlocked: false, difficulty: 'Difícil'},
    {id:'a22', name:'Coleccionista Pro', description: 'Desbloquea todos los minijuegos Pro', icon: 'fa-solid fa-crown', isUnlocked: false, difficulty: 'Difícil'},
    {id:'a23', name:'Súper Fan', description: 'Canjea 5 recompensas diferentes en la tienda', icon: 'fa-solid fa-cart-shopping', isUnlocked: false, progress: {current: 0, total: 5}, difficulty: 'Difícil'},
    {id:'a24', name:'Cerebrito', description: 'Completa todas las lecciones educativas', icon: 'fa-solid fa-brain', isUnlocked: false, progress: {current: 0, total: 24}, difficulty: 'Difícil'},
    {id:'a25', name:'Racha de un Mes', description: 'Inicia sesión en la app por 30 días seguidos', icon: 'fa-solid fa-calendar', isUnlocked: false, progress: {current: 0, total: 30}, difficulty: 'Difícil'},
    {id:'a34', name:'Pilar de la Comunidad', description: 'Publica 10 veces en la comunidad', icon: 'fa-solid fa-bullhorn', isUnlocked: false, difficulty: 'Difícil', progress: {current: 0, total: 10}},

    // Experto
    {id:'a28', name:'Maestro del Reciclaje', description: 'Recicla 500 productos', icon: 'fa-solid fa-shield-halved', isUnlocked: false, progress: {current: 0, total: 500}, difficulty: 'Experto'},
    {id:'a29', name:'Leyenda Ecológica', description: 'Alcanza los 10,000 puntos EcoScore', icon: 'fa-solid fa-gem', isUnlocked: false, progress: {current: 0, total: 10000}, difficulty: 'Experto'},
    {id:'a30', name:'Top 10 Nacional', description: 'Alcanza el top 10 del ranking nacional', icon: 'fa-solid fa-meteor', isUnlocked: false, difficulty: 'Experto'},
    {id:'a31', name:'Compromiso Total', description: 'Mantén una racha de 100 días de inicio de sesión', icon: 'fa-solid fa-infinity', isUnlocked: false, progress: {current: 0, total: 100}, difficulty: 'Experto'},
    {id:'a35', name:'Explorador Sabio', description: 'Completa todas las rutas de aprendizaje', icon: 'fa-solid fa-map-signs', isUnlocked: false, difficulty: 'Experto'},
];
const LEVELS = [
  { name: 'Eco Novato', minPoints: 0 },
  { name: 'EcoAmigo', minPoints: 1000 },
  { name: 'EcoGuardián', minPoints: 5000 },
  { name: 'EcoHéroe', minPoints: 10000 },
  { name: 'EcoLeyenda', minPoints: 20000 },
];
const allAvatars = [
    { id: 'avatar-default', name: 'Principiante', icon: 'fa-solid fa-seedling', cost: 0 },
    { id: 'avatar-leaf', name: 'Hoja Verde', icon: 'fa-solid fa-leaf', cost: 500 },
    { id: 'avatar-sprout', name: 'Brote Delicado', icon: 'fa-solid fa-spa', cost: 600 },
    { id: 'avatar-water', name: 'Gota de Agua', icon: 'fa-solid fa-droplet', cost: 500 },
    { id: 'avatar-recycle', name: 'Símbolo Reciclaje', icon: 'fa-solid fa-recycle', cost: 750 },
    { id: 'avatar-tree', name: 'Árbol Fuerte', icon: 'fa-solid fa-tree', cost: 1000 },
    { id: 'avatar-wind', name: 'Turbina Eólica', icon: 'fa-solid fa-wind', cost: 1200 },
    { id: 'avatar-earth', name: 'Planeta Tierra', icon: 'fa-solid fa-earth-americas', cost: 1500, isPro: true },
    { id: 'avatar-atom', name: 'Átomo de Energía', icon: 'fa-solid fa-atom', cost: 1500, isPro: true },
    { id: 'avatar-sun', name: 'Sol Radiante', icon: 'fa-solid fa-sun', cost: 1800, isPro: true },
    { id: 'avatar-mountain', name: 'Montaña Majestuosa', icon: 'fa-solid fa-mountain-sun', cost: 2200, isPro: true },
];
const allAvatarFrames = [
    { id: 'frame-none', name: 'Sin Marco', frameClass: '', cost: 0 },
    { id: 'frame-circle', name: 'Círculo Simple', frameClass: 'border-4 border-gray-300 dark:border-gray-600', cost: 200 },
    { id: 'frame-wood', name: 'Marco de Madera', frameClass: 'frame-wood', cost: 800 },
    { id: 'frame-aura', name: 'Aura Energética', frameClass: 'frame-aura', cost: 1200 },
    { id: 'frame-leafy', name: 'Enredadera de Hojas', frameClass: 'frame-leafy', cost: 1500 },
    { id: 'frame-gold', name: 'Marco Dorado', frameClass: 'frame-gold', cost: 2000, isPro: true },
    { id: 'frame-tech', name: 'Marco Tecnológico', frameClass: 'frame-tech', cost: 2000, isPro: true },
    { id: 'frame-water', name: 'Ondas de Agua', frameClass: 'frame-water', cost: 1800, isPro: true },
];
const allProfileTitles = [
    { id: 'title-novice', name: 'Eco Novato', cost: 0 },
    { id: 'title-friend', name: 'Amigo del Planeta', cost: 300 },
    { id: 'title-recycler', name: 'Reciclador Dedicado', cost: 600 },
    { id: 'title-gardener', name: 'Jardinero Urbano', cost: 800 },
    { id: 'title-guardian', name: 'Guardián del Bosque', cost: 1000 },
    { id: 'title-innovator', name: 'Innovador Circular', cost: 1200 },
    { id: 'title-champion', name: 'Campeón Sostenible', cost: 1500, isPro: true },
    { id: 'title-legend', name: 'Leyenda Ecológica', cost: 2500, isPro: true },
    { id: 'title-terraformer', name: 'Terraformador', cost: 3000, isPro: true },
];
const MOCK_USER = {
    name: 'Matias Cajas',
    initials: 'MC',
    location: 'Lima, Perú',
    level: 'EcoAmigo',
    avatarId: 'avatar-leaf',
    avatarFrameId: 'frame-wood',
    profileTitleId: 'title-friend',
    displayedBadges: ['a30', 'a29', 'ach-lp1'],
};
const newLessons = [
    {
        id: 'l6', category: "Fundamentos del Reciclaje", title: 'El Ciclo de Vida del Plástico', description: 'Sigue el viaje de una botella de plástico desde que la usas hasta que se convierte en un nuevo producto.', isPro: false, icon: 'fa-solid fa-arrows-spin', status: 'start', content: React.createElement(React.Fragment, null, 
            React.createElement('h3', null, 'Un Viaje de Transformación'),
            React.createElement('p', null, 'El plástico que reciclas no desaparece, ¡se transforma!'),
            React.createElement('ol', null, 
                React.createElement('li', null, React.createElement('strong', null, 'Recolección:'), ' Todo empieza cuando depositas tu botella en el contenedor amarillo.'),
                React.createElement('li', null, React.createElement('strong', null, 'Clasificación:'), ' En la planta, se separan los diferentes tipos de plásticos (PET, HDPE, etc.).'),
                React.createElement('li', null, React.createElement('strong', null, 'Triturado y Lavado:'), ' El plástico se tritura en pequeños trozos llamados "escamas" y se lava para eliminar impurezas.'),
                React.createElement('li', null, React.createElement('strong', null, 'Creación de Pellets:'), ' Las escamas se derriten y se convierten en pequeños granos de plástico reciclado, o "pellets".'),
                React.createElement('li', null, React.createElement('strong', null, 'Nuevo Producto:'), ' ¡Estos pellets se usan para fabricar nuevas botellas, fibra textil para ropa, muebles y mucho más!')
            )
        )
    },
    {
        id: 'l8', category: "Hogar Sostenible", title: 'El Poder de las Renovables', 
        description: 'Descubre las fuentes de energía limpia que están cambiando el mundo.', 
        isPro: false, icon: 'fa-solid fa-wind', status: 'start', 
        content: React.createElement(React.Fragment, null, 
            React.createElement('h3', null, 'Un Vistazo al Futuro Energético'),
            React.createElement('p', null, 'Las energías renovables provienen de fuentes naturales que se reponen constantemente, como el sol, el viento y el agua. Son la clave para un futuro sin emisiones de carbono.'),
            React.createElement('ul', null, 
                React.createElement('li', null, React.createElement('strong', null, 'Energía Solar:'), ' Capturada a través de paneles fotovoltaicos. Es abundante y cada vez más barata.'),
                React.createElement('li', null, React.createElement('strong', null, 'Energía Eólica:'), ' Generada por turbinas que aprovechan la fuerza del viento. Ideal para zonas con corrientes de aire constantes.'),
                React.createElement('li', null, React.createElement('strong', null, 'Energía Hidroeléctrica:'), ' Utiliza el flujo de los ríos para mover turbinas. Es una fuente de energía muy estable.'),
            ),
            React.createElement('p', null, 'Apoyar las energías renovables, ya sea instalando paneles en casa o eligiendo proveedores de energía verde, es una de las acciones más impactantes que podemos tomar por el planeta.')
        ) 
    },
    {
        id: 'l9', category: "Hogar Sostenible", title: 'El Desafío de la Ducha Rápida', 
        description: 'Aprende por qué cada segundo en la ducha cuenta y cómo puedes ahorrar miles de litros al año.', 
        isPro: false, icon: 'fa-solid fa-shower', status: 'start', 
        content: React.createElement(React.Fragment, null, 
            React.createElement('h3', null, 'Menos Tiempo, Más Agua'),
            React.createElement('p', null, 'Una ducha promedio consume entre 15 y 20 litros de agua por minuto. Reducir tu ducha de 10 a 5 minutos puede ahorrar hasta 100 litros de agua cada vez. ¡Eso es más de 36,000 litros al año!'),
            React.createElement('ul', null, 
                React.createElement('li', null, React.createElement('strong', null, 'Pon un temporizador:'), ' Usa tu móvil o un reloj de arena para controlar el tiempo.'),
                React.createElement('li', null, React.createElement('strong', null, 'Crea una playlist:'), ' Elige una canción de 5 minutos y termina cuando acabe la música.'),
                React.createElement('li', null, React.createElement('strong', null, 'Cierra la llave:'), ' Mientras te enjabonas o aplicas champú, cierra la llave del agua.'),
            ),
        )
    },
    {
        id: 'l10', category: "Consumo Responsable", title: 'Economía Circular: Más Allá de Reciclar (Pro)', 
        description: 'Descubre el modelo que busca eliminar los residuos desde el diseño.', 
        isPro: true, icon: 'fa-solid fa-arrows-rotate', status: 'locked', 
        content: React.createElement(React.Fragment, null, 
            React.createElement('h3', null, 'Cerrando el Círculo'),
            React.createElement('p', null, 'La economía circular es un sistema donde los materiales no se desechan, sino que se reutilizan, reparan, y reciclan para reintroducirlos en el ciclo de producción. A diferencia del modelo lineal de "tomar, hacer, desechar", busca un flujo constante de recursos.'),
            React.createElement('strong', null, 'Principios clave:'),
            React.createElement('ol', null, 
                React.createElement('li', null, 'Diseñar sin residuos y sin contaminación.'),
                React.createElement('li', null, 'Mantener productos y materiales en uso.'),
                React.createElement('li', null, 'Regenerar los sistemas naturales.'),
            )
        )
    },
    {
        id: 'l11', category: "Consumo Responsable", title: 'El Arte del Upcycling (Pro)', 
        description: 'Transforma objetos "inútiles" en creaciones de mayor valor.', 
        isPro: true, icon: 'fa-solid fa-wand-magic-sparkles', status: 'locked', 
        content: React.createElement(React.Fragment, null, 
            React.createElement('h3', null, 'De Basura a Tesoro'),
            React.createElement('p', null, 'El upcycling, o supra-reciclaje, es el proceso de transformar creativamente subproductos, residuos, o artículos no deseados en nuevos materiales o productos de mayor calidad y valor ecológico.'),
            React.createElement('p', null, 'Piensa en:'),
            React.createElement('ul', null, 
                React.createElement('li', null, 'Convertir llantas viejas en macetas o columpios.'),
                React.createElement('li', null, 'Crear bolsos o carteras a partir de banners publicitarios de lona.'),
                React.createElement('li', null, 'Hacer joyas con piezas de viejos aparatos electrónicos.'),
            ),
            React.createElement('p', null, '¡El único límite es tu imaginación!')
        )
    },
];
const learningPaths = [
    {
        id: 'lp1',
        title: 'Guardián del Plástico',
        description: 'Conviértete en un experto en el reciclaje de plásticos y reduce su impacto en el planeta.',
        icon: 'fa-solid fa-shield-halved',
        rewardPoints: 150,
        isCompleted: true,
        achievementId: 'ach-lp1',
        steps: [
            { id: 'lps1', type: 'lesson', itemId: 'l1', title: 'Aprende lo Básico', description: 'Completa la lección "Reciclaje Básico 101".', status: 'completed', points: 25 },
            { id: 'lps2', type: 'game', itemId: 'g3', title: 'Ponlo a Prueba', description: 'Juega a "Clasifica la Basura" para practicar.', status: 'completed', points: 20 },
            { id: 'lps3', type: 'mission', itemId: 'm5_new', title: 'Actúa', description: 'Completa la misión "Escanea un producto 3 veces".', status: 'completed', points: 25 },
            { id: 'lps4', type: 'lesson', itemId: 'l6', title: 'Profundiza tu Conocimiento', description: 'Completa la lección "El Ciclo de Vida del Plástico".', status: 'completed', points: 30 },
        ]
    },
    {
        id: 'lp2',
        title: 'Maestro del Compostaje',
        description: 'Domina el arte de convertir tus residuos orgánicos en abono para dar vida a tus plantas.',
        icon: 'fa-solid fa-leaf',
        rewardPoints: 100,
        isCompleted: false,
        achievementId: 'ach-lp2',
        steps: [
            { id: 'lps5', type: 'lesson', itemId: 'l7', title: 'Introducción al Compost', description: 'Completa la lección "Compostaje Casero".', status: 'available', points: 25 },
            { id: 'lps6', type: 'mission', itemId: 'm8_new', title: '¡A compostar!', description: 'Registra tus primeros 5 restos orgánicos.', status: 'locked', points: 50 },
            { id: 'lps7', type: 'game', itemId: 'g1', title: 'Demuestra lo que Sabes', description: 'Juega una partida de "Quiz Ecológico".', status: 'locked', points: 20 },
        ]
    },
    {
        id: 'lp3',
        title: 'Campeón de la Energía',
        description: 'Aprende a reducir tu consumo energético en casa y conviértete en un héroe del ahorro.',
        icon: 'fa-solid fa-bolt',
        rewardPoints: 120,
        isCompleted: false,
        achievementId: 'ach-lp3',
        steps: [
            { id: 'lps8', type: 'lesson', itemId: 'l3', title: 'Bases del Ahorro', description: 'Completa la lección "Ahorro Energético en el Hogar".', status: 'available', points: 30 },
            { id: 'lps9', type: 'game', itemId: 'g4', title: 'Reflejos Rápidos', description: 'Demuestra tu velocidad para ahorrar energía en el juego "Apaga la Luz".', status: 'locked', points: 25 },
            { id: 'lps10', type: 'mission', itemId: 'm9_new', title: 'Cazador de Vampiros', description: 'Acaba con el consumo fantasma desconectando 5 aparatos.', status: 'locked', points: 35 },
            { id: 'lps11', type: 'lesson', itemId: 'l8', title: 'Mira hacia el Futuro', description: 'Aprende sobre las energías del futuro.', status: 'locked', points: 30 },
        ]
    },
    {
        id: 'lp4',
        title: 'Consumidor Consciente',
        description: 'Aprende a tomar decisiones de compra que beneficien al planeta y a tu bolsillo.',
        icon: 'fa-solid fa-cart-shopping',
        rewardPoints: 150,
        isCompleted: false,
        achievementId: 'ach-lp4',
        steps: [
            { id: 'lps12', type: 'lesson', itemId: 'l4', title: 'Cada Gota Cuenta', description: 'Completa la lección "Consumo de Agua Responsable".', status: 'available', points: 25 },
            { id: 'lps13', type: 'mission', itemId: 'm10_new', title: 'Adiós al Plástico', description: 'Realiza una compra utilizando tu propia bolsa reutilizable.', status: 'locked', points: 30 },
            { id: 'lps14', type: 'lesson', itemId: 'l5', title: 'Viaja Verde', description: 'Completa la lección "Movilidad Sostenible".', status: 'locked', points: 30 },
            { id: 'lps15', type: 'mission', itemId: 'm6_new', title: 'Cierra el Círculo', description: 'Canjea una recompensa para apoyar la economía circular.', status: 'locked', points: 40 },
        ]
    },
    {
        id: 'lp5',
        title: 'El Héroe del Agua',
        description: 'Aprende sobre la importancia del agua y cómo cada gota que ahorras contribuye al planeta.',
        icon: 'fa-solid fa-tint',
        rewardPoints: 120,
        isCompleted: false,
        achievementId: 'ach-lp5',
        steps: [
            { id: 'lps16', type: 'lesson', itemId: 'l4', title: 'Cada Gota Cuenta', description: 'Completa la lección "Consumo de Agua Responsable".', status: 'available', points: 25 },
            { id: 'lps17', type: 'mission', itemId: 'm14_new', title: 'Inspira a la Comunidad', description: 'Comparte un consejo sobre el ahorro de agua en la comunidad.', status: 'locked', points: 40 },
            { id: 'lps18', type: 'lesson', itemId: 'l9', title: 'Optimiza tu Ahorro', description: 'Aprende más trucos para ahorrar agua.', status: 'locked', points: 30 },
            { id: 'lps19', type: 'game', itemId: 'g2', title: 'Agiliza la Mente', description: 'Juega una partida de "Memorama del Reciclaje".', status: 'locked', points: 25 },
        ]
    },
    {
        id: 'lp6',
        title: 'Innovador Circular (Pro)',
        description: 'Adéntrate en los conceptos avanzados de la economía circular y el upcycling.',
        icon: 'fa-solid fa-infinity',
        rewardPoints: 250,
        isCompleted: false,
        achievementId: 'ach-lp6',
        steps: [
            { id: 'lps20', type: 'lesson', itemId: 'l10', title: 'Cerrando el Círculo', description: 'Completa la lección Pro "Economía Circular".', status: 'available', points: 40 },
            { id: 'lps21', type: 'mission', itemId: 'm13_new', title: 'Manos a la Obra', description: 'Dale una segunda vida a un objeto.', status: 'locked', points: 50 },
            { id: 'lps22', type: 'lesson', itemId: 'l11', title: 'De Basura a Tesoro', description: 'Completa la lección Pro "El Arte del Upcycling".', status: 'locked', points: 40 },
            { id: 'lps23', type: 'game', itemId: 'g5', title: 'Vocabulario Pro', description: 'Juega el juego Pro "Palabras Eco".', status: 'locked', points: 50 },
        ]
    }
];
const yesterday = new Date();
yesterday.setDate(yesterday.getDate() - 1);
const yesterdayStr = yesterday.toISOString().split('T')[0];
const INITIAL_APP_STATE = {
    stats: { points: 13900, impact: 95, recycling: 18, rank: 8 },
    missions: [
        { id: 'm11_new', icon: 'fa-solid fa-calculator', description: 'Usa la Eco-Calculadora por primera vez', points: 50 },
        { id: 'm2', icon: 'fa-solid fa-lightbulb', description: 'Completa la lección "Ahorro Energético"', points: 30 },
        { id: 'm3', icon: 'fa-solid fa-share', description: 'Comparte un consejo en la comunidad', points: 20 },
        { id: 'm5_new', icon: 'fa-solid fa-qrcode', description: 'Escanea un producto 3 veces', points: 25, progress: { current: 1, total: 3 }},
        { id: 'm6_new', icon: 'fa-solid fa-gift', description: 'Canjea una recompensa en la tienda', points: 50 },
        { id: 'm7_new', icon: 'fa-solid fa-graduation-cap', description: 'Completa 2 lecciones educativas', points: 40, progress: { current: 0, total: 2 }},
        { id: 'm8_new', icon: 'fa-solid fa-seedling', description: 'Registra tus primeros 5 restos orgánicos', points: 50, progress: {current: 0, total: 5} },
        { id: 'm9_new', icon: 'fa-solid fa-plug-circle-xmark', description: 'Desconecta 5 aparatos en modo "standby"', points: 35, progress: { current: 0, total: 5 }},
        { id: 'm10_new', icon: 'fa-solid fa-bag-shopping', description: 'Usa una bolsa reutilizable en tus compras', points: 30, progress: { current: 0, total: 1 }},
        { id: 'm14_new', icon: 'fa-solid fa-comments', description: 'Inspira a otros con un consejo sobre el agua', points: 40 },
        { id: 'm13_new', icon: 'fa-solid fa-wand-magic-sparkles', description: 'Crea un objeto mediante upcycling', points: 60 },
    ],
    history: [
        { id: 'h1', icon: 'fa-solid fa-recycle', description: 'Botella de vidrio escaneada', timestamp: 'Hoy, 10:45 AM', points: 15 },
        { id: 'h2', icon: 'fa-solid fa-bag-shopping', description: 'Bolsa reutilizable canjeada', timestamp: 'Ayer, 4:30 PM', points: -1500 },
        { id: 'h3', icon: 'fa-solid fa-book-open', description: 'Lección "Reciclaje Básico 101" completada', timestamp: 'Ayer, 11:00 AM', points: 25 },
        { id: 'h4', icon: 'fa-solid fa-gamepad', description: 'Recompensa del juego "Quiz Ecológico"', timestamp: 'Hace 2 días', points: 45 },
        { id: 'h5', icon: 'fa-solid fa-beer-mug-empty', description: 'Lata de aluminio escaneada', timestamp: 'Hace 2 días', points: 12 },
        { id: 'h6', icon: 'fa-solid fa-trophy', description: 'Bono por suscripción Pro', timestamp: 'Hace 3 días', points: 500 },
    ],
    energy: 5,
    lastEnergyRecharge: Date.now(),
    games: [
        { id: 'g1', title: 'Quiz Ecológico', description: 'Pon a prueba tus conocimientos sobre reciclaje y sostenibilidad.', isDailyChallenge: true, highScore: 0, points: 20, isPro: false, icon: 'fa-solid fa-circle-question' },
        { id: 'g2', title: 'Memorama del Reciclaje', description: 'Encuentra las parejas de materiales y sus contenedores correspondientes.', highScore: 0, points: 25, isPro: false, icon: 'fa-solid fa-brain' },
        { id: 'g3', title: 'Clasifica la Basura', description: 'Arrastra el residuo al contenedor correcto antes de que se acabe el tiempo.', highScore: 0, points: 20, isPro: false, icon: 'fa-solid fa-trash-can' },
        { id: 'g4', title: 'Apaga la Luz', description: '¡Rápido! Apaga las luces encendidas para ahorrar energía y sumar puntos.', highScore: 0, points: 15, isPro: false, icon: 'fa-solid fa-power-off' },
        { id: 'g5', title: 'Palabras Eco', description: 'Ordena las letras para encontrar la palabra ecológica oculta. ¡Solo para expertos!', highScore: 0, points: 30, isPro: true, icon: 'fa-solid fa-spell-check' },
        { id: 'g6', title: 'Recycle Rush', description: '¡Rápido! Atrapa los objetos reciclables que caen del cielo, pero ten cuidado con los residuos.', highScore: 0, points: 20, isPro: false, icon: 'fa-solid fa-parachute-box' }
    ],
    learningPaths,
    streak: { current: 5, longest: 12, lastLoginDate: yesterdayStr },
    unlockedAvatars: ['avatar-default', 'avatar-leaf', 'avatar-water'],
    unlockedAvatarFrames: ['frame-none', 'frame-circle', 'frame-wood'],
    unlockedProfileTitles: ['title-novice', 'title-friend'],
    achievements: allAchievements.map(a => ({ ...a })),
};
const products = [
    { id: 'p1', name: 'Botella de vidrio', category: 'Vidrio', points: 15, icon: 'fa-solid fa-wine-glass' },
    { id: 'p2', name: 'Caja de cereales', category: 'Papel/Cartón', points: 6, icon: 'fa-solid fa-box' },
    { id: 'p3', name: 'Caja de cartón', category: 'Papel/Cartón', points: 8, icon: 'fa-solid fa-box-archive' },
    { id: 'p4', name: 'Periódico', category: 'Papel', points: 5, icon: 'fa-solid fa-newspaper' },
    { id: 'p5', name: 'Lata de aluminio', category: 'Metal', points: 12, icon: 'fa-solid fa-beer-mug-empty' },
    { id: 'p6', name: 'Batería AA', category: 'Peligrosos', points: 20, icon: 'fa-solid fa-battery-full' },
    { id: 'p7', name: 'Teléfono móvil', category: 'Electrónico', points: 18, icon: 'fa-solid fa-mobile-screen-button' },
    { id: 'p8', name: 'Portátil', category: 'Electrónico', points: 30, icon: 'fa-solid fa-laptop' },
    { id: 'p9', name: 'Frasco de mermelada', category: 'Vidrio', points: 12, icon: 'fa-solid fa-wine-glass' },
    { id: 'p10', name: 'Lata de aerosol', category: 'Metal', points: 14, icon: 'fa-solid fa-spray-can' },
    { id: 'p11', name: 'Revistas', category: 'Papel', points: 6, icon: 'fa-solid fa-book-open' },
    { id: 'p12', name: 'Latas de conserva', category: 'Metal', points: 10, icon: 'fa-solid fa-box-open' },
    { id: 'p13', name: 'Cargador de móvil', category: 'Electrónico', points: 15, icon: 'fa-solid fa-mobile-screen-button' },
    { id: 'p14', name: 'Ropa de algodón', category: 'Textil', points: 18, icon: 'fa-solid fa-shirt' },
    { id: 'p15', name: 'Aceite de cocina usado', category: 'Peligrosos', points: 25, icon: 'fa-solid fa-droplet' },
    { id: 'p16', name: 'Caja de leche (Tetra Pak)', category: 'Mixto', points: 9, icon: 'fa-solid fa-box-archive' },
    { id: 'p17', name: 'Bombilla de bajo consumo', category: 'Peligrosos', points: 22, icon: 'fa-solid fa-lightbulb' },
    { id: 'p18', name: 'Libros viejos', category: 'Papel', points: 7, icon: 'fa-solid fa-book' },
    { id: 'p19', name: 'Teclado de ordenador', category: 'Electrónico', points: 16, icon: 'fa-solid fa-keyboard' },
    { id: 'p20', name: 'Neumático', category: 'Especial', points: 40, icon: 'fa-solid fa-car-burst' },
    { id: 'p21', name: 'Mueble de madera', category: 'Especial', points: 50, icon: 'fa-solid fa-chair' },
    { id: 'p22', name: 'Cápsula de café', category: 'Mixto', points: 5, icon: 'fa-solid fa-capsules' },
    { id: 'p23', name: 'Rollo de papel de cocina', category: 'Papel/Cartón', points: 4, icon: 'fa-solid fa-scroll' },
    { id: 'p24', name: 'Papel de aluminio', category: 'Metal', points: 9, icon: 'fa-solid fa-infinity' },
    { id: 'p25', name: 'Papel de oficina', category: 'Papel', points: 4, icon: 'fa-solid fa-file-lines' },
    { id: 'p26', name: 'Pila de botón', category: 'Peligrosos', points: 25, icon: 'fa-solid fa-circle-dot' },
    { id: 'p27', name: 'Ropa de poliéster', category: 'Textil', points: 15, icon: 'fa-solid fa-shirt' },
    { id: 'p28', name: 'Espejo roto', category: 'Especial', points: 30, icon: 'fa-solid fa-square' },
    { id: 'p29', name: 'Vaso de vidrio roto', category: 'Vidrio', points: 10, icon: 'fa-solid fa-martini-glass-empty' },
    { id: 'p30', name: 'Corcho', category: 'Especial', points: 6, icon: 'fa-solid fa-wine-bottle' },
    { id: 'p31', name: 'Tapa de metal', category: 'Metal', points: 5, icon: 'fa-solid fa-circle' },
    { id: 'p32', name: 'Restos de poda', category: 'Orgánico', points: 8, icon: 'fa-solid fa-leaf' },
];
const rewards = [
    { id: 'r1', name: 'EcoBox Básica', description: 'Kit de inicio ecológico con bolsa reutilizable, botella de agua y cubiertos de bambú.', points: 1500, icon: 'fa-solid fa-box-archive' },
    { id: 'r2', name: 'Bolsa Reutilizable', description: 'Bolsa de tela resistente para tus compras, disponible en varios diseños.', points: 2500, icon: 'fa-solid fa-bag-shopping' },
    { id: 'r3', name: 'Botella de Acero', description: 'Botella térmica de acero inoxidable para mantener tus bebidas frías o calientes.', points: 3000, icon: 'fa-solid fa-wine-bottle' },
    { id: 'r4', name: 'Planta un Árbol', description: 'Donación para plantar un árbol en tu nombre en una zona deforestada.', points: 3500, icon: 'fa-solid fa-tree' },
    { id: 'r5', name: 'Descuento 20% Tienda Eco', description: 'Cupón de descuento para tiendas asociadas de productos sostenibles.', points: 2000, icon: 'fa-solid fa-percent' },
    { id: 'r6', name: 'Kit de Café Sostenible', description: 'Taza reutilizable, café orgánico y filtro de tela para prepararlo.', points: 4000, icon: 'fa-solid fa-mug-hot' },
    { id: 'r7', name: 'Cuponera de Ocio y Comida', description: 'Disfruta de descuentos exclusivos en cines y restaurantes de comida rápida.', points: 2800, icon: 'fa-solid fa-ticket' },
    { id: 'r8', name: 'Kit de Limpieza Ecológico', description: 'Set de cepillos de bambú y paños de microfibra para una limpieza sin residuos.', points: 2200, icon: 'fa-solid fa-bucket' },
    { id: 'r9', name: 'Semillas para Huerto Urbano', description: 'Empieza tu propio huerto en casa con este pack de semillas de hierbas aromáticas y hortalizas.', points: 1200, icon: 'fa-solid fa-seedling' },
    { id: 'r10', name: 'Suscripción a Revista Ecológica', description: 'Acceso digital por 3 meses a una revista sobre sostenibilidad y vida verde.', points: 1800, icon: 'fa-solid fa-book-journal-whills' },
    { id: 'r11', name: 'Kit de Afeitado Sostenible', description: 'Rastrillo de metal reutilizable y jabón de afeitar sólido para reducir plásticos.', points: 3200, icon: 'fa-solid fa-gem' },
    { id: 'r12', name: 'Donación a Limpieza de Playas', description: 'Contribuye a una ONG que organiza jornadas de limpieza en costas locales.', points: 1000, icon: 'fa-solid fa-water' },
];
const lessons = [
    { id: 'l1', category: "Fundamentos del Reciclaje", title: 'Reciclaje Básico 101', description: 'Aprende los fundamentos del reciclaje y cómo clasificar correctamente tus residuos.', isPro: false, icon: 'fa-solid fa-recycle', status: 'completed', content: React.createElement(React.Fragment, null, 
        React.createElement('h3', null, 'Entendiendo los Contenedores'),
        React.createElement('p', null, 'Clasificar tus residuos es el primer paso para un reciclaje efectivo. Cada color de contenedor tiene un propósito específico:'),
        React.createElement('ul', null, 
            React.createElement('li', null, React.createElement('strong', null, 'Azul (Papel y Cartón):'), ' Cajas, periódicos, revistas, folios. Asegúrate de que estén limpios y secos. Pliega las cajas para ahorrar espacio.'),
            React.createElement('li', null, React.createElement('strong', null, 'Amarillo (Plásticos y Envases):'), ' Botellas de plástico, latas de refresco, envases de yogurt, Tetra Paks, bolsas de plástico. Enjuaga los envases para evitar malos olores.'),
            React.createElement('li', null, React.createElement('strong', null, 'Verde (Vidrio):'), ' Botellas de vino, frascos de conservas, tarros de perfume. ¡No incluyas tapas, corchos, bombillas o espejos!'),
            React.createElement('li', null, React.createElement('strong', null, 'Marrón (Orgánico):'), ' Restos de comida (fruta, verdura, carne, pescado), posos de café, servilletas de papel usadas. Ideal para compostaje.'),
            React.createElement('li', null, React.createElement('strong', null, 'Gris (Resto):'), ' Materiales no reciclables como pañales, cerámica, colillas, polvo, etc.')
        )
    ),
    interactiveQuiz: [
        {
            question: '¿En qué contenedor desechas una botella de vino?',
            options: ['Amarillo (Plásticos)', 'Azul (Papel)', 'Verde (Vidrio)', 'Gris (Resto)'],
            correctAnswerIndex: 2,
            explanation: 'Correcto. Las botellas de vidrio, como las de vino, siempre van en el contenedor verde.'
        },
        {
            question: '¿Qué residuo NO pertenece al contenedor azul?',
            options: ['Un periódico viejo', 'Una caja de cartón plegada', 'Servilletas de papel usadas', 'Una revista'],
            correctAnswerIndex: 2,
            explanation: 'Las servilletas de papel usadas con restos de comida se consideran residuo orgánico (contenedor marrón) o resto (gris), ya que pueden contaminar el reciclaje del papel limpio.'
        }
    ] 
    },
    { id: 'l2', category: "Fundamentos del Reciclaje", title: 'Residuos Electrónicos (E-Waste)', description: 'Descubre cómo manejar adecuadamente los dispositivos electrónicos que ya no uses.', isPro: false, icon: 'fa-solid fa-laptop', status: 'start', content: React.createElement(React.Fragment, null,
        React.createElement('h3', null, 'El Peligro de la Basura Electrónica'),
        React.createElement('p', null, 'Los aparatos electrónicos contienen metales pesados y sustancias tóxicas como plomo, mercurio y cadmio. Si se desechan incorrectamente en la basura común, pueden filtrarse y contaminar gravemente el suelo y las fuentes de agua.'),
        React.createElement('h4', null, '¿Qué hacer con tu E-Waste?'),
        React.createElement('ol', null,
            React.createElement('li', null, React.createElement('strong', null, 'Reparar:'), ' Antes de desechar, siempre considera si el dispositivo puede ser reparado.'),
            React.createElement('li', null, React.createElement('strong', null, 'Donar o Vender:'), ' Si aún funciona pero ya no lo necesitas, dónalo o véndelo.'),
            React.createElement('li', null, React.createElement('strong', null, 'Punto Limpio:'), ' Lleva tus aparatos rotos a un "Punto Limpio" o centro de acopio especializado.')
        )
    ) },
    { id: 'l7', category: "Fundamentos del Reciclaje", title: 'Compostaje Casero', description: 'Transforma tus residuos orgánicos en abono rico en nutrientes para tus plantas.', isPro: false, icon: 'fa-solid fa-leaf', status: 'start', content: React.createElement(React.Fragment, null,
        React.createElement('h3', null, '¡Crea Tu Propio Oro Negro!'),
        React.createElement('p', null, 'El compostaje es un proceso natural que convierte tus restos de cocina y jardín en un fertilizante.'),
        React.createElement('h4', null, '¿Qué puedes compostar?'),
        React.createElement('ul', null,
            React.createElement('li', null, React.createElement('strong', null, 'Verdes (Ricos en Nitrógeno):'), ' Restos de frutas y verduras, posos de café, cáscaras de huevo.'),
            React.createElement('li', null, React.createElement('strong', null, 'Marrones (Ricos en Carbono):'), ' Hojas secas, ramas pequeñas, serrín, cartón.')
        )
    ) },
    { id: 'l3', category: "Hogar Sostenible", title: 'Ahorro Energético en el Hogar', description: 'Técnicas y consejos para reducir tu consumo de energía.', isPro: true, icon: 'fa-solid fa-lightbulb', status: 'locked', content: React.createElement(React.Fragment, null,
        React.createElement('h3', null, 'Tu Hogar, una Central de Ahorro'),
        React.createElement('ul', null,
            React.createElement('li', null, React.createElement('strong', null, 'Iluminación LED:'), ' Consumen hasta un 85% menos de energía y duran mucho más.'),
            React.createElement('li', null, React.createElement('strong', null, 'Apaga el "Consumo Fantasma":'), ' Desenchufa aparatos en modo "standby".'),
            React.createElement('li', null, React.createElement('strong', null, 'Electrodomésticos Eficientes:'), " Busca la etiqueta de eficiencia energética clase 'A'.")
        )
    ) },
    { id: 'l4', category: "Hogar Sostenible", title: 'Consumo de Agua Responsable', description: 'Cómo reducir tu huella hídrica y usar el agua de manera más eficiente.', isPro: false, icon: 'fa-solid fa-droplet', status: 'start', content: React.createElement(React.Fragment, null,
        React.createElement('h3', null, 'Cada Gota Cuenta'),
        React.createElement('ul', null,
            React.createElement('li', null, React.createElement('strong', null, 'Duchas cortas:'), ' Intenta reducir tu tiempo en la ducha a 5 minutos.'),
            React.createElement('li', null, React.createElement('strong', null, 'Cierra el grifo:'), ' No dejes el agua corriendo mientras te cepillas los dientes o lavas los platos.'),
            React.createElement('li', null, React.createElement('strong', null, 'Repara fugas:'), ' Un grifo que gotea puede desperdiciar miles de litros al año.')
        )
    ) },
    { id: 'l5', category: "Consumo Responsable", title: 'Movilidad Sostenible', description: 'Alternativas ecológicas para tus desplazamientos diarios.', isPro: true, icon: 'fa-solid fa-bicycle', status: 'locked', content: React.createElement(React.Fragment, null,
        React.createElement('h3', null, 'Muévete de Forma Inteligente'),
        React.createElement('p', null, 'El transporte es uno de los mayores emisores de gases de efecto invernadero. Elegir cómo nos movemos tiene un impacto directo.'),
        React.createElement('ul', null,
            React.createElement('li', null, React.createElement('strong', null, 'Caminar y Bici:'), ' Las opciones más saludables, económicas y ecológicas.'),
            React.createElement('li', null, React.createElement('strong', null, 'Transporte Público:'), ' Reduce drásticamente el número de coches en la carretera.'),
            React.createElement('li', null, React.createElement('strong', null, 'Coche Compartido:'), ' Organízate con compañeros para compartir un solo vehículo.')
        )
    ) },
    ...newLessons,
];
const initialPosts = [
    {
        id: 'c1',
        author: { name: 'María José', avatarId: 'avatar-water' },
        timestamp: 'Hace 2 horas',
        content: 'Hoy completé el reto de reciclaje semanal y logré reducir mi basura no reciclable en un 40%. ¡El truco fue lavar los envases antes de tirarlos al contenedor para evitar contaminación!',
        likes: 24,
        isLiked: false,
        comments: [
            {
                id: 'c4',
                author: { name: 'Juan Pérez', avatarId: 'avatar-default' },
                timestamp: 'Hace 1 hora',
                content: '¡Gran consejo, María! Siempre se me olvida hacer eso, pero empezaré a aplicarlo.',
                likes: 5,
                isLiked: false,
                comments: []
            },
            {
                id: 'c5',
                author: { name: 'Ana García', avatarId: 'avatar-leaf' },
                timestamp: 'Hace 45 minutos',
                content: 'Totalmente de acuerdo. Además, ayuda a que no haya malos olores en el cubo de reciclaje.',
                likes: 11,
                isLiked: true,
                comments: []
            }
        ]
    },
    {
        id: 'c2',
        author: { name: 'Carlos Rodríguez', avatarId: 'avatar-recycle' },
        timestamp: 'Ayer',
        content: '¿Alguien sabe dónde puedo reciclar pilas en Lima? Tengo varias acumuladas y no quiero tirarlas a la basura normal. ¡Gracias por la ayuda!',
        likes: 12,
        isLiked: false,
        comments: [
            {
                id: 'c3',
                author: { name: 'EcoScore Oficial', avatarId: 'avatar-earth', isOfficial: true },
                timestamp: 'Ayer',
                content: 'Hola Carlos, puedes llevar tus pilas usadas a los puntos de reciclaje de la municipalidad de tu distrito. ¡Gracias por tu compromiso!',
                likes: 45,
                isLiked: false,
                comments: []
            }
        ]
    },
    {
        id: 'c7',
        author: { name: 'Sofía Luna', avatarId: 'avatar-tree' },
        timestamp: 'Hace 3 días',
        content: '¡Estoy muy feliz! Acabo de canjear mis primeros 1500 puntos por una EcoBox. ¡Qué emoción recibirla!',
        likes: 58,
        isLiked: false,
        comments: []
    }
];
const mockUsers = [
    { user: { name: 'Javier Torres', initials: 'JT', location: 'Arequipa, Perú', avatarId: 'avatar-earth', displayedBadges: ['a30', 'a29', 'a1'] }, points: 15820 },
    { user: { name: 'Sofia Vargas', initials: 'SV', location: 'Cusco, Perú', avatarId: 'avatar-atom', displayedBadges: ['a30', 'a29', 'a2'] }, points: 15650 },
    { user: { name: 'Mateo Castillo', initials: 'MC', location: 'Lima, Perú', avatarId: 'avatar-tree', displayedBadges: ['a30', 'a29', 'a3'] }, points: 15410 },
    { user: { name: 'Valentina Rojas', initials: 'VR', location: 'Trujillo, Perú', avatarId: 'avatar-water', displayedBadges: ['a30', 'a29', 'a4'] }, points: 15380 },
    { user: { name: 'Lucas Navarro', initials: 'LN', location: 'Lima, Perú', avatarId: 'avatar-leaf', displayedBadges: ['a30', 'a29', 'a5'] }, points: 15290 },
    { user: { name: 'Isabella Mendoza', initials: 'IM', location: 'Chiclayo, Perú', avatarId: 'avatar-recycle', displayedBadges: ['a30', 'a29', 'a6'] }, points: 14100 },
    { user: { name: 'Daniel Soto', initials: 'DS', location: 'Lima, Perú', avatarId: 'avatar-water', displayedBadges: ['a30', 'a29', 'a7'] }, points: 13950 },
    { user: { name: 'Camila Flores', initials: 'CF', location: 'Arequipa, Perú', avatarId: 'avatar-default', displayedBadges: ['a30', 'a29', 'a8'] }, points: 13870 },
    { user: { name: 'Alejandro Reyes', initials: 'AR', location: 'Lima, Perú', avatarId: 'avatar-leaf', displayedBadges: ['a30', 'a29', 'a9'] }, points: 13720 },
    { user: { name: 'Lucia Paredes', initials: 'LP', location: 'Cusco, Perú', avatarId: 'avatar-recycle', displayedBadges: ['a30', 'a29', 'a10'] }, points: 12610 },
    { user: { name: 'Miguel Angel', initials: 'MA', location: 'Lima, Perú', avatarId: 'avatar-water', displayedBadges: ['a21', 'a29', 'a1'] }, points: 11430 },
    { user: { name: 'Valeria Quispe', initials: 'VQ', location: 'Lima, Perú', avatarId: 'avatar-default', displayedBadges: ['a21', 'a29', 'a2'] }, points: 10980 },
    { user: { name: 'Emilio Gomez', initials: 'EG', location: 'Lima, Perú', avatarId: 'avatar-leaf', displayedBadges: ['a21', 'a20', 'a3'] }, points: 9800 },
    { user: { name: 'Renata Cruz', initials: 'RC', location: 'Arequipa, Perú', avatarId: 'avatar-recycle', displayedBadges: ['a21', 'a20', 'a4'] }, points: 9500 },
    { user: { name: 'Ricardo Diaz', initials: 'RD', location: 'Lima, Perú', avatarId: 'avatar-water', displayedBadges: ['a21', 'a20', 'a5'] }, points: 8800 },
];
// --- END OF FILE: mockData.ts ---

// --- START OF FILE: context.ts ---
const AppContext = createContext(null);
const useAppContext = () => {
    const context = useContext(AppContext);
    if (!context) {
        throw new Error('useAppContext must be used within a AppContext.Provider');
    }
    return context;
};
// --- END OF FILE: context.ts ---

// --- START OF FILE: hooks/usePersistentState.ts ---
const usePersistentState = (key, defaultValue) => {
    const [state, setState] = useState(() => {
        try {
            const storedValue = window.localStorage.getItem(key);
            if (storedValue) {
                const parsed = JSON.parse(storedValue);
                // Simple check to merge missing keys from default value for objects
                if (typeof defaultValue === 'object' && defaultValue !== null && !Array.isArray(defaultValue)) {
                    return { ...defaultValue, ...parsed };
                }
                return parsed;
            }
        } catch (error) {
            console.error(`Error reading localStorage key “${key}”:`, error);
        }
        return defaultValue;
    });

    useEffect(() => {
        try {
            window.localStorage.setItem(key, JSON.stringify(state));
        } catch (error) {
            console.error(`Error setting localStorage key “${key}”:`, error);
        }
    }, [key, state]);

    return [state, setState];
};
// --- END OF FILE: hooks/usePersistentState.ts ---

// --- START OF FILE: hooks/useGameLogic.ts ---
const useGameLogic = () => {
    const { activeGame, setActiveGame, updatePoints, setAppState, completeLearningStep, updateAchievementProgress } = useAppContext();

    const handleGameEnd = (score) => {
        if (!activeGame) return;

        const basePoints = activeGame.points;
        const pointsWithBonus = activeGame.isDailyChallenge ? basePoints * 2 : basePoints;
        const pointsAwarded = Math.min(pointsWithBonus, 30); // Capped at 30 points

        updatePoints(pointsAwarded, `Juego: ${activeGame.title}`);
        updateAchievementProgress('PLAY_GAME', { score });

        setAppState(prev => ({
            ...prev,
            games: prev.games.map(g =>
                g.id === activeGame.id && score > g.highScore ? { ...g, highScore: score } : g
            )
        }));

        if (activeGame.learningPathContext) {
            completeLearningStep(activeGame.learningPathContext.pathId, activeGame.learningPathContext.stepId);
        }

        setActiveGame(null);
    };
    
    return { handleGameEnd };
};
// --- END OF FILE: hooks/useGameLogic.ts ---

// --- START OF FILE: components/common/ProgressBar.tsx ---
const ProgressBar = ({ current, total, className = '' }) => {
    const percentage = Math.min((current / total) * 100, 100);
    return (
        React.createElement('div', { className: `w-full bg-black/10 dark:bg-black/20 rounded-full h-2.5 shadow-inner ${className}` },
            React.createElement('div', { 
                className: "bg-gradient-to-r from-primary-light to-primary h-2.5 rounded-full transition-all duration-500 ease-out", 
                style: { width: `${percentage}%` }
            })
        )
    );
};
// --- END OF FILE: components/common/ProgressBar.tsx ---

// --- START OF FILE: components/common/AvatarDisplay.tsx ---
const AvatarDisplay = ({ avatarId, frameId, sizeClass = 'w-24 h-24', iconSizeClass = 'text-4xl' }) => {
    const avatar = allAvatars.find(a => a.id === avatarId) || allAvatars[0];
    const frame = allAvatarFrames.find(f => f.id === frameId) || allAvatarFrames[0];

    return (
        React.createElement('div', {
            className: `${sizeClass} rounded-full flex items-center justify-center flex-shrink-0 relative bg-primary/10 ${frame.frameClass} transition-all duration-300`
        },
            React.createElement('i', { className: `${avatar.icon} ${iconSizeClass} text-primary drop-shadow-sm` })
        )
    );
};
// --- END OF FILE: components/common/AvatarDisplay.tsx ---

// --- START OF FILE: components/common/StatCard.tsx ---
const StatCard = ({ title, value, subtitle, badge, valueColor = 'text-primary', icon, progress }) => {
  return (
    React.createElement('div', { className: "relative glass-card p-6 rounded-2xl flex flex-col justify-between h-auto min-h-[14rem] transition-all duration-300 hover:shadow-xl dark:hover:shadow-primary-glow-sm hover:-translate-y-2 overflow-hidden" },
      React.createElement('div', { className: "absolute inset-0 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-primary/10 to-transparent opacity-40 dark:from-primary/20 dark:to-transparent z-0" }),
      
      React.createElement('div', { className: "relative z-10 flex-grow flex flex-col justify-between" },
        React.createElement('div', { className: "flex justify-between items-start" },
          React.createElement('p', { className: "text-text-subtle font-semibold" }, title),
          icon && React.createElement('i', { className: `${icon} text-3xl text-primary/70`, "aria-hidden": "true" })
        ),
        
        React.createElement('div', null,
          React.createElement('div', { className: `text-5xl font-extrabold my-1 ${valueColor}` }, value),
          React.createElement('p', { className: "text-text-subtle text-sm font-medium" }, subtitle),
          badge && (
            React.createElement('span', { className: "mt-2 inline-block bg-secondary/20 text-secondary text-xs font-bold px-3 py-1 rounded-full" },
              badge
            )
          )
        )
      ),

      progress && progress.total > progress.start && (
        React.createElement('div', { className: "w-full mt-4 self-stretch relative z-10" },
            React.createElement(ProgressBar, { current: progress.current - progress.start, total: progress.total - progress.start }),
            React.createElement('div', { className: "flex justify-between text-xs text-text-subtle mt-1.5 font-medium" },
                React.createElement('span', null, `Nvl. ${progress.nextLevelName ? LEVELS.findIndex(l => l.name === progress.nextLevelName) : ''}`),
                React.createElement('span', null, `${progress.current.toLocaleString()} / ${progress.total.toLocaleString()} pts`)
            )
        )
      )
    )
  );
};
// --- END OF FILE: components/common/StatCard.tsx ---

// --- START OF FILE: components/common/MissionItem.tsx ---
const MissionItem = React.memo(({ mission, index }) => {
    return (
    React.createElement('div', { className: "flex items-center py-4 px-5 my-2 glass-card rounded-xl hover:bg-hover/80 transition-colors animate-stagger-in", style: { animationDelay: `${index * 70}ms` } },
        React.createElement('div', { className: "bg-primary/20 p-3 rounded-full w-12 h-12 flex items-center justify-center shadow-inner" },
            React.createElement('i', { className: `${mission.icon} h-6 w-6 text-primary text-2xl`, "aria-hidden": "true" })
        ),
        React.createElement('div', { className: "ml-4 flex-grow" },
            React.createElement('p', { className: "text-text font-semibold" }, mission.description),
            mission.progress && React.createElement(ProgressBar, { current: mission.progress.current, total: mission.progress.total, className: "mt-2" })
        ),
        React.createElement('div', { className: "ml-6" },
            React.createElement('span', { className: "bg-primary/20 text-primary-dark dark:text-primary text-sm font-bold px-4 py-2 rounded-full whitespace-nowrap shadow-sm" },
                `+${mission.points} pts`
            )
        )
    )
    );
});
// --- END OF FILE: components/common/MissionItem.tsx ---

// --- START OF FILE: components/common/HistoryLogItem.tsx ---
const HistoryLogItem = React.memo(({ item, index }) => {
    return (
     React.createElement('div', { className: "flex items-center py-4 border-b border-border/50 last:border-b-0 animate-stagger-in", style: { animationDelay: `${index * 50}ms` } },
        React.createElement('div', { className: "bg-hover p-3 rounded-full w-10 h-10 flex items-center justify-center" },
            React.createElement('i', { className: `${item.icon} h-5 w-5 text-text-subtle`, "aria-hidden": "true" })
        ),
        React.createElement('div', { className: "ml-4 flex-grow" },
            React.createElement('p', { className: "text-text font-medium text-sm" }, item.description),
            React.createElement('p', { className: "text-xs text-text-subtle" }, item.timestamp)
        ),
        React.createElement('div', { className: "ml-4" },
            React.createElement('span', { className: `text-sm font-bold ${item.points > 0 ? 'text-primary' : 'text-red-500'}` },
                item.points > 0 ? `+${item.points}` : item.points,
                React.createElement('span', { className: "ml-1 opacity-80" }, "pts")
            )
        )
    )
    );
});
// --- END OF FILE: components/common/HistoryLogItem.tsx ---

// --- START OF FILE: components/common/StreakTracker.tsx ---
const StreakTracker = ({ currentStreak }) => {
    const days = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];

    return (
        React.createElement('div', { className: "glass-card p-6 rounded-2xl shadow-sm flex flex-col animate-fade-in-down" },
            React.createElement('div', { className: "flex items-center gap-3 mb-4" },
                React.createElement('i', { className: "fa-solid fa-fire-flame-curved h-6 w-6 text-orange-500" }),
                React.createElement('h2', { className: "text-xl font-bold text-text" }, "Racha de Días")
            ),
            React.createElement('div', { className: "text-center my-4" },
                React.createElement('div', { className: "inline-block relative animate-pulse-slow" },
                    React.createElement('i', { className: "fa-solid fa-fire text-8xl text-orange-400 drop-shadow-[0_5px_20px_rgba(251,146,60,0.5)]" }),
                    React.createElement('span', { 
                        className: "absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-4xl font-bold text-white", 
                        style: {textShadow: '0 0 8px rgba(0,0,0,0.6)'}
                    },
                        currentStreak
                    )
                ),
                React.createElement('p', { className: "text-lg font-bold text-text mt-2" }, "días seguidos")
            ),
            React.createElement('p', { className: "text-center text-sm text-text-subtle mb-4" }, "¡Sigue así para mantener la llama encendida y ganar bonificaciones!"),
            React.createElement('div', { className: "flex justify-center gap-2" },
                days.map((day, i) => {
                    const isActive = i < (currentStreak % 7) || (currentStreak >= 7 && i < 7);
                    return (
                        React.createElement('div', { key: i, className: "group relative" },
                            React.createElement('div', { className: `w-7 h-7 rounded-full flex items-center justify-center transition-all duration-500 ${isActive ? 'bg-orange-400' : 'bg-hover'}` },
                                isActive ? (
                                    React.createElement('i', { className: "fa-solid fa-check text-white text-xs" })
                                ) : (
                                    React.createElement('span', { className: "text-xs font-bold text-text-subtle" }, day)
                                )
                            ),
                            React.createElement('div', { className: "absolute bottom-full mb-1.5 left-1/2 -translate-x-1/2 w-max bg-card text-text-subtle text-xs rounded py-1 px-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none shadow-lg border border-border/50" },
                                isActive ? 'Día de racha completado' : 'Día de la semana pendiente'
                            )
                        )
                    );
                })
            )
        )
    );
};
// --- END OF FILE: components/common/StreakTracker.tsx ---

// --- START OF FILE: components/common/EmptyState.tsx ---
const EmptyState = ({ icon, title, description, children }) => {
    return (
        React.createElement('div', { className: "text-center py-12 px-6 bg-hover/50 rounded-2xl border border-border/50 animate-fade-in" },
            React.createElement('div', { className: "w-20 h-20 mx-auto mb-6 bg-card rounded-full flex items-center justify-center shadow-inner border-2 border-border/50" },
                React.createElement('i', { className: `${icon} text-4xl text-primary drop-shadow-lg` })
            ),
            React.createElement('h3', { className: "text-2xl font-bold text-text mb-2" }, title),
            React.createElement('p', { className: "text-text-subtle mb-6 max-w-md mx-auto" }, description),
            children && React.createElement('div', { className: "mt-4" }, children)
        )
    );
};
// --- END OF FILE: components/common/EmptyState.tsx ---

// --- START OF FILE: components/common/QuizComponent.tsx ---
const QuizComponent = ({ questions, onQuizComplete }) => {
    const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
    const [selectedAnswerIndex, setSelectedAnswerIndex] = useState(null);
    const [feedback, setFeedback] = useState(null);
    const [score, setScore] = useState(0);
    const [isFinished, setIsFinished] = useState(false);

    const question = questions[currentQuestionIndex];
    const PASSING_PERCENTAGE = 0.5;

    const handleAnswerSubmit = () => {
        if (selectedAnswerIndex === null) return;

        const isCorrect = selectedAnswerIndex === question.correctAnswerIndex;
        if (isCorrect) {
            setScore(prev => prev + 1);
        }
        setFeedback({ isCorrect, explanation: question.explanation });
    };

    const handleNextQuestion = () => {
        setFeedback(null);
        setSelectedAnswerIndex(null);
        if (currentQuestionIndex < questions.length - 1) {
            setCurrentQuestionIndex(prev => prev + 1);
        } else {
            setIsFinished(true);
            const finalScore = (score + (selectedAnswerIndex === question.correctAnswerIndex ? 1: 0)) / questions.length;
            if (finalScore >= PASSING_PERCENTAGE) {
                onQuizComplete(true);
            }
        }
    };
    
    if (isFinished) {
        const finalScore = score / questions.length;
        const passed = finalScore >= PASSING_PERCENTAGE;
        return (
            React.createElement('div', { className: `mt-8 p-6 rounded-lg text-center ${passed ? 'bg-primary/10' : 'bg-red-500/10'}` },
                React.createElement('h4', { className: `font-bold text-xl mb-2 ${passed ? 'text-primary' : 'text-red-500'}` },
                    passed ? '¡Prueba superada!' : 'Puedes mejorar'
                ),
                React.createElement('p', { className: "text-text-subtle mb-4" },
                    `Tu puntuación: ${score} de ${questions.length} (${Math.round(finalScore * 100)}%).`
                ),
                !passed && (
                     React.createElement('p', { className: "text-text-subtle text-sm" },
                        `Necesitas al menos un ${PASSING_PERCENTAGE * 100}% para completar la lección. ¡Repasa el contenido e inténtalo de nuevo!`
                    )
                )
            )
        );
    }

    return (
        React.createElement('div', { className: "mt-8 pt-6 border-t-2 border-dashed border-border" },
            React.createElement('h3', { className: "text-xl font-bold text-text mb-4" }, "Prueba Rápida"),
            React.createElement('div', { className: "glass-card p-6 rounded-xl" },
                React.createElement('p', { className: "font-semibold text-text mb-4" }, `${currentQuestionIndex + 1}. ${question.question}`),
                React.createElement('div', { className: "space-y-3" },
                    question.options.map((option, index) => {
                        let optionClass = 'border-border/80 hover:bg-hover';
                        if (feedback) {
                           if(index === question.correctAnswerIndex) {
                               optionClass = 'border-primary bg-primary/10 text-primary';
                           } else if (index === selectedAnswerIndex) {
                               optionClass = 'border-red-500 bg-red-500/10 text-red-500';
                           } else {
                               optionClass = 'border-border/50 opacity-60';
                           }
                        } else if (index === selectedAnswerIndex) {
                            optionClass = 'border-primary ring-2 ring-primary/50';
                        }
                        return (
                            React.createElement('button', {
                                key: index,
                                onClick: () => setSelectedAnswerIndex(index),
                                disabled: !!feedback,
                                className: `w-full text-left p-3 border-2 rounded-lg transition-all duration-200 ${optionClass}`
                            },
                                option
                            )
                        );
                    })
                ),
                !feedback && (
                    React.createElement('div', { className: "text-right mt-4" },
                        React.createElement('button', { onClick: handleAnswerSubmit, disabled: selectedAnswerIndex === null, className: "px-6 py-2 rounded-lg bg-secondary text-dark-text font-semibold hover:opacity-90 transition disabled:opacity-50" }, "Comprobar")
                    )
                ),
                feedback && (
                    React.createElement('div', { className: "mt-4 p-4 bg-hover rounded-lg animate-fade-in" },
                        React.createElement('p', { className: `font-bold ${feedback.isCorrect ? 'text-primary' : 'text-red-500'}` }, feedback.isCorrect ? '¡Correcto!' : '¡Incorrecto!'),
                        React.createElement('p', { className: "text-sm text-text-subtle mt-1" }, feedback.explanation),
                        React.createElement('div', { className: "text-right mt-2" },
                             React.createElement('button', { onClick: handleNextQuestion, className: "px-6 py-2 rounded-lg bg-primary text-dark-text font-semibold hover:bg-primary-dark transition" }, "Siguiente")
                        )
                    )
                )
            )
        )
    );
};
// --- END OF FILE: components/common/QuizComponent.tsx ---

// --- START OF FILE: components/common/RankRow.tsx ---
const RankRow = React.memo(({ entry, index }) => {
    const rankColor = entry.rank === 1 ? 'text-yellow-400' : entry.rank === 2 ? 'text-gray-300' : entry.rank === 3 ? 'text-amber-500' : 'text-text-subtle';
    
    const rankIcon = (rank) => {
        if (rank === 1) return React.createElement('i', { className: "fa-solid fa-trophy w-6 h-6 sm:w-7 sm:h-7 inline-block drop-shadow-[0_2px_4px_rgba(250,204,21,0.5)]" });
        if (rank === 2) return React.createElement('i', { className: "fa-solid fa-medal w-6 h-6 sm:w-7 sm:h-7 inline-block drop-shadow-[0_2px_4px_rgba(209,213,219,0.5)]" });
        if (rank === 3) return React.createElement('i', { className: "fa-solid fa-award w-6 h-6 sm:w-7 sm:h-7 inline-block drop-shadow-[0_2px_4px_rgba(217,119,6,0.5)]" });
        return null;
    }
    
    return (
        React.createElement('div', { className: `relative flex items-center p-3 sm:p-4 rounded-xl animate-stagger-in transition-all duration-200 hover:z-10 hover:shadow-lg hover:scale-[1.02] ${entry.isCurrentUser ? 'bg-primary/20 scale-[1.02] shadow-lg' : 'bg-card/50'}`, style: { animationDelay: `${index * 40}ms` } },
            React.createElement('div', { className: "w-10 sm:w-12 text-center text-base sm:text-lg font-bold text-text-subtle" }, entry.rank),
            React.createElement('div', { className: `w-10 sm:w-12 text-center text-xl sm:text-2xl font-bold ${rankColor}` },
                rankIcon(entry.rank)
            ),
            React.createElement('div', { className: "flex items-center flex-grow" },
                React.createElement(AvatarDisplay, { avatarId: entry.user.avatarId, frameId: "frame-none", sizeClass: "w-10 h-10 sm:w-12 sm:h-12", iconSizeClass: "text-xl sm:text-2xl" }),
                React.createElement('div', { className: "ml-3 sm:ml-4 overflow-hidden" },
                    React.createElement('p', { className: `font-bold text-sm sm:text-base truncate ${entry.isCurrentUser ? 'text-primary-dark dark:text-primary' : 'text-text'}` }, entry.user.name),
                    React.createElement('p', { className: "text-xs sm:text-sm text-text-subtle" }, entry.user.location),
                    entry.user.displayedBadges && entry.user.displayedBadges.length > 0 && (
                        React.createElement('div', { className: "flex items-center gap-1.5 mt-1.5" },
                            entry.user.displayedBadges.map(badgeId => {
                                const achievement = allAchievements.find(a => a.id === badgeId);
                                if (!achievement) return null;
                                return (
                                    React.createElement('div', { key: badgeId, className: "group relative" },
                                        React.createElement('i', { className: `${achievement.icon} text-base text-text-subtle/80` }),
                                        React.createElement('div', { className: "absolute bottom-full mb-1.5 left-1/2 -translate-x-1/2 w-max bg-card text-text-subtle text-xs rounded py-1 px-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-20 shadow-lg border border-border/50" },
                                            achievement.name
                                        )
                                    )
                                );
                            })
                        )
                    )
                )
            ),
            React.createElement('div', { className: "w-24 sm:w-32 text-right font-bold text-base sm:text-lg text-primary" }, entry.points.toLocaleString())
        )
    );
});
// --- END OF FILE: components/common/RankRow.tsx ---

// --- START OF FILE: components/common/RewardCard.tsx ---
const RewardCard = React.memo(({ reward, onRedeem, index, isLoading = false }) => {
    return (
    React.createElement('div', { className: "glass-card rounded-2xl overflow-hidden flex flex-col transition-all duration-300 hover:-translate-y-2 hover:shadow-2xl animate-stagger-in", style: { animationDelay: `${index * 80}ms` } },
        React.createElement('div', { className: "bg-white dark:bg-slate-900 flex items-center justify-center h-48" },
            React.createElement('i', { className: `${reward.icon} text-7xl text-slate-900 dark:text-dark-text drop-shadow-lg`, "aria-hidden": "true" })
        ),
        React.createElement('div', { className: "p-6 flex flex-col flex-grow" },
            React.createElement('h3', { className: "text-xl font-bold text-text" }, reward.name),
            React.createElement('p', { className: "text-sm text-text-subtle mt-1 mb-6 flex-grow" }, reward.description),
            React.createElement('div', { className: "flex items-center justify-between mt-auto" },
                React.createElement('span', { className: "font-bold text-primary text-lg" }, `${reward.points.toLocaleString()} pts`),
                React.createElement('button', { 
                    onClick: () => onRedeem(reward), 
                    disabled: isLoading,
                    className: "bg-secondary text-dark-text px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition-all w-32 text-center disabled:opacity-70 shadow-lg hover:shadow-secondary/40 transform hover:scale-105"
                },
                    isLoading ? React.createElement('i', { className: "fa-solid fa-spinner animate-spin" }) : 'Canjear'
                )
            )
        )
    )
    );
});
// --- END OF FILE: components/common/RewardCard.tsx ---

// --- START OF FILE: components/common/GameCard.tsx ---
const GameCard = React.memo(({ game, onGameClick, isProUser, index }) => {
    const isLocked = game.isPro && !isProUser;

    return (
        React.createElement('div', { className: "glass-card rounded-2xl overflow-hidden flex flex-col transition-all duration-300 hover:-translate-y-2 hover:shadow-2xl animate-stagger-in", style: { animationDelay: `${index * 80}ms` } },
            React.createElement('div', { className: `flex items-center justify-center h-48 relative ${isLocked ? 'bg-slate-200 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'}` },
                React.createElement('i', { className: `${game.icon} text-7xl ${isLocked ? 'text-slate-500' : 'text-slate-900 dark:text-dark-text'} drop-shadow-lg`, "aria-hidden": "true" }),
                game.isPro && React.createElement('div', { className: "absolute top-4 right-4 bg-yellow-400/20 text-yellow-300 text-xs font-bold px-3 py-1 rounded-full border border-yellow-400/50 backdrop-blur-sm" }, "PRO"),
                game.isDailyChallenge && React.createElement('div', { className: "absolute top-4 left-4 bg-secondary/30 text-secondary text-xs font-bold px-3 py-1 rounded-full border border-secondary/50 backdrop-blur-sm flex items-center gap-1.5" }, React.createElement('i', { className: "fa-solid fa-star" }), " Desafío")
            ),
            React.createElement('div', { className: "p-6 flex flex-col flex-grow" },
                React.createElement('h3', { className: "text-xl font-bold text-text" }, game.title),
                React.createElement('p', { className: "text-sm text-text-subtle mt-1 mb-4 flex-grow" }, game.description),
                React.createElement('div', { className: "flex items-center text-sm text-text-subtle mb-6 mt-auto" },
                    React.createElement('i', { className: "fa-solid fa-award w-4 h-4 text-secondary mr-2" }),
                    React.createElement('span', null, "Mejor: ", React.createElement('span', { className: "font-bold text-text" }, game.highScore)),
                    React.createElement('span', { className: "ml-auto font-bold text-primary text-base" }, `+${game.isDailyChallenge ? game.points*2 : game.points} pts`)
                ),
                React.createElement('button', { 
                    onClick: onGameClick, 
                    className: `w-full py-3 rounded-lg font-semibold text-dark-text transition-all duration-200 transform hover:scale-105 shadow-lg ${isLocked ? 'bg-warning hover:bg-amber-500/90 hover:shadow-amber-500/40' : 'bg-primary hover:bg-primary-dark hover:shadow-primary-glow-md'}`
                },
                    isLocked ? 'Adquirir Modo Pro' : 'Jugar'
                )
            )
        )
    );
});
// --- END OF FILE: components/common/GameCard.tsx ---

// --- START OF FILE: components/common/AchievementCard.tsx ---
const AchievementCard = React.memo(({ ach, index, isSelected, onSelect }) => {
    
    const cardContent = (
        React.createElement(React.Fragment, null,
            isSelected && (
                React.createElement('div', { className: "absolute top-2 right-2 bg-secondary text-white rounded-full w-6 h-6 flex items-center justify-center z-10 shadow-lg" },
                    React.createElement('i', { className: "fa-solid fa-check text-xs" })
                )
            ),
            React.createElement('div', { className: `w-20 h-20 rounded-full flex items-center justify-center mb-4 transition-all duration-300 ${ach.isUnlocked ? 'bg-primary/10' : 'bg-hover'}` },
                React.createElement('i', { className: `${ach.icon} text-4xl ${ach.isUnlocked ? 'text-primary' : 'text-text-subtle'}` })
            ),
            React.createElement('h4', { className: "font-bold text-text text-sm" }, ach.name),
            React.createElement('p', { className: "text-xs text-text-subtle flex-grow my-2" }, ach.description),
            ach.progress && !ach.isUnlocked && React.createElement(ProgressBar, { current: ach.progress.current, total: ach.progress.total, className: "my-2" }),
            React.createElement('p', { className: "text-xs font-semibold mt-auto" }, ach.isUnlocked ? ach.unlockDate : (ach.progress ? `${Math.round(ach.progress.current / ach.progress.total * 100)}%` : 'Bloqueado'))
        )
    );

    return (
        React.createElement('button', {
            onClick: () => ach.isUnlocked && onSelect(ach.id),
            disabled: !ach.isUnlocked,
            className: `relative glass-card rounded-xl p-4 flex flex-col items-center text-center transition-all duration-300 animate-stagger-in w-full h-full
                ${isSelected ? 'border-secondary ring-2 ring-secondary' : ach.isUnlocked ? 'border-primary/50' : 'border-border'}
                ${ach.isUnlocked ? 'cursor-pointer hover:-translate-y-2 hover:shadow-xl' : 'cursor-not-allowed opacity-70'}
            `,
            style: { animationDelay: `${index * 40}ms` },
            "aria-label": `Seleccionar logro: ${ach.name}`,
            "aria-pressed": isSelected
        },
            cardContent
        )
    );
});
// --- END OF FILE: components/common/AchievementCard.tsx ---

// --- START OF FILE: components/common/CustomizationItemCard.tsx ---
const CustomizationItemCard = ({ item, type, isOwned, isEquipped, onBuy, onEquip, userPoints, isProUser, index, isLoading = false }) => {
    const isLockedByPro = item.isPro && !isProUser;
    const canAfford = userPoints >= item.cost;
    const cantBuy = isLockedByPro || !canAfford;

    const renderPreview = () => {
        switch (type) {
            case 'avatar':
                return React.createElement(AvatarDisplay, { avatarId: item.id, frameId: 'frame-none', sizeClass: "w-24 h-24", iconSizeClass: "text-4xl" });
            case 'frame':
                const frameItem = item;
                return React.createElement('div', { className: `w-24 h-24 rounded-full bg-hover ${frameItem.frameClass}` });
            case 'title':
                return React.createElement('div', { className: "text-center p-4 h-24 flex flex-col justify-center" }, React.createElement('p', { className: "font-bold text-2xl text-secondary" }, "Aa"), React.createElement('p', { className: "text-sm text-text-subtle" }, "Título"));
        }
    };

    const handleButtonClick = () => {
        if (isOwned) {
            onEquip(item, type);
        } else {
            onBuy(item, type);
        }
    };
    
    return (
        React.createElement('div', { className: "glass-card rounded-xl p-4 flex flex-col items-center text-center transition-all duration-300 hover:-translate-y-2 hover:shadow-xl animate-stagger-in", style: { animationDelay: `${index * 40}ms` } },
            React.createElement('div', { className: "h-28 flex items-center justify-center" },
                renderPreview()
            ),
            React.createElement('h4', { className: "font-bold text-text mt-2 h-10 flex items-center justify-center text-sm" }, item.name),
            
            isOwned ? (
                 React.createElement('button', {
                    onClick: handleButtonClick,
                    disabled: isEquipped || isLoading,
                    className: `w-full mt-4 py-2 px-4 rounded-lg font-semibold transition-all duration-200 text-sm flex items-center justify-center h-10 transform
                        ${ isEquipped 
                            ? 'bg-primary/20 text-primary cursor-default' 
                            : 'text-primary border border-primary bg-transparent hover:bg-primary/10 hover:shadow-primary-glow-sm'
                        }`
                },
                    isLoading ? React.createElement('i', { className: "fa-solid fa-spinner animate-spin" }) : (isEquipped ? React.createElement(React.Fragment, null, React.createElement('i', { className: "fa-solid fa-check mr-2" }), "Equipado") : 'Equipar'))
            ) : (
                React.createElement('button', {
                    onClick: handleButtonClick,
                    disabled: cantBuy || isLoading,
                    className: "w-full mt-4 py-2 px-4 rounded-lg font-semibold transition-all duration-200 text-sm text-dark-text disabled:bg-gray-400 disabled:cursor-not-allowed bg-secondary hover:opacity-90 flex items-center justify-center h-10 shadow-lg hover:shadow-secondary/40 transform hover:scale-105"
                },
                    isLoading ? React.createElement('i', { className: "fa-solid fa-spinner animate-spin" }) : (isLockedByPro ? React.createElement(React.Fragment, null, React.createElement('i', { className: "fa-solid fa-lock mr-2" }), "Requiere Pro") : React.createElement(React.Fragment, null, React.createElement('i', { className: "fa-solid fa-coins mr-1" }), ` ${item.cost.toLocaleString()}`))
                )
            )
        )
    );
};
// --- END OF FILE: components/common/CustomizationItemCard.tsx ---

// --- START OF FILE: components/common/PostCard.tsx ---
const PostCard = ({ post, onLike, onCommentSubmit, onDelete, onEdit, isReply = false, index }) => {
    const { user } = useAppContext();
    const [isReplying, setIsReplying] = useState(false);
    const [commentContent, setCommentContent] = useState('');
    const [isMenuOpen, setMenuOpen] = useState(false);
    const [isEditing, setEditing] = useState(false);
    const [editedContent, setEditedContent] = useState(post.content);
    const menuRef = useRef(null);

    const isAuthor = post.author.name === user.name;

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (menuRef.current && !menuRef.current.contains(event.target)) {
                setMenuOpen(false);
            }
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);

    const handleCommentSubmitInternal = (e) => {
        e.preventDefault();
        if (commentContent.trim()) {
            onCommentSubmit(post.id, commentContent);
            setCommentContent('');
            setIsReplying(false);
        }
    };

    const handleEditSubmit = () => {
        if (editedContent.trim() && editedContent !== post.content) {
            onEdit(post.id, editedContent);
        }
        setEditing(false);
    };
    
    const handleStartEdit = () => {
        setEditedContent(post.content);
        setEditing(true);
        setMenuOpen(false);
    }
    
    const handleDelete = () => {
        if (window.confirm('¿Estás seguro de que quieres eliminar esta publicación? Esta acción no se puede deshacer.')) {
            onDelete(post.id);
        }
        setMenuOpen(false);
    };

    return (
        React.createElement('div', { className: `glass-card rounded-2xl p-5 sm:p-6 animate-stagger-in ${isReply ? 'ml-0 sm:ml-8' : ''}`, style: { animationDelay: `${index * 100}ms` } },
            React.createElement('div', { className: "flex items-start mb-4" },
                React.createElement(AvatarDisplay, { 
                    avatarId: post.author.avatarId, 
                    frameId: post.author.isOfficial ? 'frame-aura' : 'frame-none', 
                    sizeClass: "w-12 h-12", 
                    iconSizeClass: "text-2xl" 
                }),
                React.createElement('div', { className: "ml-4 flex-grow" },
                    React.createElement('div', { className: "flex items-center gap-2" },
                        React.createElement('p', { className: `font-bold text-text ${post.author.isOfficial ? 'text-primary' : ''}` }, post.author.name),
                        post.author.isOfficial && (
                            React.createElement('span', { className: "w-4 h-4 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0", title: "Cuenta Oficial" },
                                React.createElement('i', { className: "fa-solid fa-check text-white text-[9px]" })
                            )
                        )
                    ),
                    React.createElement('p', { className: "text-sm text-text-subtle" }, post.timestamp)
                ),
                isAuthor && !isEditing && (
                    React.createElement('div', { className: "relative", ref: menuRef },
                        React.createElement('button', { onClick: () => setMenuOpen(!isMenuOpen), className: "text-text-subtle hover:text-text p-2 rounded-full -mr-2" },
                            React.createElement('i', { className: "fa-solid fa-ellipsis-vertical" })
                        ),
                        isMenuOpen && (
                            React.createElement('div', { className: "absolute right-0 mt-2 w-40 glass-card rounded-lg shadow-xl z-20 py-2 border border-border/50 animate-fade-in-down" },
                                React.createElement('button', { onClick: handleStartEdit, className: "w-full text-left flex items-center gap-3 px-4 py-2 text-sm text-text hover:bg-hover" }, React.createElement('i', { className: "fa-solid fa-pen-to-square w-5 h-5" }), " Editar"),
                                React.createElement('button', { onClick: handleDelete, className: "w-full text-left flex items-center gap-3 px-4 py-2 text-sm text-red-500 hover:bg-hover" }, React.createElement('i', { className: "fa-solid fa-trash-can w-5 h-5" }), " Eliminar")
                            )
                        )
                    )
                )
            ),
            
            isEditing ? (
                React.createElement('div', { className: "animate-fade-in" },
                    React.createElement('textarea', {
                        value: editedContent,
                        onChange: (e) => setEditedContent(e.target.value),
                        className: "w-full h-24 p-3 bg-hover rounded-lg border-2 border-transparent focus:ring-2 focus:ring-primary focus:border-primary",
                        autoFocus: true
                    }),
                    React.createElement('div', { className: "flex justify-end gap-2 mt-2" },
                        React.createElement('button', { onClick: () => setEditing(false), className: "px-4 py-2 rounded-lg bg-hover text-text font-semibold hover:bg-border transition text-sm" }, "Cancelar"),
                        React.createElement('button', { onClick: handleEditSubmit, className: "px-4 py-2 rounded-lg bg-primary text-dark-text font-semibold hover:bg-primary-dark transition text-sm" }, "Guardar")
                    )
                )
            ) : (
                React.createElement('p', { className: "text-text mb-4 whitespace-pre-wrap" }, post.content)
            ),

            !isEditing && (
                React.createElement('div', { className: "flex items-center gap-6 text-sm text-text-subtle font-medium" },
                    React.createElement('button', {
                        onClick: () => onLike(post.id),
                        className: `flex items-center gap-2 hover:text-primary transition-colors duration-200 ${post.isLiked ? 'text-primary' : ''}`,
                        "aria-label": `Me gusta a la publicación de ${post.author.name}`
                    },
                        React.createElement('i', { className: `${post.isLiked ? 'fa-solid' : 'fa-regular'} fa-heart w-5 h-5` }), ` Me gusta (${post.likes})`
                    ),
                    React.createElement('button', {
                        onClick: () => setIsReplying(!isReplying),
                        className: "flex items-center gap-2 hover:text-primary transition-colors duration-200",
                        "aria-label": `Comentar en la publicación de ${post.author.name}`
                    },
                        React.createElement('i', { className: "fa-regular fa-comment-dots w-5 h-5" }), " Comentar"
                    )
                )
            ),

            isReplying && (
                React.createElement('form', { onSubmit: handleCommentSubmitInternal, className: "mt-4 flex items-start gap-3 animate-fade-in" },
                    React.createElement(AvatarDisplay, { avatarId: user.avatarId, frameId: user.avatarFrameId, sizeClass: "w-10 h-10", iconSizeClass: "text-xl" }),
                    React.createElement('div', { className: "flex-grow" },
                        React.createElement('textarea', {
                            value: commentContent,
                            onChange: (e) => setCommentContent(e.target.value),
                            placeholder: "Escribe un comentario...",
                            className: "w-full bg-hover border-2 border-transparent rounded-lg py-2 px-3 focus:ring-2 focus:ring-primary text-sm focus:border-primary",
                            rows: 2,
                            autoFocus: true
                        }),
                         React.createElement('div', { className: "text-right mt-2" },
                            React.createElement('button', { type: "submit", className: "px-4 py-2 rounded-lg bg-primary text-dark-text text-sm font-semibold hover:bg-primary-dark transition flex items-center gap-2" },
                                React.createElement('i', { className: "fa-solid fa-paper-plane" }),
                                "Publicar"
                            )
                        )
                    )
                )
            ),

            post.comments && post.comments.length > 0 && (
                React.createElement('div', { className: "mt-4 pt-4 space-y-4 border-t border-border/50" },
                    post.comments.map((comment, i) => (
                        React.createElement(PostCard, { key: comment.id, post: comment, onLike: onLike, onCommentSubmit: onCommentSubmit, onDelete: onDelete, onEdit: onEdit, isReply: true, index: i })
                    ))
                )
            )
        )
    );
};
// --- END OF FILE: components/common/PostCard.tsx ---

// --- START OF FILE: components/games/EcoQuizGame.tsx ---
const EcoQuizGame = ({ onGameEnd }) => {
    const QUESTIONS = [
        { question: "¿Qué color de contenedor se usa para el vidrio?", options: ["Amarillo", "Azul", "Verde", "Gris"], answer: "Verde" },
        { question: "¿Cuál de estos no es un gas de efecto invernadero?", options: ["Dióxido de Carbono", "Metano", "Oxígeno", "Óxido Nitroso"], answer: "Oxígeno" },
        { question: "La 'economía circular' se opone a la economía...", options: ["Capitalista", "Lineal", "Socialista", "Global"], answer: "Lineal" },
        { question: "¿Qué significa 'compostar'?", options: ["Quemar basura", "Enterrar residuos", "Descomponer materia orgánica", "Separar plásticos"], answer: "Descomponer materia orgánica" },
        { question: "¿Cuál de estos es un plástico de un solo uso?", options: ["Botella reutilizable", "Taza de cerámica", "Pajita/Popote de plástico", "Bolsa de tela"], answer: "Pajita/Popote de plástico" }
    ];
    const questions = useRef(QUESTIONS.sort(() => 0.5 - Math.random())).current;

    const [currentQ, setCurrentQ] = useState(0);
    const [score, setScore] = useState(0);
    const [feedback, setFeedback] = useState(null);

    const handleAnswer = (option) => {
        if (feedback) return;

        const isCorrect = option === questions[currentQ].answer;
        
        if (isCorrect) {
            setScore(prev => prev + 10);
            setFeedback('correct');
        } else {
            setFeedback('incorrect');
        }

        setTimeout(() => {
            setFeedback(null);
            if (currentQ < questions.length - 1) {
                setCurrentQ(prev => prev + 1);
            } else {
                onGameEnd(score + (isCorrect ? 10 : 0));
            }
        }, 1200);
    };

    const q = questions[currentQ];
    
    return (
        React.createElement('div', { className: "w-full max-w-xl text-center" },
            React.createElement('p', { className: "font-semibold text-text-subtle mb-4" }, `Pregunta ${currentQ + 1} de ${questions.length}`),
            React.createElement('h3', { className: "text-3xl font-bold text-text mb-8" }, q.question),
            React.createElement('div', { className: "grid grid-cols-1 sm:grid-cols-2 gap-4" },
                q.options.map(opt => {
                    const getButtonClass = () => {
                        if (!feedback) return 'bg-card/80 backdrop-blur-sm border border-border/50 hover:border-primary/80 hover:bg-primary/10 text-text transform hover:scale-105';
                        if (opt === q.answer) return 'bg-primary text-dark-text scale-105 shadow-lg shadow-primary/40 ring-2 ring-white/50 border-primary';
                        if (feedback === 'incorrect' && opt !== q.answer) return 'bg-red-500/50 text-dark-text animate-shake border-red-500/80';
                        return 'bg-card/50 backdrop-blur-sm border border-border/30 opacity-60';
                    };
                    return React.createElement('button', { key: opt, onClick: () => handleAnswer(opt), className: `p-4 rounded-lg font-semibold transition-all duration-300 border-2 ${getButtonClass()}`, disabled: !!feedback }, opt)
                })
            ),
            React.createElement('p', { className: "text-2xl font-bold mt-8 text-primary" }, `Puntuación: ${score}`)
        )
    );
};
// --- END OF FILE: components/games/EcoQuizGame.tsx ---

// --- START OF FILE: components/games/MemoryGame.tsx ---
const MemoryGame = ({ onGameEnd }) => {
    const MEMORY_ITEMS = [
        { type: 'glass', icon: 'fa-solid fa-wine-glass' }, { type: 'paper', icon: 'fa-solid fa-newspaper' },
        { type: 'plastic', icon: 'fa-solid fa-bottle-water' }, { type: 'organic', icon: 'fa-solid fa-carrot' },
        { type: 'metal', icon: 'fa-solid fa-beer-mug-empty' }, { type: 'ewaste', icon: 'fa-solid fa-mobile-screen-button' },
    ];
    const generateCards = () => [...MEMORY_ITEMS, ...MEMORY_ITEMS]
        .map((item, i) => ({ ...item, id: i }))
        .sort(() => Math.random() - 0.5);

    const [cards, setCards] = useState(generateCards);
    const [flipped, setFlipped] = useState([]);
    const [matched, setMatched] = useState([]);
    const [score, setScore] = useState(0);
    const flipTimeout = useRef(null);

    useEffect(() => {
        if (matched.length === MEMORY_ITEMS.length) {
            setTimeout(() => onGameEnd(score), 500);
        }
    }, [matched, onGameEnd, score]);
    
    useEffect(() => {
        if (flipped.length === 2) {
            const [firstId, secondId] = flipped;
            const firstCard = cards.find(c => c.id === firstId);
            const secondCard = cards.find(c => c.id === secondId);

            if (firstCard && secondCard && firstCard.type === secondCard.type) {
                setMatched(prev => [...prev, firstCard.type]);
                setScore(prev => prev + 20);
                setFlipped([]);
            } else {
                flipTimeout.current = window.setTimeout(() => setFlipped([]), 1000);
            }
        }
    }, [flipped, cards]);

    useEffect(() => {
        return () => {
            if (flipTimeout.current) {
                clearTimeout(flipTimeout.current);
            }
        };
    }, []);

    const handleFlip = (id) => {
        if (flipped.length < 2 && !flipped.includes(id) && !matched.includes(cards.find(c => c.id === id)?.type || '')) {
            if (flipTimeout.current) clearTimeout(flipTimeout.current);
            setFlipped(prev => [...prev, id]);
        }
    };
    
    return (
        React.createElement('div', { className: "w-full max-w-2xl text-center" },
            React.createElement('p', { className: "text-2xl font-bold mb-6 text-primary" }, `Puntuación: ${score}`),
            React.createElement('div', { className: "grid grid-cols-4 gap-4" },
                cards.map(card => {
                    const isFlipped = flipped.includes(card.id) || matched.includes(card.type);
                    return (
                        React.createElement('div', { key: card.id, className: "w-full aspect-square [perspective:1000px] cursor-pointer", onClick: () => handleFlip(card.id) },
                            React.createElement('div', { className: `relative w-full h-full transition-transform duration-700 [transform-style:preserve-3d] ${isFlipped ? '[transform:rotateY(180deg)]' : ''}` },
                                React.createElement('div', { className: "absolute inset-0 bg-gradient-to-br from-primary to-primary-dark rounded-xl flex items-center justify-center [backface-visibility:hidden] shadow-lg" },
                                    React.createElement('i', { className: "fa-solid fa-leaf text-5xl text-dark-text opacity-80" })
                                ),
                                React.createElement('div', { className: "absolute inset-0 bg-card/80 backdrop-blur-sm rounded-xl flex items-center justify-center [backface-visibility:hidden] [transform:rotateY(180deg)] shadow-lg" },
                                    React.createElement('i', { className: `${card.icon} text-5xl text-primary drop-shadow-lg` })
                                )
                            )
                        )
                    );
                })
            )
        )
    );
};
// --- END OF FILE: components/games/MemoryGame.tsx ---

// --- START OF FILE: components/games/SortTheTrashGame.tsx ---
const SortTheTrashGame = ({ onGameEnd }) => {
    const ITEMS = [
        { name: "Botella de Plástico", category: "Plástico" },
        { name: "Periódico", category: "Papel" },
        { name: "Frasco de Vidrio", category: "Vidrio" },
        { name: "Cáscara de Plátano", category: "Orgánico" },
        { name: "Lata de Aluminio", category: "Metal" },
        { name: "Caja de Cartón", category: "Papel" },
    ];
    const BINS = [
        { name: "Orgánico", icon: "fa-solid fa-leaf", color: "from-green-500 to-green-600" },
        { name: "Vidrio", icon: "fa-solid fa-wine-glass", color: "from-blue-500 to-blue-600" },
        { name: "Papel", icon: "fa-solid fa-newspaper", color: "from-cyan-500 to-cyan-600" },
        { name: "Plástico", icon: "fa-solid fa-bottle-water", color: "from-yellow-500 to-yellow-600" },
        { name: "Metal", icon: "fa-solid fa-gear", color: "from-gray-500 to-gray-600" },
    ];
    const items = useRef(ITEMS.sort(() => 0.5 - Math.random())).current;
    const timerRef = useRef(null);

    const [currentItemIndex, setCurrentItemIndex] = useState(0);
    const [score, setScore] = useState(0);
    const [timeLeft, setTimeLeft] = useState(5);
    const [feedback, setFeedback] = useState(null);

    const stopTimer = useCallback(() => {
        if (timerRef.current) {
            clearInterval(timerRef.current);
            timerRef.current = null;
        }
    }, []);

    const handleNextItem = useCallback(() => {
        if (currentItemIndex < items.length - 1) {
            setCurrentItemIndex(i => i + 1);
            setFeedback(null);
            setTimeLeft(5);
        } else {
            onGameEnd(score);
        }
    }, [currentItemIndex, items.length, onGameEnd, score]);
    
    useEffect(() => {
        if (!feedback) {
            timerRef.current = window.setInterval(() => {
                setTimeLeft(prev => {
                    if (prev <= 1) {
                        stopTimer();
                        setFeedback('timeup');
                        return 0;
                    }
                    return prev - 1;
                });
            }, 1000);
        }
        return () => stopTimer();
    }, [feedback, currentItemIndex, stopTimer]);


    const handleAnswer = (binCategory) => {
        if (feedback) return;
        stopTimer();

        const isCorrect = items[currentItemIndex].category === binCategory;
        setScore(s => s + (isCorrect ? 10 : -5));
        setFeedback(isCorrect ? 'correct' : 'incorrect');
    };

    const item = items[currentItemIndex];
    if (!item) return null;

    const feedbackMessage = { correct: '¡Correcto!', incorrect: '¡Incorrecto!', timeup: '¡Tiempo Agotado!' };
    const feedbackTextColor = feedback === 'correct' ? 'text-primary' : 'text-red-500';

    return (
        React.createElement('div', { className: "w-full max-w-2xl text-center" },
            React.createElement('div', { className: "flex justify-between items-center mb-8" },
                React.createElement('p', { className: "text-2xl font-bold text-primary" }, `Puntuación: ${score}`),
                React.createElement('p', { className: "text-2xl font-bold text-warning" }, `Tiempo: ${timeLeft}s`)
            ),

            React.createElement('div', { className: `glass-card p-8 rounded-2xl mb-8 transition-all duration-300 relative shadow-inner` },
                 React.createElement('h3', { className: "text-4xl font-bold text-text" }, item.name)
            ),

            feedback && (
                 React.createElement('div', { className: "animate-fade-in text-center mb-8" },
                     React.createElement('p', { className: `text-3xl font-bold mb-6 ${feedbackTextColor}` },
                         feedbackMessage[feedback]
                     ),
                     React.createElement('button', { onClick: handleNextItem, className: "px-8 py-3 rounded-lg bg-primary text-dark-text text-lg font-semibold hover:bg-primary-dark transition shadow-lg hover:shadow-primary-glow-sm" },
                         currentItemIndex < items.length - 1 ? 'Siguiente Objeto' : 'Finalizar Juego'
                     )
                 )
            ),

            !feedback && (
                React.createElement('div', { className: "grid grid-cols-2 lg:grid-cols-5 gap-4 animate-fade-in" },
                    BINS.map(bin => (
                        React.createElement('button', { 
                            key: bin.name,
                            onClick: () => handleAnswer(bin.name),
                            className: `p-4 rounded-xl text-white font-semibold flex flex-col items-center justify-center aspect-square transition-transform hover:scale-105 bg-gradient-to-br ${bin.color} shadow-lg`,
                            disabled: !!feedback
                        },
                            React.createElement('i', { className: `${bin.icon} text-4xl mb-2 drop-shadow-sm` }),
                            React.createElement('span', null, bin.name)
                        )
                    ))
                )
            )
        )
    );
};
// --- END OF FILE: components/games/SortTheTrashGame.tsx ---

// --- START OF FILE: components/games/LightsOutGame.tsx ---
const LightsOutGame = ({ onGameEnd }) => {
    const GRID_SIZE = 25; // 5x5 grid
    const LIGHT_LIFETIME_MS = 4000;
    const TIME_BONUS_S = 0.5;
    const MAX_TIME_S = 30;
    const WARNING_TIME_MS = 1500;
    const INITIAL_TIME_S = 15;
    const SPAWN_INTERVAL_MS = 1200;

    const createInitialGrid = () => 
        Array.from({ length: GRID_SIZE }, (_, i) => ({
            id: i,
            state: 'off',
            expiresAt: 0,
        }));

    const [grid, setGrid] = useState(createInitialGrid());
    const [score, setScore] = useState(0);
    const [timeLeft, setTimeLeft] = useState(INITIAL_TIME_S);
    const [gameOver, setGameOver] = useState(false);
    
    const gameLoopRef = useRef(null);
    const spawnerRef = useRef(null);
    const timeLeftRef = useRef(timeLeft);
    const scoreRef = useRef(score);
    scoreRef.current = score; 

    const handleGameOver = useCallback((finalScore) => {
        if (gameOver) return;
        setGameOver(true);
        if (gameLoopRef.current) clearInterval(gameLoopRef.current);
        if (spawnerRef.current) clearInterval(spawnerRef.current);
        onGameEnd(finalScore);
    }, [gameOver, onGameEnd]);

    useEffect(() => {
        gameLoopRef.current = window.setInterval(() => {
            const now = Date.now();
            
            timeLeftRef.current -= 0.1; 
            setTimeLeft(timeLeftRef.current);
            if (timeLeftRef.current <= 0) {
                handleGameOver(scoreRef.current);
                return;
            }
            
            let shouldEndGame = false;
            setGrid(prevGrid => {
                const newGrid = prevGrid.map(light => {
                    if (light.state === 'off') return light;
                    
                    if (now >= light.expiresAt) {
                        shouldEndGame = true;
                        return { ...light, state: 'off', expiresAt: 0 };
                    }
                    
                    const newState = (light.expiresAt - now < WARNING_TIME_MS) ? 'warning' : 'on';
                    
                    return { ...light, state: newState };
                });
                
                if (shouldEndGame) {
                    handleGameOver(scoreRef.current);
                }
                
                return newGrid;
            });
        }, 100);

        return () => {
            if (gameLoopRef.current) clearInterval(gameLoopRef.current);
        };
    }, [handleGameOver]);

    useEffect(() => {
        spawnerRef.current = window.setInterval(() => {
            if (gameOver) return;
            setGrid(prevGrid => {
                const offIndices = prevGrid.map((light, i) => light.state === 'off' ? i : -1).filter(i => i !== -1);
                if (offIndices.length > 0) {
                    const newGrid = [...prevGrid];
                    const randomIndex = offIndices[Math.floor(Math.random() * offIndices.length)];
                    newGrid[randomIndex] = {
                        ...newGrid[randomIndex],
                        state: 'on',
                        expiresAt: Date.now() + LIGHT_LIFETIME_MS
                    };
                    return newGrid;
                }
                return prevGrid;
            });
        }, SPAWN_INTERVAL_MS);

        return () => {
            if (spawnerRef.current) clearInterval(spawnerRef.current);
        };
    }, [gameOver]);


    const handleClick = (id) => {
        if (gameOver) return;
        
        const light = grid.find(l => l.id === id);
        if (light && light.state !== 'off') {
            setGrid(prevGrid => prevGrid.map(l => l.id === id ? { ...l, state: 'off', expiresAt: 0 } : l));
            setScore(s => s + 10);
            
            timeLeftRef.current = Math.min(timeLeftRef.current + TIME_BONUS_S, MAX_TIME_S);
            setTimeLeft(timeLeftRef.current);
        }
    };
    
    const getLightClass = (state) => {
        switch(state) {
            case 'on': return 'bg-yellow-400 shadow-lg shadow-yellow-400/50 scale-105';
            case 'warning': return 'bg-red-500 shadow-lg shadow-red-500/50 animate-pulse scale-105';
            case 'off': return 'bg-hover/80';
            default: return 'bg-hover/80';
        }
    };

    return (
        React.createElement('div', { className: "w-full max-w-lg text-center" },
            gameOver ? (
                React.createElement('div', { className: "animate-fade-in" },
                    React.createElement('h3', { className: "text-4xl font-bold text-primary mb-2" }, "¡Juego Terminado!"),
                    React.createElement('p', { className: "text-2xl font-bold text-text mb-6" }, `Puntuación Final: ${score}`),
                    React.createElement('p', { className: "text-text-subtle" }, "El juego ha finalizado. La puntuación será registrada.")
                )
            ) : (
                React.createElement(React.Fragment, null,
                    React.createElement('div', { className: "flex justify-between items-center mb-8" },
                        React.createElement('p', { className: "text-2xl font-bold text-primary" }, `Puntuación: ${score}`),
                        React.createElement('div', { className: "text-2xl font-bold text-warning flex items-center gap-2" },
                           React.createElement('i', { className: "fa-solid fa-stopwatch" }),
                           React.createElement('span', null, `${Math.max(0, timeLeft).toFixed(1)}s`)
                        )
                    ),
                    React.createElement('div', { className: "grid grid-cols-5 gap-3 sm:gap-4" },
                        grid.map((light) => (
                            React.createElement('button', {
                                key: light.id,
                                onClick: () => handleClick(light.id),
                                className: `aspect-square rounded-lg transition-all duration-150 ${getLightClass(light.state)}`,
                                "aria-label": `Light ${light.id + 1}`
                            })
                        ))
                    ),
                    React.createElement('p', { className: "text-sm text-text-subtle mt-8" }, "Apaga las luces antes de que se consuman. Cada luz apagada te da más tiempo.")
                )
            )
        )
    );
};
// --- END OF FILE: components/games/LightsOutGame.tsx ---

// --- START OF FILE: components/games/EcoAnagramsGame.tsx ---
const EcoAnagramsGame = ({ onGameEnd }) => {
    const WORDS = [
        { scrambled: 'ajelcicre', answer: 'reciclaje' },
        { scrambled: 'tomascopj', answer: 'compostaj' },
        { scrambled: 'trensgia', answer: 'energia' },
        { scrambled: 'netobisle', answer: 'sostenible' },
        { scrambled: 'coniamotcina', answer: 'contaminacion' },
    ];
    const words = useRef(WORDS.sort(() => 0.5 - Math.random())).current;

    const [currentWordIndex, setCurrentWordIndex] = useState(0);
    const [inputValue, setInputValue] = useState('');
    const [score, setScore] = useState(0);
    const [feedback, setFeedback] = useState(null);

    const handleSubmit = (e) => {
        e.preventDefault();
        if(feedback) return;
        
        const correct = inputValue.toLowerCase() === words[currentWordIndex].answer;
        setFeedback(correct ? 'correct' : 'incorrect');
        
        setTimeout(() => {
            setFeedback(null);
            setInputValue('');
            if (correct) {
                const newScore = score + 15;
                setScore(newScore);
                 if (currentWordIndex === words.length - 1) {
                    onGameEnd(newScore);
                } else {
                    setCurrentWordIndex(i => i + 1);
                }
            } else {
                 if (currentWordIndex === words.length - 1) {
                    onGameEnd(score);
                } else {
                    setCurrentWordIndex(i => i + 1);
                }
            }
        }, 1200);
    };

    return (
        React.createElement('div', { className: "w-full max-w-md text-center" },
            React.createElement('p', { className: "font-semibold text-text-subtle mb-4" }, `Palabra ${currentWordIndex + 1} de ${words.length}`),
            React.createElement('div', { className: "bg-hover/80 p-8 rounded-2xl mb-8 shadow-inner" },
                 React.createElement('h3', { className: "text-5xl font-bold text-text tracking-widest" }, words[currentWordIndex].scrambled.toUpperCase())
            ),
            React.createElement('form', { onSubmit: handleSubmit, className: "flex gap-3" },
                React.createElement('input', {
                    type: "text",
                    value: inputValue,
                    onChange: e => setInputValue(e.target.value),
                    className: `w-full text-center text-lg px-4 py-3 border-2 rounded-lg focus:outline-none focus:ring-2 bg-hover text-text transition-all ${
                        feedback === 'correct' ? 'border-primary ring-primary' : ''
                    } ${
                        feedback === 'incorrect' ? 'border-red-500 ring-red-500 animate-shake' : ''
                    } ${
                        !feedback ? 'border-border focus:ring-primary' : ''
                    }`,
                    placeholder: "Escribe la palabra",
                    disabled: !!feedback,
                    autoFocus: true
                }),
                React.createElement('button', { type: "submit", disabled: !inputValue || !!feedback, className: "py-3 px-6 rounded-lg bg-primary text-dark-text font-semibold hover:bg-primary-dark transition disabled:opacity-50 shadow-lg hover:shadow-primary-glow-sm" },
                    "Enviar"
                )
            ),
            React.createElement('p', { className: "text-2xl font-bold mt-8 text-primary" }, `Puntuación: ${score}`)
        )
    );
};
// --- END OF FILE: components/games/EcoAnagramsGame.tsx ---

// --- START OF FILE: components/games/RecycleRushGame.tsx ---
const RecycleRushGame = ({ onGameEnd }) => {
    const GAME_WIDTH = 500;
    const GAME_HEIGHT = 600;
    const ITEM_SIZE = 50;
    const INITIAL_LIVES = 3;
    const ITEM_SPAWN_INTERVAL = 900;
    const BASE_SPEED = 2;

    const RECYCLABLES = [
        { icon: 'fa-solid fa-bottle-water', points: 5, color: 'text-blue-400' },
        { icon: 'fa-solid fa-newspaper', points: 5, color: 'text-gray-400' },
        { icon: 'fa-solid fa-wine-glass', points: 5, color: 'text-green-400' },
        { icon: 'fa-solid fa-beer-mug-empty', points: 5, color: 'text-yellow-600' },
    ];
    const HAZARDS = [
        { icon: 'fa-solid fa-battery-half', points: -10, color: 'text-red-500' },
        { icon: 'fa-solid fa-syringe', points: -10, color: 'text-red-500' },
        { icon: 'fa-solid fa-biohazard', points: -10, color: 'text-orange-500' },
    ];

    const [items, setItems] = useState([]);
    const [score, setScore] = useState(0);
    const [lives, setLives] = useState(INITIAL_LIVES);
    const [gameOver, setGameOver] = useState(false);
    const [feedback, setFeedback] = useState([]);

    const gameLoopRef = useRef(null);
    const nextItemId = useRef(0);

    const handleGameOver = useCallback((finalScore) => {
        if (!gameOver) {
            setGameOver(true);
            onGameEnd(finalScore);
        }
    }, [gameOver, onGameEnd]);

    useEffect(() => {
        if (lives <= 0) {
            handleGameOver(score);
        }
    }, [lives, score, handleGameOver]);
    
    useEffect(() => {
        const loop = () => {
            if (!gameOver) {
                setItems(prevItems => {
                    const newItems = [];
                    let livesLost = 0;
                    for (const item of prevItems) {
                        const newY = item.y + item.speed;
                        if (newY < GAME_HEIGHT) {
                            newItems.push({ ...item, y: newY });
                        } else if (item.isRecyclable) {
                            livesLost++;
                        }
                    }
                    if (livesLost > 0) {
                        setLives(l => l - livesLost);
                    }
                    return newItems;
                });
                gameLoopRef.current = requestAnimationFrame(loop);
            }
        };
        gameLoopRef.current = requestAnimationFrame(loop);
        return () => {
            if(gameLoopRef.current) cancelAnimationFrame(gameLoopRef.current);
        };
    }, [gameOver]);

    useEffect(() => {
        const spawner = setInterval(() => {
            if (!gameOver) {
                const isRecyclable = Math.random() > 0.3;
                const template = isRecyclable ? RECYCLABLES[Math.floor(Math.random() * RECYCLABLES.length)] : HAZARDS[Math.floor(Math.random() * HAZARDS.length)];

                const newItem = {
                    id: nextItemId.current++,
                    icon: template.icon,
                    isRecyclable,
                    points: template.points,
                    x: Math.random() * (GAME_WIDTH - ITEM_SIZE),
                    y: -ITEM_SIZE,
                    speed: BASE_SPEED + Math.random() * 2,
                    color: template.color
                };
                setItems(prev => [...prev, newItem]);
            }
        }, ITEM_SPAWN_INTERVAL);

        return () => clearInterval(spawner);
    }, [gameOver]);
    
    const handleItemClick = (clickedItem) => {
        if(gameOver) return;

        setItems(prev => prev.filter(item => item.id !== clickedItem.id));
        setScore(s => Math.max(0, s + clickedItem.points));

        const newFeedback = { x: clickedItem.x, y: clickedItem.y, text: `${clickedItem.points > 0 ? '+' : ''}${clickedItem.points}`, id: clickedItem.id };
        setFeedback(prev => [...prev, newFeedback]);
        setTimeout(() => setFeedback(prev => prev.filter(f => f.id !== newFeedback.id)), 800);
    };

    return (
        React.createElement('div', { className: "w-full max-w-lg text-center flex flex-col items-center" },
             React.createElement('div', { className: "w-full flex justify-between items-center mb-4 px-4" },
                React.createElement('p', { className: "text-2xl font-bold text-primary" }, `Puntuación: ${score}`),
                React.createElement('div', { className: "flex items-center gap-2 text-2xl font-bold text-red-500" },
                    [...Array(INITIAL_LIVES)].map((_, i) => (
                        React.createElement('i', { key: i, className: `fa-solid fa-heart transition-colors ${i < lives ? 'text-red-500' : 'text-border'}` })
                    ))
                )
            ),
            React.createElement('div', { className: "relative bg-sky-200 dark:bg-slate-800 rounded-lg shadow-inner overflow-hidden", style: { width: GAME_WIDTH, height: GAME_HEIGHT } },
                items.map(item => (
                    React.createElement('button', {
                        key: item.id,
                        className: `absolute text-5xl transition-transform hover:scale-110`,
                        style: { left: item.x, top: item.y, width: ITEM_SIZE, height: ITEM_SIZE },
                        onClick: () => handleItemClick(item),
                        "aria-label": `Atrapar ${item.isRecyclable ? 'reciclable' : 'residuo'}`
                    },
                        React.createElement('i', { className: `${item.icon} ${item.color}` })
                    )
                )),
                feedback.map(f => (
                    React.createElement('div', { key: f.id, className: "absolute font-bold text-lg animate-fade-out-up pointer-events-none", style: { left: f.x, top: f.y, color: f.text.startsWith('+') ? 'var(--primary-color)' : '#ef4444' } },
                        f.text
                    )
                ))
            ),
             React.createElement('p', { className: "text-sm text-text-subtle mt-4" }, "Atrapa los reciclables, ¡evita los peligrosos!")
        )
    );
};
// --- END OF FILE: components/games/RecycleRushGame.tsx ---

// --- START OF FILE: components/games/GameContainer.tsx ---
const GameContainer = ({ title, children, onExit }) => (
    React.createElement('div', { className: "fixed inset-0 bg-slate-900/60 dark:bg-black/70 backdrop-blur-md z-40 p-4 sm:p-8 flex flex-col animate-fade-in" },
        React.createElement('header', { className: "flex items-center justify-between mb-6" },
            React.createElement('h2', { className: "text-3xl font-bold gradient-text" }, title),
            React.createElement('button', { onClick: onExit, className: "flex items-center gap-2 px-4 py-2 rounded-lg bg-hover text-text font-semibold hover:bg-border transition-colors" },
                React.createElement('i', { className: "fa-solid fa-xmark w-5 h-5" }),
                "Salir"
            )
        ),
        React.createElement('div', { className: "flex-grow glass-card rounded-2xl shadow-inner flex items-center justify-center p-4" },
            children
        )
    )
);
// --- END OF FILE: components/games/GameContainer.tsx ---

// --- START OF FILE: components/GameManager.tsx ---
const GameManager = () => {
    const { activeGame, setActiveGame } = useAppContext();
    const { handleGameEnd } = useGameLogic();
    
    if (!activeGame) return null;

    let GameComponent;
    switch (activeGame.id) {
        case 'g1': GameComponent = EcoQuizGame; break;
        case 'g2': GameComponent = MemoryGame; break;
        case 'g3': GameComponent = SortTheTrashGame; break;
        case 'g4': GameComponent = LightsOutGame; break;
        case 'g5': GameComponent = EcoAnagramsGame; break;
        case 'g6': GameComponent = RecycleRushGame; break;
        default: GameComponent = () => React.createElement('div', null, 'Juego no encontrado');
    }

    return (
        React.createElement(GameContainer, { title: activeGame.title, onExit: () => setActiveGame(null) },
            React.createElement(GameComponent, { onGameEnd: handleGameEnd })
        )
    );
};
// --- END OF FILE: components/GameManager.tsx ---

// --- START OF FILE: components/modals/LessonModal.tsx ---
const LessonModal = ({ lesson, onClose, onComplete, isCompleted }) => {
    const [isQuizPassed, setQuizPassed] = useState(false);
    
    const hasQuiz = lesson.interactiveQuiz && lesson.interactiveQuiz.length > 0;
    
    const canComplete = isCompleted || !hasQuiz || isQuizPassed;

    const handleComplete = () => {
        if (!isCompleted) {
            onComplete();
        }
        onClose();
    };

    return (
        React.createElement('div', { className: "fixed inset-0 bg-slate-900/60 dark:bg-black/70 backdrop-blur-sm flex justify-center items-center z-50 p-4 animate-fade-in", onClick: onClose },
            React.createElement('div', { className: "glass-card rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col animate-fade-in-down", onClick: e => e.stopPropagation() },
                React.createElement('header', { className: "p-6 border-b border-border/50 flex justify-between items-center relative overflow-hidden" },
                    React.createElement('div', { className: "flex items-center gap-4" },
                        React.createElement('div', { className: "w-14 h-14 bg-primary/20 rounded-lg flex items-center justify-center flex-shrink-0 shadow-inner" },
                            React.createElement('i', { className: `${lesson.icon} text-3xl text-primary` })
                        ),
                        React.createElement('div', null,
                            React.createElement('p', { className: "text-sm font-semibold text-primary" }, lesson.category),
                            React.createElement('h2', { className: "text-2xl font-bold text-text" }, lesson.title)
                        )
                    ),
                    React.createElement('i', { className: `${lesson.icon} absolute -right-8 -bottom-10 text-9xl text-hover/50 opacity-50 -rotate-12` }),
                    React.createElement('button', { onClick: onClose, className: "p-2 rounded-full hover:bg-hover/80 text-text-subtle hover:text-text z-10 transition-colors", "aria-label": "Cerrar modal de lección" },
                        React.createElement('i', { className: "fa-solid fa-xmark w-6 h-6" })
                    )
                ),
                React.createElement('div', { className: "p-8 overflow-y-auto flex-grow" },
                    React.createElement('div', { className: "prose dark:prose-invert max-w-none text-text" },
                        lesson.content
                    ),
                     hasQuiz && (
                        React.createElement(QuizComponent, {
                            questions: lesson.interactiveQuiz,
                            onQuizComplete: (success) => {
                                if (success) {
                                    setQuizPassed(true);
                                }
                            }
                        })
                    )
                ),
                React.createElement('footer', { className: "p-6 border-t border-border/50 flex justify-end items-center gap-4" },
                    React.createElement('button', { onClick: onClose, className: "py-2 px-5 rounded-lg text-text font-semibold hover:bg-border transition" },
                        "Cerrar"
                    ),
                    React.createElement('button', {
                        onClick: handleComplete,
                        disabled: !canComplete,
                        className: "py-2.5 px-6 rounded-lg bg-primary text-dark-text font-semibold hover:bg-primary-dark transition disabled:opacity-70 flex items-center gap-2 shadow-lg hover:shadow-primary-glow-sm transform hover:scale-105"
                    },
                        React.createElement('i', { className: `fa-solid ${isCompleted ? 'fa-circle-check' : (canComplete ? 'fa-check' : 'fa-lock')}` }),
                        isCompleted ? 'Lección Repasada' : (canComplete ? 'Completar Lección' : 'Completa el Quiz')
                    )
                )
            )
        )
    );
};
// --- END OF FILE: components/modals/LessonModal.tsx ---

// --- START OF FILE: components/modals/ProModal.tsx ---
const ProModal = ({ onClose, onConfirm }) => (
    React.createElement('div', { className: "fixed inset-0 bg-slate-900/60 dark:bg-black/70 backdrop-blur-sm flex justify-center items-center z-50 p-4 animate-fade-in" },
        React.createElement('div', { className: "glass-card rounded-2xl shadow-2xl w-full max-w-md p-8 text-center relative animate-fade-in-down border-amber-400/50 border" },
            React.createElement('button', { onClick: onClose, className: "absolute top-4 right-4 text-text-subtle hover:text-text p-2 rounded-full hover:bg-hover transition-colors", "aria-label": "Cerrar modal de EcoScore Pro" },
                React.createElement('i', { className: "fa-solid fa-xmark w-6 h-6" })
            ),
            React.createElement('div', { className: "mx-auto bg-amber-400/20 w-20 h-20 rounded-full flex items-center justify-center mb-4 shadow-inner" },
                React.createElement('i', { className: "fa-solid fa-crown w-10 h-10 text-amber-400 text-4xl drop-shadow-[0_2px_10px_rgba(251,191,36,0.6)]" })
            ),
            React.createElement('h2', { className: "text-3xl font-bold text-text mb-2" }, "Desbloquea el Modo Pro"),
            React.createElement('p', { className: "text-text-subtle mb-6" }, "Acelera tu impacto y accede a contenido exclusivo por solo 5 soles al mes."),
            React.createElement('ul', { className: "text-left space-y-3 mb-8" },
                [
                    { icon: 'fa-solid fa-graduation-cap', text: 'Acceso a todas las lecciones y rutas Pro' },
                    { icon: 'fa-solid fa-ghost', text: 'Minijuegos exclusivos con recompensas dobles' },
                    { icon: 'fa-solid fa-bolt-lightning', text: 'Capacidad de energía duplicada (10 intentos)' },
                    { icon: 'fa-solid fa-gem', text: 'Artículos de personalización premium en la tienda' },
                ].map((item, index) => (
                    React.createElement('li', { key: index, className: "flex items-center gap-4 p-2 bg-hover/50 rounded-lg" },
                        React.createElement('i', { className: `${item.icon} w-6 h-6 text-primary flex-shrink-0 text-center` }),
                        React.createElement('span', { className: "text-text font-medium" }, item.text)
                    )
                ))
            ),
            React.createElement('div', { className: "flex gap-4" },
                React.createElement('button', { onClick: onClose, className: "w-full py-3 px-4 rounded-lg bg-hover text-text font-semibold hover:bg-border transition" }, "Cancelar"),
                React.createElement('button', { onClick: onConfirm, className: "w-full py-3 px-4 rounded-lg bg-primary text-dark-text font-semibold transition-all duration-200 shadow-lg hover:shadow-primary-glow-md transform hover:scale-105" }, "Adquirir por 5 soles/mes")
            )
        )
    )
);
// --- END OF FILE: components/modals/ProModal.tsx ---

// --- START OF FILE: components/modals/SettingsModal.tsx ---
const SettingsModal = ({ onClose, isDarkMode, setDarkMode, activeTheme, setActiveTheme }) => {
    const colorThemes = [
        { id: 'emerald-white', name: 'Verdes y Blancos', colors: ['#2ECC71', '#A2D9A0', '#FFFFFF'] },
        { id: 'sky-forest', name: 'Azules y Verdes', colors: ['#27AE60', '#3498DB', '#F5F5DC'] },
        { id: 'earth-nature', name: 'Tierra y Naturaleza', colors: ['#808000', '#D2B48C', '#F9F9F9'] },
        { id: 'sunny-apple', name: 'Amarillos y Verdes', colors: ['#7DCEA0', '#F1C40F', '#EAECEE'] },
        { id: 'pastel-tones', name: 'Tonos Pastel', colors: ['#A2D9A0', '#AED6F1', '#FFFFFF'] },
        { id: 'aquatic-colors', name: 'Colores Acuáticos', colors: ['#1ABC9C', '#2C3E50', '#ECF0F1'] },
        { id: 'dark-light-green', name: 'Verdes y Claros', colors: ['#58D68D', '#1E8449', '#EAECEE'] },
    ];

    const ToggleSwitch = ({ label, description, checked, onChange, name, disabled = false }) => (
        React.createElement('div', { className: `flex items-start justify-between py-5 border-b border-border/50 last:border-b-0 ${disabled ? 'opacity-50' : ''}` },
            React.createElement('div', null,
                React.createElement('p', { className: "font-semibold text-text" }, label),
                React.createElement('p', { className: "text-sm text-text-subtle mt-1" }, description)
            ),
            React.createElement('label', { className: "relative inline-flex items-center cursor-pointer flex-shrink-0 ml-6" },
                React.createElement('input', { type: "checkbox", name: name, checked: checked, onChange: onChange, className: "sr-only peer", disabled: disabled }),
                React.createElement('div', { className: "w-11 h-6 bg-border peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary" })
            )
        )
    );

    const { user, onUserUpdate, showToast } = useAppContext();
    const [activeTab, setActiveTab] = useState('cuenta');
    
    const [formData, setFormData] = useState({ name: user.name, location: user.location, email: 'usuario.demo@ecopuntos.com' });

    const [notifications, setNotifications] = useState({
        weeklySummary: true,
        newMissions: true,
        postLikes: false,
        postComments: true,
    });
    
    useEffect(() => {
        setFormData({
            name: user.name || '',
            location: user.location || '',
            email: 'usuario.demo@ecopuntos.com'
        });
    }, [user]);

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const handleNotificationsChange = (e) => {
        const { name, checked } = e.target;
        setNotifications(prev => ({ ...prev, [name]: checked }));
    };

    const handleSave = () => {
        if (user.name !== formData.name || user.location !== formData.location) {
          onUserUpdate({ ...user, name: formData.name, location: formData.location, initials: formData.name.split(' ').map(n => n[0]).join('') });
        }
        console.log('Saving notification preferences:', notifications);
        showToast('Ajustes guardados exitosamente.', 'success');
        onClose();
    };

    const handleDeleteAccount = () => {
        if (window.confirm('¿Estás ABSOLUTAMENTE seguro de que quieres eliminar tu cuenta? Esta acción es irreversible y perderás todos tus puntos y progreso.')) {
            showToast('Cuenta eliminada. Te echaremos de menos.', 'info');
            onClose(); 
        }
    };
    
    const handleReportBug = () => {
        showToast('La función de reportar errores no está implementada todavía.', 'info');
    };
    
    const handleSendFeedback = () => {
        showToast('La función de enviar sugerencias no está implementada todavía.', 'info');
    };

    const navItems = [
        { id: 'cuenta', label: 'Cuenta', icon: 'fa-solid fa-user-gear' },
        { id: 'notificaciones', label: 'Notificaciones', icon: 'fa-solid fa-bell' },
        { id: 'apariencia', label: 'Apariencia', icon: 'fa-solid fa-palette' },
        { id: 'seguridad', label: 'Seguridad', icon: 'fa-solid fa-shield-halved' },
        { id: 'ayuda', label: 'Ayuda y Soporte', icon: 'fa-solid fa-life-ring' },
    ];

    const renderTabContent = () => {
        switch (activeTab) {
            case 'cuenta': return (
                React.createElement('div', { className: "space-y-6" },
                    React.createElement('div', null,
                        React.createElement('label', { htmlFor: "name", className: "block text-sm font-medium text-text-subtle mb-2" }, "Nombre Completo"),
                        React.createElement('input', { type: "text", id: "name", name: "name", value: formData.name, onChange: handleInputChange, className: "w-full px-4 py-2 border-2 border-border/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-hover text-text" }),
                        React.createElement('p', { className: "mt-1 text-xs text-text-subtle" }, "Este es el nombre que se mostrará en tu perfil y en el ranking.")
                    ),
                    React.createElement('div', null,
                        React.createElement('label', { htmlFor: "email", className: "block text-sm font-medium text-text-subtle mb-2" }, "Correo Electrónico"),
                        React.createElement('input', { type: "email", id: "email", name: "email", value: formData.email, className: "w-full px-4 py-2 border-2 border-border/50 rounded-lg bg-hover/50 text-text-subtle cursor-not-allowed", readOnly: true }),
                        React.createElement('p', { className: "mt-1 text-xs text-text-subtle" }, "El correo electrónico no se puede cambiar.")
                    ),
                    React.createElement('div', null,
                        React.createElement('label', { htmlFor: "location", className: "block text-sm font-medium text-text-subtle mb-2" }, "Ubicación"),
                        React.createElement('input', { type: "text", id: "location", name: "location", value: formData.location, onChange: handleInputChange, className: "w-full px-4 py-2 border-2 border-border/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-hover text-text" }),
                        React.createElement('p', { className: "mt-1 text-xs text-text-subtle" }, "Tu ciudad ayuda a personalizar los desafíos locales.")
                    )
                )
            );
            case 'notificaciones': return (
                React.createElement('div', null,
                    React.createElement(ToggleSwitch, { label: "Resumen semanal por correo", description: "Recibe un email cada lunes con tu progreso.", checked: notifications.weeklySummary, onChange: handleNotificationsChange, name: "weeklySummary" }),
                    React.createElement(ToggleSwitch, { label: "Nuevas misiones y desafíos", description: "Entérate cuando haya nuevas formas de ganar puntos.", checked: notifications.newMissions, onChange: handleNotificationsChange, name: "newMissions" }),
                    React.createElement(ToggleSwitch, { label: "Likes en mis publicaciones", description: "Recibir una notificación cuando a alguien le guste tu post.", checked: notifications.postLikes, onChange: handleNotificationsChange, name: "postLikes" }),
                    React.createElement(ToggleSwitch, { label: "Comentarios en mis publicaciones", description: "Recibir una notificación cuando alguien comente en tu post.", checked: notifications.postComments, onChange: handleNotificationsChange, name: "postComments" })
                )
            );
            case 'apariencia': return (
                 React.createElement('div', null,
                    React.createElement(ToggleSwitch, { label: "Modo Oscuro", description: "Reduce la fatiga visual en entornos con poca luz.", checked: isDarkMode, onChange: () => { if (activeTheme === 'aquatic-colors') { setActiveTheme('default'); } setDarkMode(!isDarkMode); }, name: "darkMode", disabled: activeTheme === 'aquatic-colors'}),
                    activeTheme === 'aquatic-colors' && React.createElement('p', { className: "text-xs text-text-subtle -mt-3 mb-4" }, 'El tema "Colores Acuáticos" requiere el modo oscuro.'),
                    
                    React.createElement('div', { className: "mt-8 pt-6 border-t border-border/50" },
                        React.createElement('h4', { className: "text-lg font-bold text-text mb-4" }, "Temas de Color"),
                        React.createElement('div', { className: "grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4" },
                            colorThemes.map(theme => (
                                React.createElement('button', { key: theme.id, onClick: () => setActiveTheme(theme.id), className: `p-2 rounded-lg border-2 transition-all duration-200 ${activeTheme === theme.id ? 'border-primary ring-2 ring-primary/80 shadow-lg' : 'border-transparent hover:border-border'}` },
                                    React.createElement('div', { className: "flex h-12 w-full rounded-md overflow-hidden shadow-inner bg-gray-200" },
                                        React.createElement('div', { className: "w-1/3 h-full", style: {backgroundColor: theme.colors[0]} }),
                                        React.createElement('div', { className: "w-1/3 h-full", style: {backgroundColor: theme.colors[1]} }),
                                        React.createElement('div', { className: "w-1/3 h-full", style: {backgroundColor: theme.colors[2]} })
                                    ),
                                    React.createElement('p', { className: "text-xs font-semibold mt-2 text-text" }, theme.name)
                                )
                            ))
                        ),
                        React.createElement('button', { onClick: () => setActiveTheme('default'), className: "mt-6 text-sm text-text-subtle font-semibold hover:text-primary transition-colors" },
                            React.createElement('i', { className: "fa-solid fa-arrow-rotate-left mr-2" }),
                            "Restablecer tema predeterminado"
                        )
                    )
                )
            );
            case 'seguridad': return (
                React.createElement('div', { className: "space-y-8" },
                     React.createElement('div', null,
                        React.createElement('h4', { className: "text-xl font-bold text-text mb-4" }, "Cambiar Contraseña"),
                        React.createElement('div', { className: "space-y-4" },
                            React.createElement('input', { type: "password", placeholder: "Contraseña Actual", className: "w-full px-4 py-2 border-2 border-border/80 rounded-lg bg-hover text-text focus:ring-2 focus:ring-primary" }),
                            React.createElement('input', {type: "password", placeholder: "Nueva Contraseña", className: "w-full px-4 py-2 border-2 border-border/80 rounded-lg bg-hover text-text focus:ring-2 focus:ring-primary"}),
                            React.createElement('input', { type: "password", placeholder: "Confirmar Nueva Contraseña", className: "w-full px-4 py-2 border-2 border-border/80 rounded-lg bg-hover text-text focus:ring-2 focus:ring-primary"}),
                            React.createElement('button', { className: "px-5 py-2 rounded-lg bg-primary text-dark-text font-semibold hover:bg-primary-dark transition shadow-md" }, "Actualizar Contraseña")
                        )
                    ),
                    React.createElement('div', { className: "border-t-2 border-red-500/30 pt-6" },
                         React.createElement('h4', { className: "text-xl font-bold text-red-500 mb-2" }, "Zona de Peligro"),
                         React.createElement('p', { className: "text-sm text-text-subtle mb-4" }, "Esta acción es permanente y no se puede deshacer. Perderás todo tu progreso."),
                         React.createElement('button', { onClick: handleDeleteAccount, className: "px-5 py-2 rounded-lg text-white bg-red-600 font-semibold hover:bg-red-700 transition shadow-lg shadow-red-600/30" }, "Eliminar Mi Cuenta")
                    )
                )
            );
            case 'ayuda': return (
                React.createElement('div', { className: "space-y-8" },
                    React.createElement('div', null,
                        React.createElement('h4', { className: "text-xl font-bold text-text mb-4" }, "Soporte y Feedback"),
                        React.createElement('p', { className: "text-text-subtle mb-6" }, "¿Encontraste un problema o tienes una idea genial? ¡Nos encantaría saberlo!"),
                        React.createElement('div', { className: "flex flex-col sm:flex-row gap-4" },
                            React.createElement('button', { onClick: handleReportBug, className: "flex-1 flex items-center justify-center gap-3 py-3 px-4 rounded-lg bg-hover border border-border/80 hover:bg-border transition-colors" },
                                React.createElement('i', { className: "fa-solid fa-bug text-red-500" }),
                                React.createElement('span', { className: "font-semibold text-text" }, "Reportar un Problema")
                            ),
                             React.createElement('button', { onClick: handleSendFeedback, className: "flex-1 flex items-center justify-center gap-3 py-3 px-4 rounded-lg bg-hover border border-border/80 hover:bg-border transition-colors" },
                                React.createElement('i', { className: "fa-solid fa-lightbulb text-yellow-500" }),
                                React.createElement('span', { className: "font-semibold text-text" }, "Enviar Sugerencia")
                            )
                        )
                    ),

                    React.createElement('div', null,
                        React.createElement('h4', { className: "text-xl font-bold text-text mb-4" }, "Preguntas Frecuentes (FAQ)"),
                         React.createElement('div', { className: "space-y-4" },
                             React.createElement('div', null,
                                 React.createElement('h5', { className: "font-semibold text-text" }, "¿Cómo gano puntos?"),
                                 React.createElement('p', { className: "text-text-subtle text-sm" }, "Ganas puntos al escanear productos, completar misiones, jugar minijuegos, y participar en nuestras lecciones educativas.")
                             ),
                             React.createElement('div', null,
                                 React.createElement('h5', { className: "font-semibold text-text" }, "¿Qué pasa si me olvido de iniciar sesión un día?"),
                                 React.createElement('p', { className: "text-text-subtle text-sm" }, "Si omites un día, tu racha de días seguidos se reiniciará a cero. ¡Pero no te preocupes, puedes empezar una nueva racha al día siguiente!")
                             )
                         )
                    )
                )
            );
            default: return null;
        }
    };

    return (
        React.createElement('div', { className: "fixed inset-0 bg-slate-900/60 dark:bg-black/70 backdrop-blur-sm flex justify-center items-center z-50 p-4 animate-fade-in", onClick: onClose },
            React.createElement('div', { className: "glass-card rounded-2xl shadow-2xl w-full max-w-5xl h-[90vh] max-h-[700px] flex flex-col sm:flex-row overflow-hidden animate-fade-in-down", onClick: e => e.stopPropagation() },
                // Sidebar
                React.createElement('div', { className: "w-full sm:w-1/4 bg-hover/50 p-4 border-b sm:border-b-0 sm:border-r border-border/50 flex-shrink-0 overflow-y-auto" },
                    React.createElement('h2', { className: "text-xl font-bold text-text px-2 pb-4 mb-4 border-b border-border/50" }, "Configuración"),
                    React.createElement('nav', { className: "space-y-1.5" },
                        navItems.map(item => (
                            React.createElement('button', {
                                key: item.id,
                                onClick: () => setActiveTab(item.id),
                                className: `w-full text-left flex items-center gap-3 px-3 py-2.5 rounded-lg font-semibold transition-colors text-sm
                                    ${ activeTab === item.id ? 'bg-primary/20 text-primary' : 'text-text-subtle hover:bg-black/5 dark:hover:bg-white/5' }
                                `
                            },
                                React.createElement('i', { className: `${item.icon} w-5 h-5 text-center text-lg` }),
                                React.createElement('span', { className: "inline" }, item.label)
                            )
                        ))
                    )
                ),
                // Content
                React.createElement('div', { className: "w-full sm:w-3/4 flex flex-col flex-grow min-h-0" },
                    React.createElement('header', { className: "p-6 sm:p-8 border-b border-border/50 flex justify-between items-center flex-shrink-0" },
                        React.createElement('h3', { className: "text-2xl font-bold text-text capitalize" }, navItems.find(n => n.id === activeTab)?.label),
                        React.createElement('button', { onClick: onClose, className: "p-2 rounded-full hover:bg-hover text-text-subtle hover:text-text" }, React.createElement('i', { className: "fa-solid fa-xmark w-6 h-6" }))
                    ),
                    React.createElement('div', { className: "p-6 sm:p-8 overflow-y-auto flex-grow" },
                        renderTabContent()
                    ),
                    React.createElement('footer', { className: "p-4 bg-hover/50 border-t border-border/50 flex justify-end gap-4 flex-shrink-0" },
                        React.createElement('button', { onClick: onClose, className: "py-2 px-6 rounded-lg text-text font-semibold hover:bg-border transition" }, "Cancelar"),
                        React.createElement('button', { onClick: handleSave, className: "py-2.5 px-6 rounded-lg bg-primary text-dark-text font-semibold hover:bg-primary-dark transition shadow-lg hover:shadow-primary-glow-sm" }, "Guardar Cambios")
                    )
                )
            )
        )
    );
};
// --- END OF FILE: components/modals/SettingsModal.tsx ---

// --- START OF FILE: components/layout/Sidebar.tsx ---
const Sidebar = ({ activePage, onNavItemClick, isCollapsed, onToggleCollapse, isDarkMode, onToggleDarkMode, onLogout, isProUser, onProClick, isMobileMenuOpen }) => {
  const NavItem = ({ item, isActive = false, isCollapsed, isPro, onClick }) => {
    const activeClasses = 'bg-primary/20 text-sidebar-text-strong shadow-lg shadow-primary/20';
    const inactiveClasses = 'text-sidebar-text hover:bg-sidebar-hover hover:text-sidebar-text-strong';

    return (
      React.createElement('li', { className: "px-2" },
        React.createElement('a', {
          href: "#",
          onClick: (e) => {
            e.preventDefault();
            onClick();
          },
          className: `flex items-center rounded-lg transition-all duration-200
            ${ isCollapsed ? "justify-center w-12 h-12" : `py-3 px-4 gap-4` }
            ${ isActive ? activeClasses : inactiveClasses }
          `,
          title: item.name,
          "aria-label": item.name
        },
          React.createElement('div', { className: `flex items-center justify-center flex-shrink-0 ${isCollapsed ? 'w-8' : 'w-6'}` },
             React.createElement('i', { className: `${item.icon} transition-all duration-200 ${isCollapsed ? 'h-6 w-6 text-2xl' : 'h-6 w-6 text-xl'}`, "aria-hidden": "true" })
          ),
          React.createElement('span', { className: `text-base font-semibold transition-all duration-200 ease-in-out ${isCollapsed ? 'opacity-0 w-0' : 'opacity-100 w-auto'}` }, item.name),
           isPro && !isCollapsed && React.createElement('i', { className: "fa-solid fa-crown h-4 w-4 text-yellow-400 ml-auto", "aria-hidden": "true" })
        )
      )
    );
  };
  const secondaryNavActions = [
    { name: isProUser ? 'Eres Pro' : 'Modo Pro', icon: 'fa-solid fa-crown', action: onProClick, isPro: isProUser },
    { name: isDarkMode ? 'Modo Claro' : 'Modo Oscuro', icon: isDarkMode ? 'fa-solid fa-sun' : 'fa-solid fa-moon', action: onToggleDarkMode },
    { name: 'Cerrar Sesión', icon: 'fa-solid fa-right-from-bracket', action: onLogout },
  ];

  return (
    React.createElement('aside', { className: `bg-sidebar backdrop-blur-lg text-white flex flex-col h-screen p-3 fixed lg:relative z-40
      transition-all duration-300 ease-in-out
      w-64
      ${isCollapsed ? 'lg:w-24' : 'lg:w-64'}
      ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0
    ` },
      React.createElement('div', { 
        className: `w-full flex items-center text-sidebar-text hover:text-white focus:outline-none mb-6 pb-4 border-b border-border/20 ${isCollapsed ? 'justify-center' : 'justify-between'}`
      },
        React.createElement('div', { className: `flex items-center gap-3 overflow-hidden ${isCollapsed ? 'w-auto' : 'w-full'}` },
          React.createElement('i', { className: "fa-solid fa-leaf text-4xl text-primary flex-shrink-0 drop-shadow-[0_2px_8px_rgba(16,185,129,0.5)]", "aria-hidden": "true" }),
          React.createElement('span', { className: `sidebar-logo text-2xl font-bold whitespace-nowrap transition-opacity duration-200 gradient-text ${isCollapsed ? 'opacity-0' : 'opacity-100'}` }, "EcoScore")
        ),
        React.createElement('button', { onClick: onToggleCollapse, "aria-label": "Toggle Sidebar", className: "hidden lg:block p-2 rounded-full hover:bg-sidebar-hover" },
          React.createElement('i', { className: `fa-solid fa-chevron-left h-5 w-5 transition-transform duration-300 ${isCollapsed ? 'rotate-180' : 'rotate-0'}`, "aria-hidden": "true" })
        )
      ),

      React.createElement('nav', { className: "flex-grow overflow-y-auto min-h-0" },
        React.createElement('ul', { className: "space-y-2" },
          mainNavItems.map((item) => (
            React.createElement(NavItem, { key: item.name, item: item, isActive: activePage === item.name, isCollapsed: isCollapsed, onClick: () => onNavItemClick(item.name) })
          ))
        )
      ),

      React.createElement('div', null,
        React.createElement('ul', { className: "space-y-2 border-t border-border/20 pt-4" },
          secondaryNavActions.map((item) => (
            React.createElement(NavItem, { key: item.name, item: {name: item.name, icon: item.icon}, isCollapsed: isCollapsed, onClick: item.action, isPro: item.isPro })
          ))
        )
      )
    )
  );
};
// --- END OF FILE: components/layout/Sidebar.tsx ---

// --- START OF FILE: pages/HomePage.tsx ---
const HomePage = () => {
  const { appState } = useAppContext();
  const userPoints = appState.stats.points;

  const RaffleCard = () => {
    const { appState, showToast } = useAppContext();
    const userPoints = appState.stats.points;
    const RAFFLE_REQUIREMENT = 15000;
    const canEnter = userPoints >= RAFFLE_REQUIREMENT;
    const [hasEntered, setHasEntered] = useState(false);

    const handleEnterRaffle = () => {
      if (canEnter && !hasEntered) {
        setHasEntered(true);
        showToast('¡Has ingresado al sorteo! ¡Mucha suerte!', 'success');
      }
    };

    return (
      React.createElement('div', { className: "glass-card p-6 rounded-2xl shadow-lg animate-fade-in border border-secondary/30 relative overflow-hidden group" },
        React.createElement('div', { className: "absolute -top-1/2 -left-1/2 w-[200%] h-[200%] bg-gradient-to-br from-transparent via-secondary/10 to-transparent animate-[pure-rotate_20s_linear_infinite] group-hover:animate-[pure-rotate_10s_linear_infinite]" }),
        
        React.createElement('div', { className: "relative z-10" },
          React.createElement('div', { className: "flex items-center gap-3 mb-4" },
            React.createElement('i', { className: "fa-solid fa-ticket h-6 w-6 text-secondary" }),
            React.createElement('h2', { className: "text-xl font-bold text-text" }, "Sorteos Exclusivos")
          ),

          !canEnter ? (
            React.createElement('div', { className: "text-center p-4 border border-border rounded-lg bg-hover" },
                React.createElement('div', { className: "mx-auto w-12 h-12 rounded-full flex items-center justify-center mb-4" },
                     React.createElement('i', { className: "fa-solid fa-lock text-2xl text-yellow-500" })
                ),
                React.createElement('h3', { className: "font-bold text-text text-lg" }, "Desbloquea los Sorteos"),
                React.createElement('p', { className: "text-sm text-text-subtle my-2" }, `¡Alcanza los ${RAFFLE_REQUIREMENT.toLocaleString()} puntos para participar en sorteos de premios increíbles!`),
                React.createElement('div', { className: "w-full mt-4" },
                    React.createElement(ProgressBar, { current: userPoints, total: RAFFLE_REQUIREMENT }),
                    React.createElement('p', { className: "text-sm text-text-subtle mt-2" }, `${userPoints.toLocaleString()} / ${RAFFLE_REQUIREMENT.toLocaleString()} pts`)
                )
            )
          ) : (
            React.createElement('div', { className: "text-center" },
                React.createElement('div', { className: "rounded-lg mb-4 overflow-hidden shadow-lg" },
                    React.createElement('img', { src: "https://images.unsplash.com/photo-1576426863848-c21f68c6aa88?q=80&w=2070&auto=format&fit=crop", alt: "Bicicleta eléctrica", className: "w-full h-40 object-cover transition-transform duration-500 group-hover:scale-110" })
                ),
                React.createElement('h3', { className: "text-lg font-bold text-secondary" }, "¡Gana una Bicicleta Eléctrica!"),
                React.createElement('p', { className: "text-sm text-text-subtle my-2" }, "Participa en nuestro sorteo mensual y podrías llevarte esta increíble bicicleta para moverte de forma sostenible."),
                React.createElement('p', { className: "text-xs text-text-subtle mb-4" }, "El sorteo finaliza el 30 de Julio."),
                
                React.createElement('button', { 
                  onClick: handleEnterRaffle,
                  disabled: hasEntered,
                  className: "w-full py-3 rounded-lg font-semibold text-dark-text transition disabled:opacity-50 disabled:cursor-not-allowed bg-secondary hover:opacity-90 shadow-lg hover:shadow-secondary/40 transform hover:scale-105"
                },
                  hasEntered ? '¡Participando!' : 'Ingresar al Sorteo'
                )
            )
          )
        )
      )
    );
  };

  const currentLevelIndex = [...LEVELS].reverse().findIndex(level => userPoints >= level.minPoints);
  const currentLevel = LEVELS[LEVELS.length - 1 - currentLevelIndex];
  const nextLevel = LEVELS[LEVELS.length - currentLevelIndex];

  const levelProgress = nextLevel ? {
      current: userPoints,
      start: currentLevel.minPoints,
      total: nextLevel.minPoints,
      nextLevelName: nextLevel.name,
  } : undefined;

  const userLevelName = currentLevel ? currentLevel.name : 'Principiante';
  const isNewUser = appState.history.length < 5;
  
  return (
    React.createElement('div', { className: "grid grid-cols-1 lg:grid-cols-3 gap-8" },
        React.createElement('div', { className: "lg:col-span-2 space-y-8" },
            React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-6" },
                React.createElement(StatCard, { 
                  title: "Puntos Acumulados", 
                  value: userPoints.toLocaleString(), 
                  subtitle: "totales", 
                  badge: userLevelName, 
                  icon: 'fa-solid fa-coins', 
                  progress: levelProgress
                }),
                React.createElement(StatCard, { title: "Impacto Ambiental", value: appState.stats.impact, subtitle: "kg CO2 reducido", icon: 'fa-solid fa-leaf' }),
                React.createElement(StatCard, { title: "Reciclaje Semanal", value: appState.stats.recycling, subtitle: "productos", icon: 'fa-solid fa-recycle' }),
                React.createElement(StatCard, { title: "Racha Máxima", value: appState.streak.longest, subtitle: "días", icon: 'fa-solid fa-medal', valueColor: "text-secondary" })
            ),
            React.createElement('div', { className: "bg-card p-6 rounded-xl shadow-sm" },
                React.createElement('div', { className: "flex items-center gap-3 mb-4" }, React.createElement('i', { className: "fa-solid fa-flag h-6 w-6 text-text-subtle" }), React.createElement('h2', { className: "text-xl font-bold text-text" }, "Misiones Semanales")),
                React.createElement('div', null,
                  appState.missions.length > 0 ? (
                      appState.missions.map((m, i) => React.createElement(MissionItem, { key: m.id, mission: m, index: i }))
                  ) : (
                      React.createElement(EmptyState, { 
                          icon: isNewUser ? "fa-solid fa-rocket" : "fa-solid fa-check-double",
                          title: isNewUser ? "¡Bienvenido a EcoScore!" : "¡Misiones completadas!",
                          description: isNewUser 
                              ? "Tus primeras misiones aparecerán aquí muy pronto. ¡Comienza explorando la sección de Educación para empezar a ganar puntos!" 
                              : "¡Felicidades! Has completado todas las misiones de esta semana. Vuelve pronto para nuevos desafíos."
                      })
                  )
                )
            )
        ),

        React.createElement('div', { className: "space-y-8" },
            React.createElement(StreakTracker, { currentStreak: appState.streak.current }),
            React.createElement('div', { className: "bg-card p-6 rounded-xl shadow-sm" },
                React.createElement('div', { className: "flex items-center gap-3 mb-4" }, React.createElement('i', { className: "fa-solid fa-clock-rotate-left h-6 w-6 text-text-subtle" }), React.createElement('h2', { className: "text-xl font-bold text-text" }, "Historial Reciente")),
                React.createElement('div', null, appState.history.slice(0, 5).map((item, i) => React.createElement(HistoryLogItem, { key: item.id, item: item, index: i })))
            ),
            React.createElement(RaffleCard, null)
        )
    )
  );
};
// --- END OF FILE: pages/HomePage.tsx ---

// --- START OF FILE: pages/LoginPage.tsx ---
const LoginPage = ({ onLogin }) => {
    const [view, setView] = useState('login');
    const [isLoading, setIsLoading] = useState(false);
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');

    const handleFormSubmit = (e) => {
        e.preventDefault();
        if (isLoading) return;
        
        setError('');
        setIsLoading(true);

        setTimeout(() => {
            if (view === 'login') {
                if (email.trim() === 'usuario123@gmail.com' && password === 'prueba123') {
                    const testUser = {
                        name: 'Usuario Prueba',
                        initials: 'UP',
                        location: 'Lima, Perú',
                        level: 'Eco Novato',
                        avatarId: 'avatar-default',
                        frameId: 'frame-none',
                        profileTitleId: 'title-novice',
                        displayedBadges: [],
                    };
                    onLogin(testUser);
                } else {
                    setError('Correo electrónico o contraseña incorrectos.');
                    setIsLoading(false);
                }
            } else {
                onLogin();
            }
        }, 1500);
    };

    const commonInputClasses = "w-full pl-12 pr-4 py-3 border-2 border-slate-200 dark:border-slate-700/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-slate-100 dark:bg-slate-700/50 text-text transition-shadow focus:shadow-lg disabled:opacity-50";
    const commonIconClasses = "fa-solid absolute left-4 top-1/2 -translate-y-1/2 text-text-subtle";

    const renderActiveView = () => {
        switch (view) {
            case 'login':
                return (
                    React.createElement('div', { key: "login", className: "animate-fade-in" },
                        React.createElement('h2', { className: "text-3xl font-bold text-center text-text mb-2" }, "Iniciar Sesión"),
                        React.createElement('p', { className: "text-center text-xs text-text-subtle mb-4" }, "Demo: ", React.createElement('span', { className: "font-semibold" }, "usuario123@gmail.com"), " / ", React.createElement('span', { className: "font-semibold" }, "prueba123")),
                        React.createElement('form', { className: "space-y-4", onSubmit: handleFormSubmit },
                            React.createElement('div', { className: "relative" },
                                React.createElement('i', { className: `${commonIconClasses} fa-envelope` }),
                                React.createElement('input', { className: commonInputClasses, type: "email", placeholder: "Correo Electrónico", disabled: isLoading, value: email, onChange: (e) => setEmail(e.target.value) })
                            ),
                            React.createElement('div', { className: "relative" },
                                React.createElement('i', { className: `${commonIconClasses} fa-lock` }),
                                React.createElement('input', { className: commonInputClasses, type: "password", placeholder: "Contraseña", disabled: isLoading, value: password, onChange: (e) => setPassword(e.target.value) })
                            ),
                            error && React.createElement('p', { className: "text-red-500 text-sm animate-shake text-center" }, error),
                            React.createElement('button', { type: "submit", disabled: isLoading, className: "w-full py-3 text-dark-text bg-primary rounded-lg font-semibold hover:bg-primary-dark transition-all flex items-center justify-center disabled:opacity-70 h-12 shadow-lg hover:shadow-primary-glow-md transform hover:scale-105" },
                                isLoading ? React.createElement('i', { className: "fa-solid fa-spinner animate-spin w-5 h-5" }) : 'Entrar'
                            )
                        ),
                        React.createElement('div', { className: "flex items-center justify-between text-sm mt-4" },
                            React.createElement('button', { onClick: () => setView('forgot'), className: "font-medium text-primary hover:underline" }, "¿Olvidaste tu contraseña?"),
                            React.createElement('button', { onClick: () => setView('register'), className: "font-medium text-primary hover:underline" }, "Crear cuenta")
                        )
                    )
                );
            case 'register':
                return (
                    React.createElement('div', { key: "register", className: "animate-fade-in" },
                        React.createElement('h2', { className: "text-3xl font-bold text-center text-text mb-6" }, "Crear Cuenta"),
                        React.createElement('form', { className: "space-y-4", onSubmit: handleFormSubmit },
                            React.createElement('div', { className: "relative" }, React.createElement('i', { className: `${commonIconClasses} fa-user` }), React.createElement('input', { className: commonInputClasses, type: "text", placeholder: "Nombre Completo", required: true, disabled: isLoading })),
                            React.createElement('div', { className: "relative" }, React.createElement('i', { className: `${commonIconClasses} fa-envelope` }), React.createElement('input', { className: commonInputClasses, type: "email", placeholder: "Correo Electrónico", required: true, disabled: isLoading })),
                            React.createElement('div', { className: "relative" }, React.createElement('i', { className: `${commonIconClasses} fa-lock` }), React.createElement('input', { className: commonInputClasses, type: "password", placeholder: "Contraseña", required: true, disabled: isLoading })),
                            React.createElement('button', { type: "submit", disabled: isLoading, className: "w-full py-3 text-dark-text bg-primary rounded-lg font-semibold hover:bg-primary-dark transition-all flex items-center justify-center disabled:opacity-70 h-12 shadow-lg hover:shadow-primary-glow-md transform hover:scale-105" },
                                isLoading ? React.createElement('i', { className: "fa-solid fa-spinner animate-spin w-5 h-5" }) : 'Registrarse'
                            )
                        ),
                        React.createElement('div', { className: "text-center text-sm mt-4" }, React.createElement('span', { className: "text-text-subtle" }, "¿Ya tienes cuenta? "), React.createElement('button', { onClick: () => setView('login'), className: "font-medium text-primary hover:underline" }, "Inicia Sesión"))
                    )
                );
            case 'forgot':
                return (
                    React.createElement('div', { key: "forgot", className: "animate-fade-in" },
                        React.createElement('h2', { className: "text-3xl font-bold text-center text-text mb-4" }, "Recuperar Contraseña"),
                        React.createElement('p', { className: "text-center text-text-subtle mb-6 text-sm" }, "Ingresa tu correo y te enviaremos un enlace para restablecer tu contraseña."),
                        React.createElement('form', { className: "space-y-4", onSubmit: handleFormSubmit },
                            React.createElement('div', { className: "relative" }, React.createElement('i', { className: `${commonIconClasses} fa-envelope` }), React.createElement('input', { className: commonInputClasses, type: "email", placeholder: "Correo Electrónico", required: true, disabled: isLoading })),
                            React.createElement('button', { type: "submit", disabled: isLoading, className: "w-full py-3 text-dark-text bg-primary rounded-lg font-semibold hover:bg-primary-dark transition-all flex items-center justify-center disabled:opacity-70 h-12 shadow-lg hover:shadow-primary-glow-md transform hover:scale-105" },
                                isLoading ? React.createElement('i', { className: "fa-solid fa-spinner animate-spin w-5 h-5" }) : 'Enviar Enlace'
                            )
                        ),
                        React.createElement('div', { className: "text-center text-sm mt-4" }, React.createElement('button', { onClick: () => setView('login'), className: "font-medium text-primary hover:underline" }, "Volver a Iniciar Sesión"))
                    )
                );
            default:
                return null;
        }
    };
    
    return (
        React.createElement('div', { className: "flex items-center justify-center min-h-screen bg-background p-4 aurora-bg" },
            React.createElement('div', { className: "w-full max-w-md animate-fade-in-down" },
                React.createElement('div', { className: "text-center mb-8" },
                    React.createElement('i', { className: "fa-solid fa-leaf text-6xl text-primary mb-4 drop-shadow-[0_4px_15px_rgba(16,185,129,0.4)]", "aria-hidden": "true" }),
                    React.createElement('h1', { className: "text-4xl font-extrabold gradient-text" }, "EcoScore"),
                    React.createElement('p', { className: "text-text-subtle mt-2 font-semibold" }, "Tu comunidad para un mundo más verde.")
                ),

                React.createElement('div', { className: "bg-white dark:bg-slate-800/80 backdrop-blur-md rounded-2xl shadow-xl p-8 w-full" },
                    renderActiveView()
                ),

                 React.createElement('div', { className: "text-center mt-8" },
                    React.createElement('div', { className: "relative my-2" },
                        React.createElement('div', { className: "absolute inset-0 flex items-center" }, React.createElement('div', { className: "w-full border-t border-border/50" })),
                        React.createElement('div', { className: "relative flex justify-center text-sm" }, React.createElement('span', { className: "px-2 bg-background text-text-subtle" }, "O inicia sesión con"))
                    ),
                    React.createElement('div', { className: "flex justify-center space-x-4 mt-4" },
                        React.createElement('button', { "aria-label": "Login with Google", onClick: () => onLogin(), className: "w-12 h-12 flex items-center justify-center border-2 border-border/80 rounded-full hover:bg-hover hover:border-primary transition-colors hover:text-primary" }, React.createElement('i', { className: "fa-brands fa-google text-xl" })),
                        React.createElement('button', { "aria-label": "Login with Facebook", onClick: () => onLogin(), className: "w-12 h-12 flex items-center justify-center border-2 border-border/80 rounded-full hover:bg-hover hover:border-primary transition-colors hover:text-primary" }, React.createElement('i', { className: "fa-brands fa-facebook text-xl" })),
                        React.createElement('button', { "aria-label": "Login with Apple", onClick: () => onLogin(), className: "w-12 h-12 flex items-center justify-center border-2 border-border/80 rounded-full hover:bg-hover hover:border-primary transition-colors hover:text-primary" }, React.createElement('i', { className: "fa-brands fa-apple text-xl" }))
                    )
                )
            )
        )
    );
};
// --- END OF FILE: pages/LoginPage.tsx ---

// --- START OF FILE: pages/EducationPage.tsx ---
const EducationPage = () => {
    const LearningPathCard = ({ path, onSelect, index }) => {
        const progress = path.steps.filter(s => s.status === 'completed').length / path.steps.length * 100;
        
        return (
            React.createElement('div', { onClick: onSelect, className: "glass-card rounded-2xl overflow-hidden flex flex-col transition-all duration-300 hover:-translate-y-2 hover:shadow-2xl animate-stagger-in cursor-pointer", style: { animationDelay: `${index * 80}ms` } },
                React.createElement('div', { className: `flex items-center justify-center h-48 relative bg-white dark:bg-slate-900` },
                    React.createElement('i', { className: `${path.icon} text-7xl text-slate-900 dark:text-primary drop-shadow-lg`, "aria-hidden": "true" })
                ),
                React.createElement('div', { className: "p-6 flex flex-col flex-grow" },
                    React.createElement('h3', { className: "text-xl font-bold text-text" }, path.title),
                    React.createElement('p', { className: "text-sm text-text-subtle mt-1 mb-4 flex-grow" }, path.description),
                     React.createElement('div', { className: "w-full bg-black/20 rounded-full h-3 shadow-inner mb-2" },
                        React.createElement('div', { className: "bg-gradient-to-r from-primary-light to-primary h-3 rounded-full", style: {width: `${progress}%`} })
                    ),
                    React.createElement('p', { className: "text-xs text-text-subtle font-semibold" }, `${Math.round(progress)}% completado`)
                )
            )
        );
    };

    const PathDetailView = ({ path, onBack }) => {
        const { completeLearningStep, setActiveGame, appState, showToast, isProUser, onProClick } = useAppContext();
        const [viewingLesson, setViewingLesson] = useState(null);

        const handleStepClick = (step) => {
            if (step.status === 'locked') {
                showToast('Completa los pasos anteriores para desbloquear este.', 'info');
                return;
            }

            let item = null;
            if (step.type === 'lesson') {
                item = lessons.find(l => l.id === step.itemId) || null;
            } else if (step.type === 'game') {
                item = appState.games.find(g => g.id === step.itemId) || null;
            }
        
            if (item?.isPro && !isProUser) {
                onProClick();
                return;
            }
        
            if (step.type === 'lesson' && item) {
                setViewingLesson({ lesson: item, step });
                return;
            }
        
            if (step.status === 'completed') {
                showToast('Ya has completado este paso.', 'info');
                return;
            }
        
            switch (step.type) {
                case 'game':
                    if (item) {
                        const gameWithContext = { ...item, learningPathContext: { pathId: path.id, stepId: step.id } };
                        setActiveGame(gameWithContext);
                    }
                    break;
                case 'mission':
                    const mission = appState.missions.find(m => m.id === step.itemId);
                    if (mission && mission.progress && mission.progress.current >= mission.progress.total) {
                        completeLearningStep(path.id, step.id);
                    } else {
                        showToast('Completa esta misión desde la página de Inicio para avanzar.', 'info');
                    }
                    break;
            }
        };
        
        const handleCompleteLesson = (pathId, stepId) => {
            const step = path.steps.find(s => s.id === stepId);
            if (step && step.status !== 'completed') {
                completeLearningStep(pathId, stepId);
            }
        };

        const getStepIcon = (type) => {
            switch(type) {
                case 'lesson': return 'fa-solid fa-book-open-reader';
                case 'game': return 'fa-solid fa-gamepad';
                case 'mission': return 'fa-solid fa-flag-checkered';
            }
        };

        const getStepStatusClasses = (status) => {
             switch(status) {
                case 'completed': return {
                    dot: 'bg-primary border-primary-light',
                    line: 'bg-gradient-to-b from-primary to-primary-light',
                    card: 'border-primary/30'
                };
                case 'available': return {
                    dot: 'bg-card border-primary ring-2 ring-primary',
                    line: 'bg-border',
                    card: 'border-primary/70'
                };
                case 'locked': return {
                    dot: 'bg-hover border-border',
                    line: 'bg-border',
                    card: 'border-transparent'
                };
            }
        };
        
        return (
            React.createElement('div', { className: "animate-fade-in" },
                React.createElement('button', { onClick: onBack, className: "flex items-center gap-2 text-text-subtle font-semibold mb-8 hover:text-primary transition-colors" },
                    React.createElement('i', { className: "fa-solid fa-arrow-left" }), " Volver a las Rutas"
                ),
                React.createElement('div', { className: "glass-card p-6 sm:p-8 rounded-2xl shadow-sm" },
                     React.createElement('h3', { className: "text-3xl font-bold text-text mb-2" }, path.title),
                     React.createElement('p', { className: "text-text-subtle mb-8 max-w-2xl" }, path.description),
                     React.createElement('div', { className: "mt-8" },
                        path.steps.map((step, index) => {
                            const lesson = step.type === 'lesson' ? lessons.find(l => l.id === step.itemId) : null;
                            const game = step.type === 'game' ? appState.games.find(g => g.id === step.itemId) : null;
                            const isProContent = (lesson?.isPro || game?.isPro);
                            const isLockedByPro = isProContent && !isProUser;
                            const statusClasses = getStepStatusClasses(step.status);

                            return (
                                 React.createElement('div', { key: step.id, className: "relative pl-12 pb-10 last:pb-0" },
                                    index < path.steps.length - 1 && 
                                        React.createElement('div', { className: `absolute left-[11px] top-4 h-full w-0.5 ${statusClasses.line}` }),
                                    React.createElement('div', { className: `absolute left-0 top-1 w-6 h-6 rounded-full flex items-center justify-center border-2 z-10 transition-all duration-300 ${statusClasses.dot}` },
                                        step.status === 'completed' && React.createElement('i', { className: "fa-solid fa-check text-white text-xs" })
                                    ),
                                    React.createElement('div', { className: `bg-card/50 p-4 sm:p-5 rounded-xl border-2 ${statusClasses.card} transition-all duration-300 ${step.status === 'locked' ? 'opacity-70' : 'hover:shadow-lg hover:-translate-y-1'}` },
                                        React.createElement('div', { className: "flex flex-col sm:flex-row sm:items-center sm:justify-between" },
                                            React.createElement('div', { className: "flex items-center gap-4 mb-3 sm:mb-0" },
                                                React.createElement('div', { className: `w-12 h-12 rounded-lg flex items-center justify-center flex-shrink-0 bg-primary/20` },
                                                    React.createElement('i', { className: `${getStepIcon(step.type)} text-2xl text-primary` })
                                                ),
                                                React.createElement('div', null,
                                                    React.createElement('h4', { className: "font-bold text-text" }, step.title),
                                                    React.createElement('p', { className: "text-sm text-text-subtle max-w-md" }, step.description)
                                                )
                                            ),
                                            React.createElement('div', { className: "flex items-center gap-4 self-end sm:self-center ml-auto pl-4" },
                                                React.createElement('span', { className: "text-sm font-bold text-primary whitespace-nowrap" }, `+${step.points} pts`),
                                                React.createElement('button', {
                                                    onClick: () => handleStepClick(step),
                                                    disabled: step.status === 'locked',
                                                    className: `px-4 py-2 w-36 text-center rounded-lg text-sm font-semibold transition-all flex items-center justify-center gap-2 transform hover:scale-105
                                                        ${step.status === 'locked' ? 'bg-hover text-text-subtle cursor-not-allowed' :
                                                        (isLockedByPro ? 'bg-warning text-dark-text hover:opacity-90 shadow-lg' : 
                                                        (step.status === 'completed' ? 'bg-primary/20 text-primary' : 'bg-primary text-dark-text hover:bg-primary-dark shadow-lg hover:shadow-primary-glow-sm'))
                                                    }`
                                                },
                                                    React.createElement('span', null,
                                                        isLockedByPro ? 'Requiere Pro' :
                                                        (step.status === 'completed' ? (step.type === 'lesson' ? 'Repasar' : 'Completado') : 'Empezar')
                                                    )
                                                )
                                            )
                                        ),
                                        isLockedByPro && step.status !== 'completed' &&
                                            React.createElement('p', { className: "text-xs text-secondary font-semibold mt-3 text-right" },
                                                "Requiere suscripción Pro para acceder."
                                            )
                                    )
                                )
                            );
                        })
                     ),
                     path.isCompleted && (
                        React.createElement('div', { className: "mt-8 p-4 bg-primary/20 text-center rounded-lg border-2 border-primary/50" },
                            React.createElement('i', { className: "fa-solid fa-trophy w-8 h-8 text-yellow-400 mb-2 drop-shadow-lg" }),
                            React.createElement('h4', { className: "font-bold text-primary" }, "¡Ruta Completada!"),
                            React.createElement('p', { className: "text-sm text-primary/80" }, `Has ganado ${path.rewardPoints} puntos de recompensa y un nuevo logro.`)
                        )
                     )
                ),
                 viewingLesson && (
                    React.createElement(LessonModal, {
                        lesson: viewingLesson.lesson,
                        isCompleted: viewingLesson.step.status === 'completed',
                        onClose: () => setViewingLesson(null),
                        onComplete: () => handleCompleteLesson(path.id, viewingLesson.step.id)
                    })
                )
            )
        );
    };

    const { appState, completeLearningStep } = useAppContext();
    const [selectedPath, setSelectedPath] = useState(null);

    useEffect(() => {
        appState.learningPaths.forEach(path => {
            path.steps.forEach((step) => {
                if (step.type === 'mission' && step.status === 'available') {
                    const mission = appState.missions.find(m => m.id === step.itemId);
                    const isOneOffMissionCompleted = !mission;
                    const isProgressMissionCompleted = mission?.progress && mission.progress.current >= mission.progress.total;

                    if (isOneOffMissionCompleted || isProgressMissionCompleted) {
                        completeLearningStep(path.id, step.id);
                    }
                }
            });
        });
    }, [appState.learningPaths, appState.missions, completeLearningStep]);


    if(selectedPath) {
        const currentPathData = appState.learningPaths.find(p => p.id === selectedPath.id) || selectedPath;
        return React.createElement(PathDetailView, { path: currentPathData, onBack: () => setSelectedPath(null) });
    }

    return (
        React.createElement(React.Fragment, null,
            React.createElement('header', { className: "mb-8" },
                React.createElement('h2', { className: "text-3xl font-bold text-text mb-2" }, "Rutas de Aprendizaje"),
                React.createElement('p', { className: "text-text-subtle" }, "Sigue un camino de aprendizaje, completa desafíos y conviértete en un experto en sostenibilidad.")
            ),
            
            React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8" },
                appState.learningPaths.map((p, i) => (
                    React.createElement(LearningPathCard, { key: p.id, path: p, onSelect: () => setSelectedPath(p), index: i })
                ))
            )
        )
    );
};
// --- END OF FILE: pages/EducationPage.tsx ---

// --- START OF FILE: pages/MinigamesPage.tsx ---
const MinigamesPage = () => {
    const { isProUser, onProClick, consumeEnergy, appState, setActiveGame, showToast } = useAppContext();
    const { energy, games, lastEnergyRecharge } = appState;
    const [countdown, setCountdown] = useState('');
    const maxEnergy = isProUser ? 10 : 5;

    useEffect(() => {
        let timerInterval = null;
        const ENERGY_RECHARGE_RATE = 15 * 60 * 1000;

        const updateTimer = () => {
            if(appState.energy >= maxEnergy) {
                setCountdown('');
                if(timerInterval) clearInterval(timerInterval);
                return;
            }

            const nextRechargeTime = appState.lastEnergyRecharge + ENERGY_RECHARGE_RATE;
            const remainingTime = nextRechargeTime - Date.now();

            if (remainingTime > 0) {
                const minutes = Math.floor(remainingTime / (1000 * 60));
                const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
                setCountdown(`${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`);
            } else {
                setCountdown('Recargando...');
            }
        };

        updateTimer();
        timerInterval = window.setInterval(updateTimer, 1000);

        return () => {
            if (timerInterval) clearInterval(timerInterval);
        };
    }, [appState.energy, appState.lastEnergyRecharge, maxEnergy]);

    const handleGameClick = (game) => {
        if (game.isPro && !isProUser) {
            onProClick();
            return;
        }
        consumeEnergy((success) => {
            if (success) {
                setActiveGame(game);
            } else {
                showToast("¡No tienes suficiente energía!", "error");
            }
        });
    };
    
    return (
        React.createElement(React.Fragment, null,
            React.createElement('h2', { className: "text-2xl font-bold text-text mb-2" }, "Centro de Minijuegos"),
            React.createElement('p', { className: "text-text-subtle mb-8" }, `Diviértete, aprende y gana puntos. ¡Tienes ${energy} intentos!`),
            React.createElement('div', { className: "bg-card p-6 rounded-xl shadow-sm mb-8 flex items-center justify-between" },
                React.createElement('div', { className: "flex items-center gap-3" },
                    React.createElement('i', { className: "fa-solid fa-bolt text-4xl text-yellow-500" }),
                    React.createElement('div', null,
                        React.createElement('h3', { className: "text-lg font-bold text-text" }, "Tu Energía"),
                        React.createElement('p', { className: "text-sm text-text-subtle" },
                            energy < maxEnergy && countdown ? `Próxima en ${countdown}` : 'Energía al máximo'
                        )
                    )
                ),
                React.createElement('div', { className: "flex items-center gap-2" },
                    [...Array(maxEnergy)].map((_, i) => (
                        React.createElement('i', { key: i, className: `fa-solid fa-bolt text-2xl transition-colors ${i < energy ? 'text-yellow-400' : 'text-border'}` })
                    ))
                )
            ),
            React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8" },
                games.map((g, i) => React.createElement(GameCard, { key: g.id, game: g, index: i, isProUser: isProUser, onGameClick: () => handleGameClick(g) }))
            )
        )
    );
};
// --- END OF FILE: pages/MinigamesPage.tsx ---

// --- START OF FILE: pages/ProfilePage.tsx ---
const ProfilePage = ({ onSettingsClick }) => {
    const BadgesDisplay = ({ badgeIds }) => {
        const { appState } = useAppContext();
        const badges = (badgeIds || []).map(id => appState.achievements.find(a => a.id === id)).filter(Boolean);

        if (badges.length === 0) {
            return React.createElement('p', { className: "text-sm text-text-subtle mt-4 text-center md:text-left" }, "No hay insignias para mostrar. ¡Ve a la pestaña Logros para seleccionar tus favoritas!");
        }

        return (
            React.createElement('div', { className: "flex items-center justify-center md:justify-start gap-3 mt-4" },
                badges.map(badge => (
                    React.createElement('div', { key: badge.id, className: "group relative" },
                        React.createElement('div', { className: "w-10 h-10 rounded-full flex items-center justify-center bg-primary/10", role: "img", "aria-label": badge.name },
                            React.createElement('i', { className: `${badge.icon} text-xl text-primary`, "aria-hidden": "true" })
                        ),
                         React.createElement('div', { className: "absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-max bg-card text-text-subtle text-xs rounded py-1 px-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none shadow-lg border border-border z-10", "aria-hidden": "true" },
                            badge.name
                        )
                    )
                ))
            )
        );
    };

    const ImpactChart = () => {
        const impactData = [
            { month: 'Ene', co2: 12 }, { month: 'Feb', co2: 18 },
            { month: 'Mar', co2: 25 }, { month: 'Abr', co2: 22 },
            { month: 'May', co2: 30 }, { month: 'Jun', co2: 45 },
        ];
        const maxCo2 = Math.max(...impactData.map(d => d.co2), 0) * 1.1;
        return (
            React.createElement('div', { className: "animate-fade-in" },
                React.createElement('h3', { className: "text-xl font-bold mb-2" }, "Impacto Ambiental (CO2 Reducido)"),
                React.createElement('p', { className: "text-text-subtle mb-8" }, "Tu progreso en los últimos 6 meses."),
                React.createElement('div', { className: "w-full h-64 sm:h-80 bg-hover p-4 rounded-lg flex items-end justify-around gap-2", "aria-label": "Gráfico de barras del impacto ambiental" },
                    impactData.map(data => (
                        React.createElement('div', { key: data.month, className: "flex flex-col items-center flex-grow h-full justify-end" },
                            React.createElement('div', { className: "w-full h-full flex items-end justify-center group" },
                                React.createElement('div', {
                                    className: "w-3/4 bg-primary rounded-t-md hover:opacity-80 transition-all duration-300 relative",
                                    style: { height: `${(data.co2 / (maxCo2 || 1)) * 100}%` },
                                    role: "progressbar",
                                    "aria-valuenow": data.co2,
                                    "aria-valuemin": 0,
                                    "aria-valuemax": maxCo2,
                                    "aria-label": `${data.co2} kg de CO2 reducido en ${data.month}`
                                },
                                    React.createElement('div', { className: "absolute -top-7 left-1/2 -translate-x-1/2 bg-gray-900 text-white text-xs rounded py-1 px-2 opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap", "aria-hidden": "true" },
                                        `${data.co2} kg`
                                    )
                                )
                            ),
                            React.createElement('span', { className: "mt-2 text-sm font-semibold text-text-subtle" }, data.month)
                        )
                    ))
                )
            )
        );
    }

    const AchievementsList = () => {
        const { appState, user, selectBadge } = useAppContext();
        const { achievements } = appState;
        const displayedBadges = user.displayedBadges || [];

        const groupedAchievements = [...achievements].sort((a,b) => (a.isUnlocked === b.isUnlocked) ? 0 : a.isUnlocked ? -1 : 1)
        .reduce((acc, ach) => {
            const diff = ach.difficulty;
            if (!acc[diff]) acc[diff] = [];
            acc[diff].push(ach);
            return acc;
        }, {});

        const difficultyOrder = ['Fácil', 'Intermedio', 'Difícil', 'Experto'];
        const difficultyColors = {
            'Fácil': 'border-green-500', 'Intermedio': 'border-blue-500',
            'Difícil': 'border-purple-500', 'Experto': 'border-yellow-500',
        };

        return (
            React.createElement('div', { className: "animate-fade-in space-y-8" },
                React.createElement('div', { className: "bg-primary/10 p-4 rounded-lg text-center text-primary-dark dark:text-primary" },
                    React.createElement('i', { className: "fa-solid fa-info-circle mr-2" }),
                    displayedBadges.length < 3 ? `Puedes seleccionar ${3 - displayedBadges.length} insignia(s) más para mostrar en tu perfil.` : 'Has alcanzado el máximo de 3 insignias.'
                ),
                difficultyOrder.map(difficulty => (
                    groupedAchievements[difficulty] && (
                        React.createElement('div', { key: difficulty },
                            React.createElement('h3', { className: `text-xl font-bold mb-4 border-l-4 pl-3 ${difficultyColors[difficulty]}` }, difficulty),
                            React.createElement('div', { className: "grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4" },
                                groupedAchievements[difficulty].map((a, i) => (
                                    React.createElement(AchievementCard, { key: a.id, ach: a, index: i, isSelected: displayedBadges.includes(a.id), onSelect: selectBadge })
                                ))
                            )
                        )
                    )
                ))
            )
        );
    };

    const FullHistory = () => {
        const { appState } = useAppContext();
        const [visibleCount, setVisibleCount] = useState(10);

        const handleLoadMore = () => {
            setVisibleCount(prev => prev + 10);
        };

        const history = appState.history;

        return (
            React.createElement('div', { className: "animate-fade-in" },
                React.createElement('h3', { className: "text-xl font-bold mb-4" }, "Historial Completo"),
                history.length > 0 ? (
                    React.createElement('div', null,
                        React.createElement('div', null, history.slice(0, visibleCount).map((item, i) => React.createElement(HistoryLogItem, { key: item.id, item: item, index: i }))),
                        visibleCount < history.length && (
                            React.createElement('div', { className: "text-center mt-6" },
                                React.createElement('button', { 
                                    onClick: handleLoadMore, 
                                    className: "px-6 py-2 rounded-lg bg-hover text-text font-semibold hover:bg-border transition"
                                },
                                    "Cargar más"
                                )
                            )
                        )
                    )
                ) : (
                    React.createElement(EmptyState, {
                        icon: "fa-solid fa-clock-rotate-left",
                        title: "Aún no hay historial",
                        description: "Tu historial de actividades aparecerá aquí una vez que empieces a interactuar con la aplicación."
                    })
                )
            )
        );
    };

    const CustomizationView = () => {
        const { user, onUserUpdate, appState, showToast, isProUser } = useAppContext();
        const [customizationTab, setCustomizationTab] = useState('avatars');

        const handleEquip = (item, type) => {
            const updatedUser = { ...user };
            if (type === 'avatar') updatedUser.avatarId = item.id;
            if (type === 'frame') updatedUser.avatarFrameId = item.id;
            if (type === 'title') updatedUser.profileTitleId = item.id;
            onUserUpdate(updatedUser);
            showToast(`"${item.name}" equipado.`, 'success');
        };

        const renderCustomizationContent = () => {
            let items = [];
            let type = 'avatar';
            let equippedId = '';

            switch (customizationTab) {
                case 'avatars':
                    items = allAvatars.filter(a => appState.unlockedAvatars.includes(a.id));
                    type = 'avatar';
                    equippedId = user.avatarId;
                    break;
                case 'frames':
                    items = allAvatarFrames.filter(f => appState.unlockedAvatarFrames.includes(f.id));
                    type = 'frame';
                    equippedId = user.avatarFrameId;
                    break;
                case 'titles':
                    items = allProfileTitles.filter(t => appState.unlockedProfileTitles.includes(t.id));
                    type = 'title';
                    equippedId = user.profileTitleId;
                    break;
            }

            if (items.length === 0) {
                return (
                    React.createElement('div', { className: "text-center py-10 text-text-subtle animate-fade-in" },
                        React.createElement('p', null, "No tienes artículos en esta categoría."),
                        React.createElement('p', { className: "text-sm" }, "¡Visita la tienda para conseguir más!")
                    )
                );
            }

            return (
                React.createElement('div', { className: "grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6 animate-fade-in" },
                    items.map((item, i) => (
                        React.createElement(CustomizationItemCard, {
                            key: item.id,
                            item: item,
                            type: type,
                            isOwned: true,
                            isEquipped: equippedId === item.id,
                            onBuy: () => {}, // Not used here
                            onEquip: handleEquip,
                            userPoints: appState.stats.points,
                            isProUser: isProUser,
                            index: i
                        })
                    ))
                )
            );
        };
        
        return (
            React.createElement('div', { className: "animate-fade-in" },
                 React.createElement('div', { className: "flex bg-hover rounded-lg p-1 mb-6" },
                    React.createElement('button', { onClick: () => setCustomizationTab('avatars'), className: `flex-1 py-2 px-4 text-center rounded-md font-semibold transition text-sm ${customizationTab === 'avatars' ? 'bg-card shadow text-primary' : 'text-text-subtle'}` }, "Avatares"),
                    React.createElement('button', { onClick: () => setCustomizationTab('frames'), className: `flex-1 py-2 px-4 text-center rounded-md font-semibold transition text-sm ${customizationTab === 'frames' ? 'bg-card shadow text-primary' : 'text-text-subtle'}` }, "Marcos"),
                    React.createElement('button', { onClick: () => setCustomizationTab('titles'), className: `flex-1 py-2 px-4 text-center rounded-md font-semibold transition text-sm ${customizationTab === 'titles' ? 'bg-card shadow text-primary' : 'text-text-subtle'}` }, "Títulos")
                ),
                renderCustomizationContent()
            )
        );
    };

    const { user, appState } = useAppContext();
    const [activeTab, setActiveTab] = useState('logros');

    const equippedTitle = allProfileTitles.find(t => t.id === user.profileTitleId)?.name || 'Eco Novato';
    
    const renderTabContent = () => {
        switch (activeTab) {
            case 'impacto': return React.createElement(ImpactChart, null);
            case 'logros': return React.createElement(AchievementsList, null);
            case 'historial': return React.createElement(FullHistory, null);
            case 'personalizacion': return React.createElement(CustomizationView, null);
            default: return null;
        }
    };
    
    return (
        React.createElement(React.Fragment, null,
            React.createElement('div', { className: "glass-card p-6 sm:p-8 rounded-2xl shadow-sm mb-8 flex flex-col md:flex-row items-center gap-8" },
                React.createElement(AvatarDisplay, { avatarId: user.avatarId, frameId: user.avatarFrameId, sizeClass: "w-32 h-32", iconSizeClass: "text-6xl" }),
                React.createElement('div', { className: "flex-grow text-center md:text-left" },
                    React.createElement('h2', { className: "text-4xl font-bold text-text" }, user.name),
                    React.createElement('p', { className: "text-secondary font-semibold text-lg" }, equippedTitle),
                    
                    React.createElement('div', { className: "mt-4 border-t border-b border-border/50 py-4 flex items-center justify-center md:justify-start gap-x-6 gap-y-2 flex-wrap" },
                        React.createElement('div', { className: "text-center md:text-left" },
                            React.createElement('p', { className: "text-2xl font-bold text-primary" }, appState.stats.points.toLocaleString()),
                            React.createElement('p', { className: "text-xs text-text-subtle uppercase font-semibold" }, "Puntos")
                        ),
                        React.createElement('div', { className: "text-center md:text-left" },
                            React.createElement('p', { className: "text-2xl font-bold text-orange-500 flex items-center gap-1 justify-center md:justify-start" }, appState.streak.current, " ", React.createElement('i', { className: "fa-solid fa-fire" })),
                            React.createElement('p', { className: "text-xs text-text-subtle uppercase font-semibold" }, "Racha")
                        ),
                        React.createElement('div', { className: "text-center md:text-left" },
                            React.createElement('p', { className: "text-2xl font-bold text-primary" }, appState.stats.impact, " ", React.createElement('span', { className: "text-base font-normal" }, "kg")),
                            React.createElement('p', { className: "text-xs text-text-subtle uppercase font-semibold" }, "CO2 Reducido")
                        ),
                        React.createElement('div', { className: "text-center md:text-left" },
                            React.createElement('p', { className: "text-2xl font-bold text-primary" }, `#${appState.stats.rank}`),
                            React.createElement('p', { className: "text-xs text-text-subtle uppercase font-semibold" }, "Ranking")
                        )
                    ),

                    React.createElement(BadgesDisplay, { badgeIds: user.displayedBadges })
                ),
                React.createElement('div', { className: "flex flex-col gap-3 self-center md:self-start mt-4 md:mt-0" },
                    React.createElement('button', { onClick: onSettingsClick, className: "w-full sm:w-auto px-5 py-2.5 bg-hover text-text rounded-lg font-semibold flex items-center justify-center gap-2 hover:bg-border" }, React.createElement('i', { className: "fa-solid fa-gear w-5 h-5" }), "Configuración"),
                    React.createElement('button', { className: "w-full sm:w-auto px-5 py-2.5 bg-primary text-dark-text rounded-lg font-semibold flex items-center justify-center gap-2 hover:bg-primary-dark shadow-lg hover:shadow-primary-glow-sm" }, React.createElement('i', { className: "fa-solid fa-share w-5 h-5" }), "Compartir")
                )
            ),
            React.createElement('div', { className: "bg-card p-8 rounded-xl shadow-sm" },
                React.createElement('div', { className: "flex border-b border-border mb-6 overflow-x-auto" },
                    React.createElement('button', { onClick: () => setActiveTab('logros'), className: `px-4 sm:px-6 py-3 font-semibold transition-colors duration-200 whitespace-nowrap ${activeTab === 'logros' ? 'border-b-2 border-primary text-primary' : 'text-text-subtle hover:text-text'}` }, "Logros"),
                    React.createElement('button', { onClick: () => setActiveTab('personalizacion'), className: `px-4 sm:px-6 py-3 font-semibold transition-colors duration-200 whitespace-nowrap ${activeTab === 'personalizacion' ? 'border-b-2 border-primary text-primary' : 'text-text-subtle hover:text-text'}` }, "Personalización"),
                    React.createElement('button', { onClick: () => setActiveTab('impacto'), className: `px-4 sm:px-6 py-3 font-semibold transition-colors duration-200 whitespace-nowrap ${activeTab === 'impacto' ? 'border-b-2 border-primary text-primary' : 'text-text-subtle hover:text-text'}` }, "Impacto"),
                    React.createElement('button', { onClick: () => setActiveTab('historial'), className: `px-4 sm:px-6 py-3 font-semibold transition-colors duration-200 whitespace-nowrap ${activeTab === 'historial' ? 'border-b-2 border-primary text-primary' : 'text-text-subtle hover:text-text'}` }, "Historial")
                ),
                renderTabContent()
            )
        )
    );
};
// --- END OF FILE: pages/ProfilePage.tsx ---

// --- START OF FILE: pages/RankingPage.tsx ---
const RankingPage = () => {
    const { user: currentUser, appState } = useAppContext();
    const [activeTab, setActiveTab] = useState('local');
    const [visibleCount, setVisibleCount] = useState(10);

    useEffect(() => {
        setVisibleCount(10);
    }, [activeTab]);

    const currentUserCity = currentUser.location.split(',')[0] || 'Lima';

    const rankedData = useMemo(() => {
        const currentUserEntry = {
            user: { 
                name: currentUser.name, 
                initials: currentUser.initials, 
                location: currentUser.location,
                avatarId: currentUser.avatarId,
                displayedBadges: currentUser.displayedBadges || [],
            },
            points: appState.stats.points,
            isCurrentUser: true,
        };

        const nationalUserMap = new Map(mockUsers.map(u => [u.user.name, u]));
        nationalUserMap.set(currentUserEntry.user.name, currentUserEntry);
        const nacionalData = Array.from(nationalUserMap.values())
            .sort((a, b) => b.points - a.points)
            .map((entry, index) => ({ ...entry, rank: index + 1 }));

        const localUsers = mockUsers.filter(u => u.user.location.split(',')[0] === currentUserCity);
        const localUserMap = new Map(localUsers.map(u => [u.user.name, u]));
        localUserMap.set(currentUserEntry.user.name, currentUserEntry);
        const localData = Array.from(localUserMap.values())
            .sort((a, b) => b.points - a.points)
            .map((entry, index) => ({ ...entry, rank: index + 1 }));

        return { local: localData, nacional: nacionalData };
    }, [currentUser, appState.stats.points, currentUserCity]);
    
    const data = activeTab === 'local' ? rankedData.local : rankedData.nacional;
    const visibleData = data.slice(0, visibleCount);
    const currentUserEntry = data.find(u => u.isCurrentUser);
    const isUserInVisibleData = !!currentUserEntry && currentUserEntry.rank <= visibleCount;
    
    const handleLoadMore = () => {
        setVisibleCount(prev => prev + 10);
    };

    return (
        React.createElement(React.Fragment, null,
            React.createElement('h2', { className: "text-2xl font-bold text-text mb-2" }, "Ranking de Usuarios"),
            React.createElement('p', { className: "text-text-subtle mb-8" }, "Compara tu progreso con otros usuarios y motívate para subir de posición. Los mejores recicladores ganan premios especiales."),
            React.createElement('div', { className: "flex border-b border-border mb-6 overflow-x-auto" },
                React.createElement('button', { onClick: () => setActiveTab('local'), className: `px-6 py-3 font-semibold whitespace-nowrap transition-colors duration-200 ${activeTab === 'local' ? 'border-b-2 border-primary text-primary' : 'text-text-subtle hover:text-text'}` }, `Local (${currentUserCity})`),
                React.createElement('button', { onClick: () => setActiveTab('nacional'), className: `px-6 py-3 font-semibold whitespace-nowrap transition-colors duration-200 ${activeTab === 'nacional' ? 'border-b-2 border-primary text-primary' : 'text-text-subtle hover:text-text'}` }, "Nacional (Perú)")
            ),
            React.createElement('div', { className: "bg-card rounded-xl shadow-sm" },
                React.createElement('div', { className: "flex items-center p-4 text-sm font-semibold text-text-subtle border-b border-border" },
                    React.createElement('div', { className: "w-12 text-center" }, "#"),
                    React.createElement('div', { className: "w-12" }),
                    React.createElement('div', { className: "flex-grow" }, "Usuario"),
                    React.createElement('div', { className: "w-32 text-right" }, "Puntos")
                ),
                data.length > 0 ? (
                     React.createElement(React.Fragment, null,
                        React.createElement('div', { className: "relative space-y-1 p-2" },
                            visibleData.map((entry, i) => React.createElement(RankRow, { key: `${activeTab}-${entry.user.name}`, entry: entry, index: i })),
                            
                            currentUserEntry && !isUserInVisibleData && (
                                React.createElement(React.Fragment, null,
                                    React.createElement('div', { className: "py-3 text-center", "aria-hidden": "true" },
                                        React.createElement('i', { className: "fa-solid fa-ellipsis text-text-subtle text-xl" })
                                    ),
                                    React.createElement(RankRow, { key: `${activeTab}-${currentUserEntry.user.name}-current`, entry: currentUserEntry, index: currentUserEntry.rank })
                                )
                            )
                        ),
                        visibleCount < data.length && (
                             React.createElement('div', { className: "text-center p-4 border-t border-border" },
                                React.createElement('button', { 
                                    onClick: handleLoadMore, 
                                    className: "px-6 py-2 rounded-lg bg-hover text-text font-semibold hover:bg-border transition"
                                },
                                    "Mostrar más"
                                )
                            )
                        )
                    )
                ) : (
                    React.createElement('div', { className: "p-4" },
                        React.createElement(EmptyState, { 
                            icon: "fa-solid fa-trophy",
                            title: "Ranking no disponible",
                            description: "Aún no hay suficientes datos para mostrar el ranking. ¡Sigue participando para ser el primero!"
                        })
                    )
                )
            )
        )
    );
};
// --- END OF FILE: pages/RankingPage.tsx ---

// --- START OF FILE: pages/ScannerPage.tsx ---
const ScannerPage = () => {
    const { updatePoints, updateMissionProgress, updateAchievementProgress } = useAppContext();
    const [isCameraActive, setCameraActive] = useState(false);
    const [isScanning, setIsScanning] = useState(false);
    const [isActivating, setIsActivating] = useState(false);
    const [scanMessage, setScanMessage] = useState('');
    const [error, setError] = useState(null);
    const [searchText, setSearchText] = useState("");
    const videoRef = useRef(null);
    const streamRef = useRef(null);

    const filteredProducts = useMemo(() => 
        products.filter(p => p.name.toLowerCase().includes(searchText.toLowerCase())),
        [searchText]
    );

    const stopCamera = () => {
        if (streamRef.current) {
            streamRef.current.getTracks().forEach(track => track.stop());
            streamRef.current = null;
        }
        if (videoRef.current) {
            videoRef.current.srcObject = null;
        }
        setCameraActive(false);
        setIsScanning(false);
    };

    const handleActivateCamera = async () => {
        if (isCameraActive || isScanning || isActivating) {
            stopCamera();
            return;
        }

        setError(null);
        setScanMessage('');
        setIsActivating(true);

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            streamRef.current = stream;
            if (videoRef.current) {
                videoRef.current.srcObject = stream;
                videoRef.current.onloadedmetadata = () => {
                    videoRef.current?.play();
                    setIsActivating(false);
                    setCameraActive(true);
                    setIsScanning(true); 

                    setTimeout(() => {
                        stopCamera();
                        const scannedProduct = products.find(p => p.name === 'Botella de vidrio');
                        if (scannedProduct) {
                            setScanMessage(`¡Producto escaneado! "${scannedProduct.name}". Has ganado ${scannedProduct.points} puntos.`);
                            updatePoints(scannedProduct.points, `Escaneo: ${scannedProduct.name}`);
                            updateMissionProgress('SCAN_ITEM');
                            updateAchievementProgress('SCAN_ITEM');
                        }
                    }, 3000);
                }
            }
        } catch (err) {
            console.error("Error accessing camera:", err);
            setError("No se pudo acceder a la cámara. Asegúrate de haber otorgado los permisos necesarios en tu navegador.");
            setIsActivating(false);
            stopCamera();
        }
    };
    
    useEffect(() => {
        return () => stopCamera(); 
    }, []);

    return (
        React.createElement(React.Fragment, null,
            React.createElement('div', { className: "bg-card p-8 rounded-xl shadow-sm mb-8" },
                React.createElement('h2', { className: "text-xl font-bold text-text mb-2" }, "Escanea un producto reciclable"),
                React.createElement('p', { className: "text-text-subtle mb-6" }, "Apunta con la cámara al código de barras del producto para obtener puntos."),
                React.createElement('div', { className: "w-full h-80 sm:h-96 bg-gray-900 dark:bg-black rounded-lg flex flex-col items-center justify-center text-white relative overflow-hidden" },
                    React.createElement('video', {
                        ref: videoRef,
                        autoPlay: true,
                        playsInline: true,
                        muted: true,
                        className: `absolute top-0 left-0 w-full h-full object-cover transition-opacity duration-300 ${isCameraActive ? 'opacity-100' : 'opacity-0'}`
                    }),
                    
                    isScanning && (
                        React.createElement('div', { className: "absolute inset-0 z-10 pointer-events-none" },
                            React.createElement('div', { className: "absolute top-0 left-0 w-full h-1.5 bg-primary animate-scan" })
                        )
                    ),

                    !isCameraActive && (
                        React.createElement('div', { className: "z-20 flex flex-col items-center justify-center text-center p-4" },
                            React.createElement('i', { className: "fa-solid fa-camera text-7xl mb-4", "aria-hidden": "true" }),
                            React.createElement('button', { onClick: handleActivateCamera, disabled: isActivating, className: "bg-primary text-dark-text font-semibold px-6 py-2 rounded-lg hover:bg-primary-dark transition disabled:opacity-70 flex items-center justify-center w-40 h-10" },
                                isActivating ? React.createElement('i', { className: "fa-solid fa-spinner animate-spin" }) : 'Activar Cámara'
                            )
                        )
                    )
                ),
                scanMessage && React.createElement('div', { className: "mt-4 p-4 text-center bg-primary/10 text-primary rounded-lg animate-fade-in" }, scanMessage),
                error && React.createElement('div', { className: "mt-4 p-4 text-center bg-red-500/10 text-red-500 rounded-lg animate-fade-in" }, error)
            ),

            React.createElement('div', { className: "bg-card p-8 rounded-xl shadow-sm" },
                React.createElement('h2', { className: "text-xl font-bold text-text mb-4" }, "Productos Reciclables"),
                React.createElement('div', { className: "relative mb-6" },
                    React.createElement('i', { className: "fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-text-subtle", "aria-hidden": "true" }),
                    React.createElement('input', { type: "text", placeholder: "Buscar producto...", value: searchText, onChange: e => setSearchText(e.target.value), className: "w-full bg-hover border-none rounded-lg py-3 pl-12 pr-4 focus:ring-2 focus:ring-primary" })
                ),
                React.createElement('div', { className: "grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4" },
                    filteredProducts.map((p,i) => (
                        React.createElement('div', { key: p.id, className: "text-center p-4 bg-hover rounded-lg flex flex-col items-center justify-between transition-transform duration-300 hover:-translate-y-1 animate-stagger-in", style: { animationDelay: `${i * 30}ms` } },
                            React.createElement('i', { className: `${p.icon} text-3xl text-primary mb-2`, "aria-hidden": "true" }),
                            React.createElement('p', { className: "font-semibold text-sm text-text" }, p.name),
                            React.createElement('p', { className: "text-xs text-text-subtle" }, p.category),
                            React.createElement('span', { className: "mt-2 text-xs font-bold text-primary" }, `+${p.points} pts`)
                        )
                    ))
                )
            )
        )
    );
};
// --- END OF FILE: pages/ScannerPage.tsx ---

// --- START OF FILE: pages/StorePage.tsx ---
const StorePage = () => {
    const { appState, updatePoints, showToast, user, onUserUpdate, setAppState, isProUser, onProClick, updateMissionProgress, updateAchievementProgress } = useAppContext();
    const [activeTab, setActiveTab] = useState('rewards');
    const [customizationTab, setCustomizationTab] = useState('avatars');
    const [loadingItemId, setLoadingItemId] = useState(null);
    
    const handleRedeem = (reward) => {
        if (loadingItemId) return;
        if (appState.stats.points >= reward.points) {
            setLoadingItemId(reward.id);
            setTimeout(() => {
                updatePoints(-reward.points, `Canje: ${reward.name}`);
                showToast(`¡Has canjeado "${reward.name}"!`, 'success');
                updateMissionProgress('REDEEM_REWARD');
                updateAchievementProgress('REDEEM_REWARD', { rewardId: reward.id });
                setLoadingItemId(null);
            }, 1500);
        } else {
            showToast("No tienes suficientes puntos.", 'error');
        }
    };
    
    const handleBuy = (item, type) => {
        if (loadingItemId) return;

        if (item.isPro && !isProUser) {
            onProClick();
            return;
        }

        if (appState.stats.points >= item.cost) {
            setLoadingItemId(item.id);
            setTimeout(() => {
                updatePoints(-item.cost, `Compra: ${item.name}`);
                setAppState(prev => {
                    switch(type) {
                        case 'avatar': return { ...prev, unlockedAvatars: [...prev.unlockedAvatars, item.id] };
                        case 'frame': return { ...prev, unlockedAvatarFrames: [...prev.unlockedAvatarFrames, item.id] };
                        case 'title': return { ...prev, unlockedProfileTitles: [...prev.unlockedProfileTitles, item.id] };
                        default: return prev;
                    }
                });
                showToast(`¡Has comprado "${item.name}"!`, 'success');
                setLoadingItemId(null);
            }, 1500);
        } else {
            showToast("No tienes suficientes puntos para comprar este artículo.", 'error');
        }
    };

    const handleEquip = (item, type) => {
        if (loadingItemId) return;
        const updatedUser = { ...user };
        if (type === 'avatar') updatedUser.avatarId = item.id;
        if (type === 'frame') updatedUser.avatarFrameId = item.id;
        if (type === 'title') updatedUser.profileTitleId = item.id;
        onUserUpdate(updatedUser);
        showToast(`"${item.name}" equipado.`, 'success');
    };

    const renderCustomizationStore = () => {
        let items = [];
        let type = 'avatar';
        let ownedIds = [];
        let equippedId = '';
        
        switch(customizationTab) {
            case 'avatars':
                items = allAvatars;
                type = 'avatar';
                ownedIds = appState.unlockedAvatars;
                equippedId = user.avatarId;
                break;
            case 'frames':
                items = allAvatarFrames;
                type = 'frame';
                ownedIds = appState.unlockedAvatarFrames;
                equippedId = user.avatarFrameId;
                break;
            case 'titles':
                items = allProfileTitles;
                type = 'title';
                ownedIds = appState.unlockedProfileTitles;
                equippedId = user.profileTitleId;
                break;
        }

        return (
            React.createElement('div', { className: "animate-fade-in" },
                 React.createElement('div', { className: "flex bg-hover rounded-lg p-1 mb-6" },
                    React.createElement('button', { onClick: () => setCustomizationTab('avatars'), className: `flex-1 py-2 px-4 text-center rounded-md font-semibold transition text-sm ${customizationTab === 'avatars' ? 'bg-card shadow text-primary' : 'text-text-subtle'}` }, "Avatares"),
                    React.createElement('button', { onClick: () => setCustomizationTab('frames'), className: `flex-1 py-2 px-4 text-center rounded-md font-semibold transition text-sm ${customizationTab === 'frames' ? 'bg-card shadow text-primary' : 'text-text-subtle'}` }, "Marcos"),
                    React.createElement('button', { onClick: () => setCustomizationTab('titles'), className: `flex-1 py-2 px-4 text-center rounded-md font-semibold transition text-sm ${customizationTab === 'titles' ? 'bg-card shadow text-primary' : 'text-text-subtle'}` }, "Títulos")
                ),
                React.createElement('div', { className: "grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6" },
                    items.map((item, i) => (
                        React.createElement(CustomizationItemCard, {
                            key: item.id,
                            item: item,
                            type: type,
                            isOwned: ownedIds.includes(item.id),
                            isEquipped: equippedId === item.id,
                            onBuy: handleBuy,
                            onEquip: handleEquip,
                            userPoints: appState.stats.points,
                            isProUser: isProUser,
                            index: i,
                            isLoading: loadingItemId === item.id
                        })
                    ))
                )
            )
        );
    };

    return (
        React.createElement(React.Fragment, null,
            React.createElement('h2', { className: "text-2xl font-bold text-text mb-2" }, "Tienda EcoScore"),
            React.createElement('p', { className: "text-text-subtle mb-6" }, "Usa tus puntos para canjear recompensas o personalizar tu perfil."),
            
            React.createElement('div', { className: "glass-card p-4 sm:p-5 rounded-xl mb-8 flex items-center gap-4 border-l-4 border-primary bg-primary/10 animate-fade-in" },
                React.createElement('i', { className: "fa-solid fa-tree text-3xl text-primary w-12 text-center", "aria-hidden": "true" }),
                React.createElement('div', null,
                    React.createElement('h3', { className: "font-bold text-text" }, "Nota Importante: ¡Tu compra tiene un impacto real!"),
                    React.createElement('p', { className: "text-sm text-text-subtle" },
                        "Por cada recompensa canjeada o artículo comprado, se realizará una donación para ", React.createElement('strong', null, "plantar un árbol en la Amazonía peruana"), ". ¡Estás ayudando a reforestar nuestro pulmón del mundo!"
                    )
                )
            ),

            React.createElement('div', { className: "flex border-b border-border mb-6 overflow-x-auto" },
                React.createElement('button', { onClick: () => setActiveTab('rewards'), className: `px-6 py-3 font-semibold whitespace-nowrap transition-colors duration-200 ${activeTab === 'rewards' ? 'border-b-2 border-primary text-primary' : 'text-text-subtle hover:text-text'}` }, "Recompensas"),
                React.createElement('button', { onClick: () => setActiveTab('customization'), className: `px-6 py-3 font-semibold whitespace-nowrap transition-colors duration-200 ${activeTab === 'customization' ? 'border-b-2 border-primary text-primary' : 'text-text-subtle hover:text-text'}` }, "Personalización")
            ),

            activeTab === 'rewards' && (
                React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8 animate-fade-in" },
                    rewards.map((r, i) => React.createElement(RewardCard, { key: r.id, reward: r, onRedeem: handleRedeem, index: i, isLoading: loadingItemId === r.id }))
                )
            ),
            
            activeTab === 'customization' && renderCustomizationStore()
        )
    );
};
// --- END OF FILE: pages/StorePage.tsx ---

// --- START OF FILE: pages/CarbonFootprintPage.tsx ---
const CarbonFootprintPage = () => {
    const calculateCarbonFootprint = (formData) => {
        const FACTORS = {
            car: 0.17 / 1000 * 52,
            publicTransport: 0.04 / 1000 * 52,
            plane: 0.20,
            electricity: (0.25 / 0.70) / 1000 * 12,
            meat: { daily: 2.5, often: 1.8, sometimes: 1.2, rarely: 0.8, never: 0.5 },
            localFoodMultiplier: { most: 0.9, some: 0.95, little: 1.0 },
            waste: { lot: 0.4, average: 0.25, little: 0.1 }
        };

        const transportFootprint = 
            (formData.transport.car * FACTORS.car) +
            (formData.transport.public * FACTORS.publicTransport) +
            (formData.transport.plane * FACTORS.plane);

        let homeElectricity = formData.home.electricity * FACTORS.electricity;
        if(formData.home.renewables) homeElectricity *= 0.1;
        const homeFootprint = homeElectricity / Math.max(1, formData.home.people);
        
        const foodMeat = FACTORS.meat[formData.food.meat];
        const foodWaste = FACTORS.waste[formData.food.waste];
        const foodFootprint = (foodMeat + foodWaste) * FACTORS.localFoodMultiplier[formData.food.local];

        const totalFootprint = transportFootprint + homeFootprint + foodFootprint;

        const allRecommendations = {
            transport: [
                { icon: "fa-solid fa-bicycle", title: "Usa más la bici", description: "Para trayectos cortos, la bicicleta es tu mejor aliada. Cero emisiones y excelente para tu salud." },
                { icon: "fa-solid fa-bus", title: "Prioriza el transporte público", description: "Reduce el número de coches en la carretera y disminuye tu huella de carbono personal." }
            ],
            home: [
                { icon: "fa-solid fa-plug-circle-xmark", title: "Desconecta lo que no usas", description: "El 'consumo fantasma' de los aparatos en standby suma. ¡Desenchúfalos y ahorra!" },
                { icon: "fa-solid fa-lightbulb", title: "Cambia a focos LED", description: "Las bombillas LED consumen hasta un 85% menos de energía y duran mucho más." }
            ],
            food: [
                { icon: "fa-solid fa-seedling", title: "Lunes sin carne", description: "Reducir el consumo de carne, aunque sea un día a la semana, tiene un gran impacto." },
                { icon: "fa-solid fa-carrot", title: "Compra local y de temporada", description: "Apoya a los productores locales y reduce las emisiones del transporte de alimentos." }
            ]
        };

        const breakdownRank = [
            { name: 'transport', value: transportFootprint },
            { name: 'home', value: homeFootprint },
            { name: 'food', value: foodFootprint },
        ].sort((a, b) => b.value - a.value);

        const recommendations = [
            allRecommendations[breakdownRank[0].name][0],
            allRecommendations[breakdownRank[1].name][0],
            allRecommendations[breakdownRank[2].name][0],
        ];

        return {
            totalFootprint,
            breakdown: { transport: transportFootprint, home: homeFootprint, food: foodFootprint },
            recommendations
        };
    };

    const Stepper = ({ currentStep }) => {
        const steps = [
            { name: 'Movilidad', icon: 'fa-solid fa-car' },
            { name: 'Hogar', icon: 'fa-solid fa-house' },
            { name: 'Alimentación', icon: 'fa-solid fa-utensils' },
            { name: 'Resultado', icon: 'fa-solid fa-seedling' },
        ];
        return (
            React.createElement('div', { className: "flex justify-between items-center w-full mb-8 sm:mb-12" },
                steps.map((step, index) => {
                    const stepNumber = index + 1;
                    const isActive = stepNumber < currentStep;
                    const isCurrent = stepNumber === currentStep;
                    return (
                        React.createElement(React.Fragment, { key: step.name },
                            React.createElement('div', { className: "flex flex-col items-center text-center w-16" },
                                React.createElement('div', {
                                    className: `w-12 h-12 rounded-full flex items-center justify-center border-2 transition-all duration-300 ${isCurrent ? 'bg-primary border-primary text-white shadow-lg shadow-primary/40' : isActive ? 'bg-primary/20 border-primary text-primary' : 'bg-hover border-border text-text-subtle'}`
                                },
                                    React.createElement('i', { className: step.icon })
                                ),
                                React.createElement('p', { className: `mt-2 text-xs font-semibold transition-colors ${isCurrent || isActive ? 'text-text' : 'text-text-subtle'}` }, step.name)
                            ),
                            index < steps.length - 1 && (
                                React.createElement('div', { className: "flex-grow h-1 mx-2 rounded-full bg-border relative top-[-1rem]" },
                                    React.createElement('div', { className: "h-full rounded-full bg-primary transition-all duration-500", style: { width: `${stepNumber < currentStep ? '100%' : '0%'}` } })
                                )
                            )
                        )
                    );
                })
            )
        );
    };

    const Slider = ({ icon, label, value, max, unit, onChange }) => (
        React.createElement('div', { className: "bg-hover/80 p-4 sm:p-6 rounded-xl" },
            React.createElement('label', { className: "flex items-center gap-3 font-semibold text-text" },
                React.createElement('i', { className: `${icon} w-6 h-6 text-xl text-primary` }), ` ${label}`
            ),
            React.createElement('div', { className: "flex items-center gap-4 mt-3" },
                React.createElement('input', { type: "range", min: "0", max: max, value: value, onChange: onChange, className: "w-full h-2 bg-border rounded-lg appearance-none cursor-pointer accent-primary" }),
                React.createElement('span', { className: "font-bold text-primary text-lg w-28 text-right" }, `${value} ${unit}`)
            )
        )
    );

    const RadioGroup = ({ name, options, selected, onChange }) => (
        React.createElement('div', { className: "bg-hover/80 p-4 sm:p-6 rounded-xl" },
            React.createElement('div', { className: "grid grid-cols-2 sm:grid-cols-3 gap-3" },
                options.map(opt => {
                    const isSelected = selected === opt.value;
                    return (
                        React.createElement('label', { key: opt.value, className: `relative p-4 border-2 rounded-lg text-center cursor-pointer transition-all duration-200 flex flex-col items-center justify-center min-h-[6rem] ${isSelected ? 'bg-card border-primary shadow-md' : 'bg-card border-transparent hover:border-primary/50'}` },
                            React.createElement('input', { type: "radio", name: name, value: opt.value, checked: isSelected, onChange: onChange, className: "sr-only" }),
                            React.createElement('span', { className: "font-semibold text-sm text-text" }, opt.label),
                            isSelected && React.createElement('div', { className: "absolute top-2 right-2 w-5 h-5 bg-primary text-white rounded-full flex items-center justify-center shadow" }, React.createElement('i', { className: "fa-solid fa-check text-xs" }))
                        )
                    )
                })
            )
        )
    );

    const ResultLoading = () => (
        React.createElement('div', { className: "flex flex-col items-center justify-center text-center p-10 animate-fade-in" },
            React.createElement('div', { className: "relative w-24 h-24" },
                React.createElement('i', { className: "fa-solid fa-leaf text-green-500 text-6xl animate-[ping_2s_ease-out_infinite] absolute inset-0 opacity-75" }),
                React.createElement('i', { className: "fa-solid fa-leaf text-green-500 text-6xl" })
            ),
            React.createElement('p', { className: "mt-6 text-text-subtle font-semibold text-lg" }, "Analizando tu impacto..."),
            React.createElement('p', { className: "text-text-subtle text-sm" }, "Calculando tu huella de carbono.")
        )
    );

    const ResultError = ({ message, onRetry }) => (
        React.createElement('div', { className: "text-center p-10 animate-fade-in" },
            React.createElement('i', { className: "fa-solid fa-circle-exclamation text-red-500 text-5xl mb-4" }),
            React.createElement('p', { className: "text-text font-semibold text-lg" }, "¡Oh, no! Algo salió mal"),
            React.createElement('p', { className: "text-text-subtle text-sm mb-6" }, message),
            React.createElement('button', { onClick: onRetry, className: "mt-6 px-6 py-2 rounded-lg bg-primary text-dark-text font-semibold hover:bg-primary-dark transition-all" },
                "Volver a intentarlo"
            )
        )
    );

    const { updateMissionProgress, showToast } = useAppContext();
    const [step, setStep] = useState('intro');
    const [formData, setFormData] = useState({
        transport: { car: 50, public: 20, plane: 0 },
        home: { people: 2, electricity: 100, renewables: false },
        food: { meat: 'sometimes', local: 'some', waste: 'average' }
    });
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');
    const [result, setResult] = useState(null);

    const handleFormChange = (category, field, value) => {
        setFormData(prev => ({
            ...prev,
            [category]: { ...prev[category], [field]: value }
        }));
    };

    const handleSubmit = () => {
        setStep('result');
        setIsLoading(true);
        setError('');
        setResult(null);

        setTimeout(() => {
            try {
                const calculatedResult = calculateCarbonFootprint(formData);
                setResult(calculatedResult);
                updateMissionProgress('CALCULATE_FOOTPRINT');
                showToast('¡Cálculo de huella completado!', 'success');
            } catch (e) {
                console.error(e);
                setError('Hubo un error al calcular el resultado. Por favor, revisa tus datos.');
            } finally {
                setIsLoading(false);
            }
        }, 1500);
    };
    
    const renderStep = () => {
        switch(step) {
            case 'intro': return (
                React.createElement('div', { className: "text-center animate-fade-in p-4" },
                    React.createElement('div', { className: "w-24 h-24 mx-auto mb-6 bg-primary/20 rounded-full flex items-center justify-center shadow-inner" },
                        React.createElement('i', { className: "fa-solid fa-earth-americas text-5xl text-primary animate-pulse-slow" })
                    ),
                    React.createElement('h3', { className: "text-3xl font-bold text-text mb-4" }, "Descubre Tu Huella en el Planeta"),
                    React.createElement('p', { className: "text-text-subtle mb-8 max-w-xl mx-auto" }, "Esta herramienta te dará una estimación de tu huella de carbono —la marca que dejas en el medio ambiente—. ¡Unos pocos clics para un gran descubrimiento!"),
                    React.createElement('button', { onClick: () => setStep('transport'), className: "px-10 py-4 rounded-lg bg-primary text-dark-text font-semibold hover:bg-primary-dark transition-all text-lg shadow-lg hover:shadow-primary-glow-md transform hover:scale-105" },
                        React.createElement('i', { className: "fa-solid fa-play mr-2" }),
                        "Empezar"
                    )
                )
            );
            case 'transport': return (
                React.createElement('div', { className: "w-full animate-fade-in" },
                    React.createElement(Stepper, { currentStep: 1 }),
                    React.createElement('div', { className: "space-y-6" },
                        React.createElement('h3', { className: "text-2xl font-bold text-center text-text mb-4" }, "Tu Movilidad Semanal"),
                        React.createElement(Slider, { icon: "fa-solid fa-car", label: "Distancia en coche", value: formData.transport.car, max: 500, unit: "km", onChange: e => handleFormChange('transport', 'car', parseInt(e.target.value)) }),
                        React.createElement(Slider, { icon: "fa-solid fa-bus", label: "Distancia en transporte público", value: formData.transport.public, max: 500, unit: "km", onChange: e => handleFormChange('transport', 'public', parseInt(e.target.value)) }),
                        React.createElement(Slider, { icon: "fa-solid fa-plane", label: "Horas de vuelo al año", value: formData.transport.plane, max: 100, unit: "hrs", onChange: e => handleFormChange('transport', 'plane', parseInt(e.target.value)) })
                    ),
                    React.createElement('div', { className: "flex justify-between pt-8" }, React.createElement('button', { onClick: () => setStep('intro'), className: "px-6 py-2 rounded-lg bg-hover text-text font-semibold hover:bg-border" }, "Atrás"), React.createElement('button', { onClick: () => setStep('home'), className: "px-8 py-3 rounded-lg bg-primary text-dark-text font-semibold hover:bg-primary-dark shadow-md hover:shadow-lg transition" }, "Siguiente"))
                )
            );
            case 'home': return (
                 React.createElement('div', { className: "w-full animate-fade-in" },
                    React.createElement(Stepper, { currentStep: 2 }),
                    React.createElement('div', { className: "space-y-6" },
                        React.createElement('h3', { className: "text-2xl font-bold text-center text-text mb-4" }, "Tu Hogar"),
                        React.createElement(Slider, { icon: "fa-solid fa-users", label: "Personas en tu hogar", value: formData.home.people, max: 10, unit: "pers.", onChange: e => handleFormChange('home', 'people', parseInt(e.target.value)) }),
                        React.createElement(Slider, { icon: "fa-solid fa-wallet", label: "Gasto mensual de electricidad", value: formData.home.electricity, max: 1000, unit: "S/", onChange: e => handleFormChange('home', 'electricity', parseInt(e.target.value)) }),
                        React.createElement('div', { className: "flex items-center justify-between p-4 sm:p-6 bg-hover/80 rounded-xl" },
                            React.createElement('label', { className: "font-semibold text-text flex items-center gap-3" }, React.createElement('i', { className: "fa-solid fa-solar-panel w-6 h-6 text-xl text-primary" }), "¿Usas energías renovables?"),
                            React.createElement('label', { className: "relative inline-flex items-center cursor-pointer" }, React.createElement('input', { type: "checkbox", checked: formData.home.renewables, onChange: e => handleFormChange('home', 'renewables', e.target.checked), className: "sr-only peer" }), React.createElement('div', { className: "w-11 h-6 bg-border peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary" }))
                        )
                    ),
                    React.createElement('div', { className: "flex justify-between pt-8" }, React.createElement('button', { onClick: () => setStep('transport'), className: "px-6 py-2 rounded-lg bg-hover text-text font-semibold hover:bg-border" }, "Atrás"), React.createElement('button', { onClick: () => setStep('food'), className: "px-8 py-3 rounded-lg bg-primary text-dark-text font-semibold hover:bg-primary-dark shadow-md hover:shadow-lg transition" }, "Siguiente"))
                )
            );
            case 'food': return (
                React.createElement('div', { className: "w-full animate-fade-in" },
                    React.createElement(Stepper, { currentStep: 3 }),
                    React.createElement('div', { className: "space-y-6" },
                         React.createElement('h3', { className: "text-2xl font-bold text-center text-text mb-4" }, "Tus Hábitos Alimenticios"),
                        React.createElement('div', null, React.createElement('label', { className: "font-semibold text-text mb-2 block" }, "¿Consumo de carne roja?"), React.createElement(RadioGroup, { name: "meat", options: [{value: 'never', label: 'Nunca'}, {value: 'rarely', label: 'Rara vez'}, {value: 'sometimes', label: 'A veces'}, {value: 'often', 'label': 'Frecuente'}, {value: 'daily', label: 'Diario'}], selected: formData.food.meat, onChange: e => handleFormChange('food', 'meat', e.target.value) })),
                        React.createElement('div', null, React.createElement('label', { className: "font-semibold text-text mb-2 block" }, "¿Comida de origen local?"), React.createElement(RadioGroup, { name: "local", options: [{value: 'little', label: 'Poca'}, {value: 'some', label: 'Algo'}, {value: 'most', label: 'Mucha'}], selected: formData.food.local, onChange: e => handleFormChange('food', 'local', e.target.value) })),
                        React.createElement('div', null, React.createElement('label', { className: "font-semibold text-text mb-2 block" }, "¿Desperdicio de comida?"), React.createElement(RadioGroup, { name: "waste", options: [{value: 'lot', label: 'Mucho'}, {value: 'average', label: 'Promedio'}, {value: 'little', label: 'Poco'}], selected: formData.food.waste, onChange: e => handleFormChange('food', 'waste', e.target.value) }))
                    ),
                    React.createElement('div', { className: "flex justify-between pt-8" }, React.createElement('button', { onClick: () => setStep('home'), className: "px-6 py-2 rounded-lg bg-hover text-text font-semibold hover:bg-border" }, "Atrás"), React.createElement('button', { onClick: handleSubmit, disabled: isLoading, className: "px-8 py-3 rounded-lg bg-success text-dark-text font-semibold hover:opacity-90 shadow-lg hover:shadow-success/40 transition flex items-center justify-center disabled:opacity-70 min-w-[200px] h-12" },
    isLoading ? React.createElement('i', { className: "fa-solid fa-spinner animate-spin w-6 h-6" }) : 'Calcular Mi Huella'))
                )
            );
            case 'result': return (
                React.createElement('div', { className: "w-full animate-fade-in" },
                    React.createElement(Stepper, { currentStep: 4 }),
                    isLoading && React.createElement(ResultLoading, null),
                    error && React.createElement(ResultError, { message: error, onRetry: () => setStep('food') }),
                    result && (() => {
                        const { totalFootprint, breakdown } = result;
                        const scoreColorClass = totalFootprint < 4 ? 'bg-green-500' : totalFootprint < 7 ? 'bg-yellow-500' : 'bg-red-500';
                        const breakdownSegments = [
                            { value: breakdown.transport, color: 'bg-blue-500', label: 'Transporte', percentage: (breakdown.transport / totalFootprint) * 100 },
                            { value: breakdown.home, color: 'bg-orange-500', label: 'Hogar', percentage: (breakdown.home / totalFootprint) * 100 },
                            { value: breakdown.food, color: 'bg-green-600', label: 'Alimentación', percentage: (breakdown.food / totalFootprint) * 100 },
                        ];

                        return (
                             React.createElement('div', { className: "text-center" },
                                React.createElement('h3', { className: "text-2xl font-bold text-text mb-2" }, "¡Aquí está tu resultado!"),
                                React.createElement('div', { className: `relative w-48 h-48 sm:w-56 sm:h-56 mx-auto my-6 rounded-full flex flex-col items-center justify-center text-white transition-colors duration-500 ${scoreColorClass} shadow-2xl` },
                                    React.createElement('div', { className: "absolute inset-0 bg-white/10 rounded-full animate-[ripple_4s_ease-in-out_infinite]" }),
                                    React.createElement('p', { className: "text-5xl sm:text-6xl font-bold", style: { textShadow: '0 2px 5px rgba(0,0,0,0.2)' } }, totalFootprint.toFixed(1)),
                                    React.createElement('p', { className: "font-semibold text-sm" }, "toneladas CO2e/año")
                                ),
                                React.createElement('p', { className: "text-center text-text-subtle mb-8" }, "El promedio en Perú es ~4.7 toneladas. ¡Cada pequeña acción cuenta para reducir tu huella!"),
                                
                                React.createElement('div', { className: "w-full bg-hover/80 rounded-lg p-4 sm:p-6 mb-8 text-left" },
                                    React.createElement('h4', { className: "font-bold mb-4 text-text" }, "Desglose de Emisiones"),
                                    React.createElement('div', { className: "flex w-full h-8 rounded-full overflow-hidden shadow-inner bg-border" }, breakdownSegments.map(seg => (React.createElement('div', { key: seg.label, className: `group relative flex items-center justify-center ${seg.color} transition-all duration-300`, style: {width: `${seg.percentage}%`} }, React.createElement('div', { className: "absolute bottom-full mb-2 w-max bg-card text-text-subtle text-xs rounded py-1 px-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none shadow-lg border border-border z-20" }, `${seg.label}: ${seg.value.toFixed(1)}t (${seg.percentage.toFixed(0)}%)`))))),
                                    React.createElement('div', { className: "flex justify-around text-xs mt-3 text-text-subtle" }, breakdownSegments.map(seg => (React.createElement('div', { key: seg.label, className: "flex items-center gap-1.5" }, React.createElement('div', { className: `w-3 h-3 rounded-full ${seg.color}` }), React.createElement('span', null, seg.label)))))
                                ),

                                 React.createElement('h4', { className: "font-bold text-xl mb-4" }, "Tus Próximos Pasos Ecológicos"),
                                 React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6 text-left" },
                                    result.recommendations.map((rec, i) => (
                                        React.createElement('div', { key: i, className: "glass-card p-6 rounded-xl border-border/50 transition-all duration-300 hover:shadow-lg hover:-translate-y-1" },
                                            React.createElement('div', { className: "w-12 h-12 bg-primary/20 rounded-lg flex items-center justify-center mb-4 shadow-inner" }, React.createElement('i', { className: `${rec.icon} text-2xl text-primary` })),
                                            React.createElement('h5', { className: "font-bold text-text mb-1" }, rec.title),
                                            React.createElement('p', { className: "text-sm text-text-subtle" }, rec.description)
                                        )
                                    ))
                                 ),
                                 React.createElement('button', { onClick: () => { setStep('intro'); setResult(null); }, className: "mt-10 px-6 py-2 rounded-lg bg-hover text-text font-semibold hover:bg-border transition" }, "Recalcular")
                             )
                        );
                    })()
                )
            );
        }
    }

    return (
        React.createElement('div', { className: "animate-fade-in" },
            React.createElement('header', { className: "mb-8" },
                React.createElement('h2', { className: "text-3xl font-bold text-text mb-2 flex items-center gap-3" }, React.createElement('i', { className: "fa-solid fa-calculator w-8 h-8" }), "Eco-Calculadora"),
                React.createElement('p', { className: "text-text-subtle" }, "Mide tu impacto ambiental y descubre cómo transformarlo con acciones simples y poderosas.")
            ),
            React.createElement('div', { className: "glass-card rounded-2xl shadow-sm p-4 sm:p-10 min-h-[500px] flex items-center justify-center" },
                renderStep()
            )
        )
    );
};
// --- END OF FILE: pages/CarbonFootprintPage.tsx ---

// --- START OF FILE: pages/CommunityPage.tsx ---
const CommunityPage = () => {
    const deleteRecursively = (items, idToDelete) => {
        return items.filter(post => post.id !== idToDelete)
                   .map(post => ({
                       ...post,
                       comments: post.comments.length > 0 ? deleteRecursively(post.comments, idToDelete) : []
                   }));
    };
    const editRecursively = (items, idToEdit, newContent) => {
        return items.map(post => {
            if (post.id === idToEdit) {
                return { ...post, content: newContent };
            }
            if (post.comments.length > 0) {
                return { ...post, comments: editRecursively(post.comments, idToEdit, newContent) };
            }
            return post;
        });
    };
    const updatePostRecursively = (items, id, updateFn) => {
        return items.map(post => {
            if (post.id === id) {
                return updateFn(post);
            }
            if (post.comments.length > 0) {
                return { ...post, comments: updatePostRecursively(post.comments, id, updateFn) };
            }
            return post;
        });
    };
    const addCommentRecursively = (items, parentId, newComment) => {
        return items.map(post => {
            if (post.id === parentId) {
                return { ...post, comments: [newComment, ...post.comments] };
            }
            if (post.comments.length > 0) {
                return { ...post, comments: addCommentRecursively(post.comments, parentId, newComment) };
            }
            return post;
        });
    };

    const { user, updateMissionProgress, updateAchievementProgress, showToast } = useAppContext();
    const [posts, setPosts] = useState(initialPosts);
    const [newPostContent, setNewPostContent] = useState('');
    const [isPosting, setIsPosting] = useState(false);
    const [postError, setPostError] = useState('');
    const [visibleCount, setVisibleCount] = useState(5);
    const [activeFilter, setActiveFilter] = useState('recent');

    useEffect(() => {
        setVisibleCount(5);
    }, [activeFilter]);

    const filteredAndSortedPosts = useMemo(() => {
        let processedPosts = [...posts];

        if (activeFilter === 'popular') {
            processedPosts.sort((a, b) => b.likes - a.likes);
        }
        
        if (activeFilter === 'official') {
            processedPosts = processedPosts.filter(p => p.author.isOfficial);
        }
        
        return processedPosts;
    }, [posts, activeFilter]);
    
    const handleLoadMore = () => {
        setVisibleCount(prevCount => prevCount + 5);
    };
    
    const handleLike = useCallback((id) => {
        setPosts(currentPosts =>
            updatePostRecursively(currentPosts, id, post => {
                if (!post.isLiked) {
                    updateAchievementProgress('LIKE_POST');
                }
                return {
                    ...post,
                    isLiked: !post.isLiked,
                    likes: post.isLiked ? post.likes - 1 : post.likes + 1,
                };
            })
        );
    }, [updateAchievementProgress]);

    const handleCommentSubmit = useCallback((parentId, content) => {
        const newComment = {
            id: `c${Date.now()}`,
            author: { name: user.name, avatarId: user.avatarId },
            timestamp: 'Ahora',
            content,
            likes: 0,
            isLiked: false,
            comments: [],
        };
        setPosts(currentPosts => addCommentRecursively(currentPosts, parentId, newComment));
        updateAchievementProgress('COMMENT_POST');
    }, [user, updateAchievementProgress]);
    
    const handlePost = () => {
        if (!newPostContent.trim() || isPosting) return;

        setIsPosting(true);
        setPostError('');

        setTimeout(() => {
            const newPost = {
                id: `p${Date.now()}`,
                author: { name: user.name, avatarId: user.avatarId },
                timestamp: 'Ahora',
                content: newPostContent,
                likes: 0,
                isLiked: false,
                comments: [],
            };
            setPosts([newPost, ...posts]);
            setNewPostContent('');
            updateMissionProgress('POST_COMMUNITY');
            updateAchievementProgress('POST_COMMUNITY');
            setIsPosting(false);
        }, 1000);
    };

    const handleDelete = useCallback((id) => {
        setPosts(currentPosts => deleteRecursively(currentPosts, id));
        showToast('Publicación eliminada.', 'info');
    }, [showToast]);

    const handleEdit = useCallback((id, newContent) => {
        setPosts(currentPosts => editRecursively(currentPosts, id, newContent));
    }, []);
    
    return (
        React.createElement(React.Fragment, null,
            React.createElement('header', { className: "mb-8" },
                React.createElement('h2', { className: "text-3xl font-bold text-text mb-2" }, "Comunidad EcoScore"),
                React.createElement('p', { className: "text-text-subtle" }, "Comparte tus logros, consejos y preguntas con otros usuarios comprometidos.")
            ),
            
            React.createElement('div', { className: "glass-card rounded-2xl p-6 mb-8 flex items-start gap-4" },
                React.createElement(AvatarDisplay, { avatarId: user.avatarId, frameId: user.avatarFrameId, sizeClass: "w-12 h-12 hidden sm:flex", iconSizeClass: "text-2xl" }),
                React.createElement('div', { className: "w-full" },
                    React.createElement('textarea', { value: newPostContent, onChange: e => setNewPostContent(e.target.value), placeholder: `¿Qué consejo ecológico quieres compartir hoy, ${user.name}?`, className: "w-full h-24 p-3 bg-hover rounded-lg border-2 border-transparent focus:ring-2 focus:ring-primary focus:border-primary transition-colors", disabled: isPosting }),
                    React.createElement('div', { className: "flex justify-between items-center mt-4" },
                        postError && React.createElement('p', { className: "text-red-500 text-sm" }, postError),
                        React.createElement('div', { className: "flex-grow" }),
                        React.createElement('button', { onClick: handlePost, disabled: isPosting || !newPostContent.trim(), className: "bg-primary text-dark-text font-semibold px-6 py-2.5 rounded-lg hover:bg-primary-dark transition-all flex items-center gap-2 ml-auto disabled:opacity-70 shadow-lg hover:shadow-primary-glow-sm transform hover:scale-105" },
                           isPosting ? React.createElement('i', { className: "fa-solid fa-spinner animate-spin w-5 h-5" }) : React.createElement(React.Fragment, null, React.createElement('i', { className: "fa-solid fa-paper-plane" }), " Publicar")
                        )
                    )
                )
            ),

            React.createElement('div', { className: "flex border-b border-border mb-6 overflow-x-auto" },
                React.createElement('button', { onClick: () => setActiveFilter('recent'), className: `px-6 py-3 font-semibold whitespace-nowrap transition-colors duration-200 ${activeFilter === 'recent' ? 'border-b-2 border-primary text-primary' : 'text-text-subtle hover:text-text'}` }, "Recientes"),
                React.createElement('button', { onClick: () => setActiveFilter('popular'), className: `px-6 py-3 font-semibold whitespace-nowrap transition-colors duration-200 ${activeFilter === 'popular' ? 'border-b-2 border-primary text-primary' : 'text-text-subtle hover:text-text'}` }, "Populares"),
                React.createElement('button', { onClick: () => setActiveFilter('official'), className: `px-6 py-3 font-semibold whitespace-nowrap transition-colors duration-200 ${activeFilter === 'official' ? 'border-b-2 border-primary text-primary' : 'text-text-subtle hover:text-text'}` }, "Oficiales")
            ),

            React.createElement('div', { className: "space-y-6" },
                filteredAndSortedPosts.length > 0 ? (
                    filteredAndSortedPosts.slice(0, visibleCount).map((p, i) => React.createElement(PostCard, { key: p.id, post: p, onLike: handleLike, onCommentSubmit: handleCommentSubmit, onDelete: handleDelete, onEdit: handleEdit, index: i }))
                ) : (
                     React.createElement(EmptyState, {
                        icon: activeFilter === 'official' ? "fa-solid fa-bullhorn" : "fa-solid fa-inbox",
                        title: activeFilter === 'official' ? "Sin Anuncios Oficiales" : "No hay publicaciones aquí",
                        description:
                            activeFilter === 'official' 
                                ? "No hay anuncios oficiales en este momento. ¡Vuelve más tarde!"
                                : "Parece que no hay publicaciones que coincidan con este filtro. ¡Sé el primero en compartir algo!"
                    })
                )
            ),
            visibleCount < filteredAndSortedPosts.length && (
                React.createElement('div', { className: "text-center mt-8" },
                    React.createElement('button', { 
                        onClick: handleLoadMore, 
                        className: "px-6 py-3 rounded-lg bg-card text-text font-semibold hover:bg-hover transition-colors shadow-md"
                    },
                        "Cargar más publicaciones"
                    )
                )
            )
        )
    );
};
// --- END OF FILE: pages/CommunityPage.tsx ---

// --- START OF FILE: pages/EcoGardenPage.tsx ---
const EcoGardenPage = () => {
    const TutorialModal = ({ onClose }) => {
        const tutorialItems = [
            { icon: 'fa-solid fa-sun', title: 'El Sol Radiante', description: 'El sol brilla con más intensidad según los días que lleves de racha. ¡Sigue así!' },
            { icon: 'fa-solid fa-tree', title: 'Tu Árbol Principal', description: 'Crece desde una plántula hasta un árbol majestuoso a medida que acumulas EcoPuntos.' },
            { icon: 'fa-solid fa-fan', title: 'Flores de Logros', description: 'Florecen flores únicas y coloridas por cada Ruta de Aprendizaje que completes.' },
            { icon: 'fa-solid fa-water', title: 'El Estanque', description: 'Alcanza el Top 10 en el Ranking Nacional para desbloquear un sereno estanque.' },
            { icon: 'fa-solid fa-seedling', title: 'Árbol de Donación', description: "Canjear 'Planta un Árbol' en la tienda hará crecer un hermoso cerezo en flor." }
        ];

        return (
            React.createElement('div', { className: "fixed inset-0 bg-black/70 backdrop-blur-sm flex justify-center items-center z-50 p-4 animate-fade-in", onClick: onClose },
                React.createElement('div', { className: "glass-card rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col", onClick: e => e.stopPropagation() },
                    React.createElement('div', { className: "p-6 border-b border-border/50 flex justify-between items-center" },
                        React.createElement('h3', { className: "text-2xl font-bold text-text" }, "Bienvenido a tu Eco-Jardín"),
                        React.createElement('button', { onClick: onClose, className: "text-text-subtle hover:text-text p-2 rounded-full hover:bg-hover transition-colors", "aria-label": "Cerrar tutorial del Eco-Jardín" }, React.createElement('i', { className: "fa-solid fa-xmark w-6 h-6" }))
                    ),
                    React.createElement('div', { className: "p-8 overflow-y-auto space-y-4" },
                        React.createElement('p', { className: "text-text-subtle" }, "Este es tu paraíso personal, un reflejo visual de tu progreso. ¡Mira cómo tus acciones le dan vida!"),
                        tutorialItems.map(item => (
                            React.createElement('div', { key: item.title, className: "flex items-start gap-4 p-3 bg-hover/80 rounded-lg" },
                                React.createElement('i', { className: `${item.icon} text-primary text-xl w-6 h-6 text-center pt-1` }),
                                React.createElement('div', null,
                                    React.createElement('h4', { className: "font-bold text-text" }, item.title),
                                    React.createElement('p', { className: "text-sm text-text-subtle" }, item.description)
                                )
                            )
                        ))
                    )
                )
            )
        );
    };

    const GardenElement = ({ children, tooltip, positionClass, animationClass = '', style }) => (
        React.createElement('div', { className: `group absolute ${positionClass}`, style: style, role: "img", "aria-label": tooltip },
            React.createElement('div', { className: `transition-transform duration-300 group-hover:scale-110 ${animationClass}` }, children),
            React.createElement('div', { className: "absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-max max-w-xs text-center bg-card text-text-subtle text-xs rounded-md py-1 px-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none shadow-lg border border-border/50 z-20", "aria-hidden": "true" },
                tooltip
            )
        )
    );

    const Sun = ({ streak }) => {
        const sunSize = 50 + streak * 4;
        const shadowOpacity = 0.3 + streak * 0.02;
        return (
            React.createElement('div', { className: "absolute top-[8%] right-[10%] animate-fade-in", role: "img", "aria-label": `Sol radiante con una fuerza de ${streak} días de racha` },
                React.createElement('div', { className: `relative rounded-full transition-all duration-500`, style: { width: `${sunSize}px`, height: `${sunSize}px` } },
                    React.createElement('div', { className: "absolute inset-0 bg-yellow-300 rounded-full animate-[pulse-slow_4s_ease-in-out_infinite]", style: { boxShadow: `0 0 ${sunSize*2}px ${sunSize/4}px rgba(253,224,71,${shadowOpacity})` }}),
                    React.createElement('div', { className: "absolute inset-[-1rem] bg-yellow-300/30 rounded-full animate-sun-ray-spin", style: { animationDuration: '30s' } }),
                    React.createElement('div', { className: "absolute inset-[-2rem] bg-yellow-300/20 rounded-full animate-sun-ray-spin", style: { animationDuration: '45s' } })
                )
            )
        );
    };

    const Clouds = () => (
        React.createElement('div', { className: "absolute inset-0 overflow-hidden pointer-events-none opacity-50 dark:opacity-40" },
            React.createElement('div', { className: "absolute top-[15%] -left-1/4 w-48 h-12 bg-white/80 rounded-full animate-cloud-fly", style: {animationDuration: '60s', animationDelay: '8s'} }),
            React.createElement('div', { className: "absolute top-[25%] -left-1/4 w-64 h-16 bg-white/80 rounded-full animate-cloud-fly", style: {animationDuration: '90s'} }),
            React.createElement('div', { className: "absolute top-[10%] -left-1/4 w-32 h-8 bg-white/70 rounded-full animate-cloud-fly", style: {animationDuration: '75s', animationDelay: '20s'} })
        )
    );


    const Tree = ({ points }) => {
        let treeComponent;
        let tooltip;
        let position = 'bottom-[14%] left-1/2 -translate-x-1/2';
        let style = { transformOrigin: 'bottom center' };

        if (points < 1000) {
            tooltip = `Una plántula. ¡Sigue así! (${points.toLocaleString()} pts)`;
            position = 'bottom-[16%] left-1/2 -translate-x-1/2';
            treeComponent = React.createElement('i', { className: "fa-solid fa-seedling text-5xl text-green-700 drop-shadow-lg" });
        } else {
            const scale = Math.min(1.5, 1 + (points / 20000));
            tooltip = `Tu árbol crece fuerte. (${points.toLocaleString()} pts)`;
            treeComponent = (
                React.createElement('div', { className: "relative w-32 h-56", style: { transform: `scale(${scale})`} },
                    React.createElement('div', { className: "absolute bottom-0 left-1/2 -translate-x-1/2 w-12 h-32 bg-[#5c3c1e] dark:bg-[#4d3219] rounded-t-xl shadow-2xl" },
                        React.createElement('div', { className: "absolute top-8 -left-4 w-12 h-4 bg-[#6b4226] dark:bg-[#593822] -rotate-45 rounded-md" }),
                        React.createElement('div', { className: "absolute top-16 -right-4 w-10 h-3 bg-[#6b4226] dark:bg-[#593822] rotate-45 rounded-md" })
                    ),
                    React.createElement('div', { className: "absolute top-8 -left-8 w-40 h-40 bg-green-800/80 dark:bg-green-900/80 rounded-full -rotate-12" }),
                    React.createElement('div', { className: "absolute top-8 -right-8 w-40 h-40 bg-green-600/80 dark:bg-green-700/80 rounded-full rotate-12" }),
                    React.createElement('div', { className: "absolute top-0 left-0 w-48 h-40 bg-green-700/90 dark:bg-green-800/90 rounded-full -rotate-6" }),
                    React.createElement('div', { className: "absolute top-2 left-1/2 -translate-x-1/2 w-32 h-32 bg-green-500 dark:bg-green-600 rounded-full" })
                )
            );
        }
        
        return React.createElement(GardenElement, { tooltip: tooltip, positionClass: position, style: style, animationClass: "animate-gentle-sway" }, treeComponent);
    };

    const DonatedTree = () => {
        const style = { transformOrigin: 'bottom center' };
        return (
            React.createElement(GardenElement, { tooltip: "Un cerezo en flor, gracias a tu donación.", positionClass: "bottom-[15%] left-[15%]", style: style, animationClass: "animate-gentle-sway" },
                React.createElement('div', { className: "relative w-20 h-40" },
                    React.createElement('div', { className: "absolute bottom-0 left-1/2 -translate-x-1/2 w-8 h-24 bg-stone-700 dark:bg-stone-800 rounded-t-lg -rotate-6" }),
                    React.createElement('div', { className: "absolute top-6 left-0 w-24 h-24 bg-pink-300/80 rounded-full -rotate-12" }),
                    React.createElement('div', { className: "absolute top-0 -right-4 w-28 h-28 bg-pink-200/90 rounded-full rotate-12" }),
                    [...Array(5)].map((_, i) => (
                        React.createElement('div', { key: i, className: "absolute top-0 left-1/2 animate-falling-petal", style: { animationDelay: `${i * 1.5}s`, animationDuration: '8s' } },
                            React.createElement('i', { className: "fa-solid fa-fan text-pink-200 text-xs opacity-80", style: { transform: `translateX(${Math.random() * 80 - 40}px) rotate(${Math.random() * 360}deg)` } })
                        )
                    ))
                )
            )
        );
    };

    const Flower = ({ color, tooltip, positionClass }) => {
        const style = { transformOrigin: 'bottom center' };
        return (
            React.createElement(GardenElement, { tooltip: tooltip, positionClass: positionClass, style: style, animationClass: "animate-gentle-sway" },
                React.createElement('div', { className: "relative w-8 h-12" },
                    React.createElement('div', { className: "absolute bottom-0 left-1/2 -translate-x-1/2 w-1 h-8 bg-green-700 dark:bg-green-800 rounded-full" }),
                    React.createElement('div', { className: "absolute top-0 left-1/2 -translate-x-1/2 w-8 h-8" },
                        React.createElement('div', { className: `absolute top-1/2 left-1/2 w-4 h-4 ${color} rounded-full -translate-x-1/2 -translate-y-1/2` }),
                        [...Array(5)].map((_, i) => (
                            React.createElement('div', {
                                key: i,
                                className: `absolute top-1/2 left-1/2 w-3 h-5 ${color} rounded-full origin-bottom`,
                                style: { transform: `translate(-50%, -100%) rotate(${i * 72}deg) translateY(-5px)` }
                            })
                        ))
                    )
                )
            )
        );
    };

    const Pond = () => (
        React.createElement(GardenElement, { tooltip: "Un estanque sereno, símbolo de estar en el Top 10.", positionClass: "bottom-[10%] right-[5%] w-56 h-20" },
            React.createElement('div', { className: "w-full h-full relative" },
                React.createElement('div', { className: "absolute inset-0 bg-blue-400/80 rounded-[50%] animate-gentle-sway shadow-inner" }),
                React.createElement('div', { className: "absolute inset-x-2 inset-y-1 bg-blue-500/90 rounded-[50%] animate-[gentle-sway_6s_ease-in-out_infinite] shadow-inner" }),
                 React.createElement('div', { className: "absolute top-1/3 left-1/4 w-8 h-8 bg-green-700 rounded-full animate-float" },
                    React.createElement('div', { className: "absolute top-0 right-0 w-4 h-4 bg-transparent rounded-full transform -rotate-45 border-r-8 border-t-8 border-transparent border-r-blue-500/90" })
                ),
                React.createElement('div', { className: "absolute bottom-1/4 right-1/4 w-6 h-6 bg-green-700 rounded-full animate-[float_5s_ease-in-out_infinite_0.5s]" },
                     React.createElement('div', { className: "absolute top-0 right-0 w-3 h-3 bg-transparent rounded-full transform -rotate-45 border-r-6 border-t-6 border-transparent border-r-blue-500/90" })
                )
            )
        )
    );
    const { appState } = useAppContext();
    const [showTutorial, setShowTutorial] = useState(false);
    
    const completedLearningPaths = appState.learningPaths.filter(p => p.isCompleted);
    const hasPlantedTree = appState.history.some(h => h.description.includes('Planta un Árbol'));
    const isInTop10 = appState.stats.rank <= 10;
    
    const flowerData = [
        { id: 'lp1', color: 'bg-blue-500' }, { id: 'lp2', color: 'bg-green-500' },
        { id: 'lp3', color: 'bg-yellow-500' }, { id: 'lp4', color: 'bg-purple-500' },
        { id: 'lp5', color: 'bg-cyan-500' }, { id: 'lp6', color: 'bg-red-500' },
    ];
    
    const flowerPositions = [
        'bottom-[16%] left-[30%]', 'bottom-[25%] left-[65%]',
        'bottom-[18%] right-[20%]', 'bottom-[22%] left-[40%]',
        'bottom-[15%] right-[35%]', 'bottom-[28%] right-[45%]',
    ];

    return (
        React.createElement('div', { className: "animate-fade-in" },
             React.createElement('header', { className: "mb-6 flex justify-between items-center" },
                React.createElement('div', null,
                    React.createElement('h2', { className: "text-3xl font-bold text-text mb-1" }, "Eco-Jardín"),
                    React.createElement('p', { className: "text-text-subtle" }, "Tu progreso florece aquí. ¡Mira cómo tus acciones le dan vida a tu paraíso personal!")
                ),
                React.createElement('button', { onClick: () => setShowTutorial(true), className: "flex items-center gap-2 px-4 py-2 rounded-lg bg-hover text-text font-semibold hover:bg-border transition-colors" },
                    React.createElement('i', { className: "fa-solid fa-circle-question" }),
                    React.createElement('span', { className: "hidden sm:inline" }, "Cómo funciona")
                )
            ),
            
            React.createElement('div', { className: "relative w-full aspect-[2/1] bg-gradient-to-b from-sky-300 to-sky-500 dark:from-sky-800 dark:to-slate-900 rounded-2xl overflow-hidden shadow-xl" },
                React.createElement(Sun, { streak: appState.streak.current }),
                React.createElement(Clouds, null),
                
                React.createElement('div', { className: "absolute bottom-0 left-0 w-full h-1/4 bg-gradient-to-t from-green-600 to-green-500 dark:from-green-800 dark:to-green-700" },
                    React.createElement('div', { className: "absolute -top-1 left-0 w-full h-2 bg-black/10" })
                ),

                React.createElement(Tree, { points: appState.stats.points }),
                hasPlantedTree && React.createElement(DonatedTree, null),
                isInTop10 && React.createElement(Pond, null),
                
                completedLearningPaths.map((lp, index) => {
                    const flowerInfo = flowerData.find(f => f.id === lp.id);
                    if (!flowerInfo) return null;
                    return (
                        React.createElement(Flower, {
                            key: lp.id,
                            color: flowerInfo.color,
                            tooltip: `Una flor por completar la ruta '${lp.title}'.`,
                            positionClass: flowerPositions[index % flowerPositions.length]
                        })
                    );
                })
            ),
            
            showTutorial && React.createElement(TutorialModal, { onClose: () => setShowTutorial(false) })
        )
    );
};
// --- END OF FILE: pages/EcoGardenPage.tsx ---

// --- START OF FILE: components/layout/MainContent.tsx ---
const MainContent = ({ activePage, onNavItemClick, isSidebarCollapsed, onMobileMenuToggle, isDarkMode, setDarkMode, activeTheme, setActiveTheme }) => {
    const { user, appState } = useAppContext();
    const [isDropdownOpen, setDropdownOpen] = useState(false);
    const [showSettings, setShowSettings] = useState(false);
    const dropdownRef = useRef(null);

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                setDropdownOpen(false);
            }
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);

    const handleProfileClick = () => {
        onNavItemClick('Perfil');
        setDropdownOpen(false);
    };

    const handleSettingsClick = () => {
        setShowSettings(true);
        setDropdownOpen(false);
    };
    
    const renderPage = () => {
        switch (activePage) {
            case 'Inicio': return React.createElement(HomePage, null);
            case 'Escáner': return React.createElement(ScannerPage, null);
            case 'Tienda': return React.createElement(StorePage, null);
            case 'Educación': return React.createElement(EducationPage, null);
            case 'Minijuegos': return React.createElement(MinigamesPage, null);
            case 'Comunidad': return React.createElement(CommunityPage, null);
            case 'Ranking': return React.createElement(RankingPage, null);
            case 'Eco-Jardín': return React.createElement(EcoGardenPage, null);
            case 'Eco-Calculadora': return React.createElement(CarbonFootprintPage, null);
            case 'Perfil': return React.createElement(ProfilePage, { onSettingsClick: handleSettingsClick });
            default: return (
                React.createElement('div', { className: "text-center py-20" },
                    React.createElement('h1', { className: "text-4xl font-bold" }, activePage),
                    React.createElement('p', null, "Página en construcción.")
                )
            );
        }
    };

    return (
        React.createElement('main', { className: "flex-1 flex flex-col bg-background min-h-0 transition-all duration-300 ease-in-out aurora-bg" },
            React.createElement('div', { className: "p-4 sm:p-6 lg:p-8 shrink-0" },
                React.createElement('header', { className: "lg:hidden flex justify-between items-center gap-4" },
                    React.createElement('button', { onClick: onMobileMenuToggle, className: "text-text hover:text-primary flex-shrink-0", "aria-label": "Abrir menú de navegación" },
                        React.createElement('i', { className: "fa-solid fa-bars text-2xl w-8 h-8" })
                    ),
                    React.createElement('h1', { className: "flex-1 text-2xl font-bold gradient-text truncate text-center min-w-0" }, activePage),
                    React.createElement('div', { className: "relative flex-shrink-0", ref: dropdownRef },
                        React.createElement('button', { onClick: () => setDropdownOpen(!isDropdownOpen), className: "flex items-center", "aria-label": "Abrir menú de perfil de usuario", "aria-haspopup": "true", "aria-expanded": isDropdownOpen },
                             React.createElement(AvatarDisplay, { avatarId: user.avatarId, frameId: user.avatarFrameId, sizeClass: "w-10 h-10", iconSizeClass: "text-xl" })
                        ),
                        isDropdownOpen && (
                            React.createElement('div', { className: "absolute right-0 mt-2 w-56 glass-card rounded-lg shadow-xl z-20 py-2 animate-fade-in-down" },
                                React.createElement('button', { onClick: handleProfileClick, className: "w-full text-left flex items-center gap-3 px-4 py-2 text-sm text-text hover:bg-hover" }, React.createElement('i', { className: "fa-solid fa-user w-5 h-5" }), " Mi Perfil"),
                                React.createElement('button', { onClick: handleSettingsClick, className: "w-full text-left flex items-center gap-3 px-4 py-2 text-sm text-text hover:bg-hover" }, React.createElement('i', { className: "fa-solid fa-gear w-5 h-5" }), " Ajustes")
                            )
                        )
                    )
                ),

                React.createElement('header', { className: "hidden lg:flex justify-between items-center" },
                    React.createElement('h1', { className: "text-5xl font-extrabold gradient-text" }, activePage),
                    React.createElement('div', { className: "flex items-center gap-4" },
                        React.createElement('div', { className: "flex items-center gap-2 text-orange-500 font-semibold glass-card px-4 py-2 rounded-full shadow-sm" },
                            React.createElement('i', { className: "fa-solid fa-fire text-lg" }),
                            React.createElement('span', { className: "font-bold text-text" }, `${appState.streak.current} Días de Racha`)
                        ),
                        React.createElement('div', { className: "relative", ref: dropdownRef },
                            React.createElement('button', { onClick: () => setDropdownOpen(!isDropdownOpen), className: "flex items-center gap-3 glass-card px-3 py-2 rounded-full shadow-sm cursor-pointer transition-shadow hover:shadow-md", "aria-haspopup": "true", "aria-expanded": isDropdownOpen, "aria-label": "Abrir menú de perfil de usuario" },
                                React.createElement(AvatarDisplay, { avatarId: user.avatarId, frameId: user.avatarFrameId, sizeClass: "w-10 h-10", iconSizeClass: "text-xl" }),
                                React.createElement('span', { className: "font-semibold text-text hidden sm:block" }, user.name),
                                React.createElement('i', { className: `fa-solid fa-chevron-down h-5 w-5 text-text-subtle transition-transform duration-200 ${isDropdownOpen ? 'rotate-180' : ''}` })
                            ),
                            isDropdownOpen && (
                                React.createElement('div', { className: "absolute right-0 mt-2 w-56 glass-card rounded-lg shadow-xl z-20 py-2 animate-fade-in-down" },
                                    React.createElement('button', { onClick: handleProfileClick, className: "w-full text-left flex items-center gap-3 px-4 py-2 text-sm text-text hover:bg-hover" }, React.createElement('i', { className: "fa-solid fa-user w-5 h-5" }), " Mi Perfil"),
                                    React.createElement('button', { onClick: handleSettingsClick, className: "w-full text-left flex items-center gap-3 px-4 py-2 text-sm text-text hover:bg-hover" }, React.createElement('i', { className: "fa-solid fa-gear w-5 h-5" }), " Ajustes")
                                )
                            )
                        )
                    )
                )
            ),
            
            React.createElement('div', { className: "flex-1 overflow-y-auto px-4 sm:px-6 lg:px-8 pt-0" },
                React.createElement('div', { key: activePage, className: "animate-fade-in pb-8" },
                    renderPage()
                )
            ),
            
            showSettings && React.createElement(SettingsModal, { onClose: () => setShowSettings(false), isDarkMode: isDarkMode, setDarkMode: setDarkMode, activeTheme: activeTheme, setActiveTheme: setActiveTheme })
        )
    );
};
// --- END OF FILE: components/layout/MainContent.tsx ---

// --- START OF FILE: components/AppLayout.tsx ---
const AppLayout = ({ onLogout, activePage, setActivePage }) => {
    const { isProUser, onProClick } = useAppContext();
    const [isDarkMode, setDarkMode] = usePersistentState('isDarkMode', false);
    const [activeTheme, setActiveTheme] = usePersistentState('activeTheme', 'default');
    const [isSidebarCollapsed, setSidebarCollapsed] = usePersistentState('isSidebarCollapsed', false);
    const [isMobileMenuOpen, setMobileMenuOpen] = useState(false);

    useEffect(() => {
        document.documentElement.classList.toggle('dark', isDarkMode);
    }, [isDarkMode]);
    
    useEffect(() => {
        document.documentElement.setAttribute('data-theme', activeTheme);
        if (activeTheme === 'aquatic-colors' && !isDarkMode) {
            setDarkMode(true);
        }
    }, [activeTheme, isDarkMode, setDarkMode]);


    const handleNavItemClick = (page) => {
        setActivePage(page);
        setMobileMenuOpen(false);
    };

    return (
        React.createElement(React.Fragment, null,
            isMobileMenuOpen && (
                React.createElement('div', {
                    className: "fixed inset-0 bg-slate-900/60 dark:bg-black/70 z-30 lg:hidden",
                    onClick: () => setMobileMenuOpen(false),
                    "aria-hidden": "true"
                })
            ),
            React.createElement('div', { className: "flex bg-background h-screen overflow-hidden transition-colors duration-300" },
                React.createElement(Sidebar, {
                    activePage: activePage,
                    onNavItemClick: handleNavItemClick,
                    isCollapsed: isSidebarCollapsed,
                    onToggleCollapse: () => setSidebarCollapsed(!isSidebarCollapsed),
                    isDarkMode: isDarkMode,
                    onToggleDarkMode: () => setDarkMode(!isDarkMode),
                    onLogout: onLogout,
                    isProUser: isProUser,
                    onProClick: onProClick,
                    isMobileMenuOpen: isMobileMenuOpen
                }),
                React.createElement(MainContent, {
                    activePage: activePage,
                    onNavItemClick: setActivePage,
                    isSidebarCollapsed: isSidebarCollapsed,
                    onMobileMenuToggle: () => setMobileMenuOpen(true),
                    isDarkMode: isDarkMode,
                    setDarkMode: setDarkMode,
                    activeTheme: activeTheme,
                    setActiveTheme: setActiveTheme
                })
            )
        )
    );
};
// --- END OF FILE: components/AppLayout.tsx ---

// --- START OF FILE: components/ToastProvider.tsx ---
const ToastContext = React.createContext({ showToast: () => {} });
const useToast = () => useContext(ToastContext);

const Toast = ({ message, onDismiss }) => {
    const [isExiting, setIsExiting] = useState(false);

    const handleDismiss = useCallback(() => {
        setIsExiting(true);
        setTimeout(() => onDismiss(message.id), 400);
    }, [message.id, onDismiss]);

    useEffect(() => {
        const timer = setTimeout(() => {
            handleDismiss();
        }, 5000);

        return () => clearTimeout(timer);
    }, [handleDismiss]);
    
    const typeStyles = {
        success: { border: 'border-l-primary', icon: 'fa-solid fa-circle-check text-primary' },
        error:   { border: 'border-l-red-500', icon: 'fa-solid fa-circle-exclamation text-red-500' },
        info:    { border: 'border-l-blue-500', icon: 'fa-solid fa-circle-info text-blue-500' },
    };

    const styles = typeStyles[message.type];

    return (
        React.createElement('div', { 
            className: `glass-card flex items-center p-4 mb-4 rounded-xl shadow-lg border border-border/50 border-l-4 ${styles.border} ${isExiting ? 'animate-fade-out-up' : 'animate-fade-in-down'}`, 
            role: "alert"
        },
            React.createElement('i', { className: `${styles.icon} w-6 h-6 mr-4 text-2xl flex-shrink-0` }),
            React.createElement('div', { className: "text-sm font-semibold text-text flex-grow" }, message.message),
             React.createElement('button', { onClick: handleDismiss, className: "ml-4 p-1.5 text-text-subtle hover:text-text rounded-full hover:bg-hover flex-shrink-0 transition-colors" },
                React.createElement('i', { className: "fa-solid fa-xmark w-4 h-4" })
            )
        )
    );
};

const ToastProvider = ({ children }) => {
    const [toasts, setToasts] = useState([]);

    const showToast = useCallback((message, type = 'info') => {
        const id = Date.now();
        setToasts(prev => [...prev, { id, message, type }].slice(-5));
    }, []);
    
    const dismissToast = useCallback((id) => {
        setToasts(prev => prev.filter(toast => toast.id !== id));
    }, []);

    return (
        React.createElement(ToastContext.Provider, { value: { showToast } },
            children,
            React.createElement('div', { className: "fixed top-5 left-1/2 -translate-x-1/2 z-[100] w-full max-w-sm sm:max-w-md px-4" },
                toasts.map(toast => (
                    React.createElement(Toast, { key: toast.id, message: toast, onDismiss: dismissToast })
                ))
            )
        )
    );
};
// --- END OF FILE: components/ToastProvider.tsx ---

// --- START OF FILE: App.tsx ---
const checkActionAchievements = (ach, action, payload, updateCounter) => {
    let shouldUnlock = false;
    switch (action) {
        case 'SCAN_ITEM': 
            if (ach.id === 'a1') shouldUnlock = true; 
            if (['a9', 'a19', 'a28'].includes(ach.id)) updateCounter(); 
            break;
        case 'COMPLETE_LESSON': 
            if (ach.id === 'a2') shouldUnlock = true; 
            if (['a10', 'a24'].includes(ach.id)) updateCounter(); 
            break;
        case 'POST_COMMUNITY': 
            if (ach.id === 'a3') shouldUnlock = true; 
            if (ach.id === 'a34') updateCounter(); 
            break;
        case 'PLAY_GAME': 
            if (ach.id === 'a4') shouldUnlock = true; 
            if (ach.id === 'a33' && payload?.score >= 100) shouldUnlock = true; 
            break;
        case 'REDEEM_REWARD': 
            if (['a5', 'a23'].includes(ach.id)) updateCounter(); 
            if (payload?.rewardId === 'r4' && ach.id === 'a16') shouldUnlock = true; 
            break;
        case 'LIKE_POST': 
            if (ach.id === 'a8') updateCounter(); 
            break;
        case 'COMMENT_POST': 
            if (ach.id === 'a15') updateCounter(); 
            break;
    }
    return shouldUnlock;
};

const checkStateUpdateAchievements = (ach, prev, isProUser) => {
    let shouldUnlock = false;
    let progressMade = false;
    
    switch (ach.id) {
        case 'a6': case 'a11': case 'a25': case 'a31':
            if(ach.progress && prev.streak.current !== ach.progress.current) { 
                ach.progress = {...ach.progress, current: prev.streak.current }; 
                progressMade = true; 
            }
            if(prev.streak.current >= (ach.progress?.total ?? Infinity)) shouldUnlock = true;
            break;
        case 'a13': case 'a20': case 'a29':
            if(ach.progress && prev.stats.points !== ach.progress.current) { 
                ach.progress = {...ach.progress, current: prev.stats.points }; 
                progressMade = true; 
            }
            if(prev.stats.points >= (ach.progress?.total ?? Infinity)) shouldUnlock = true;
            break;
        case 'a21': if (prev.stats.rank <= 100) shouldUnlock = true; break;
        case 'a30': if (prev.stats.rank <= 10) shouldUnlock = true; break;
        case 'a36': if (isProUser) shouldUnlock = true; break;
        case 'a35': if (prev.learningPaths.every(p => p.isCompleted)) shouldUnlock = true; break;
        case 'ach-lp1': case 'ach-lp2': case 'ach-lp3': case 'ach-lp4': case 'ach-lp5': case 'ach-lp6':
            if (prev.learningPaths.find(p => p.achievementId === ach.id)?.isCompleted) shouldUnlock = true;
            break;
    }
    return { shouldUnlock, progressMade };
}


const AppContent = () => {
    const { showToast } = useToast();
    const [isLoggedIn, setLoggedIn] = usePersistentState('isLoggedIn', false);
    const [user, setUser] = usePersistentState('user', MOCK_USER);
    const [isProUser, setProUser] = usePersistentState('isProUser', false);
    const [appState, setAppState] = usePersistentState('appState', INITIAL_APP_STATE);
    const [activePage, setActivePage] = useState('Inicio');
    
    const [showProModal, setShowProModal] = useState(false);
    const [activeGame, setActiveGame] = useState(null);
    const isInitialMount = useRef(true);
    const streakToastShown = useRef(false);

    const updateAchievementProgress = useCallback((action, payload, silent = false) => {
        setAppState(prev => {
            let hasChanges = false;
            const unlockedAchievements = [];

            const newAchievements = prev.achievements.map(ach => {
                if (ach.isUnlocked) return ach;

                let newAch = { ...ach };
                let progressMade = false;
                let shouldUnlock = false;

                const updateCounter = (amount = 1) => {
                    if (!newAch.progress) return;
                    const newCurrent = Math.min((newAch.progress.current || 0) + amount, newAch.progress.total);
                    if (newCurrent > newAch.progress.current) {
                        newAch.progress = { ...newAch.progress, current: newCurrent };
                        progressMade = true;
                        if (newAch.progress.current >= newAch.progress.total) {
                            shouldUnlock = true;
                        }
                    }
                };

                if (action === 'STATE_UPDATE') {
                    const stateResult = checkStateUpdateAchievements(newAch, prev, isProUser);
                    shouldUnlock = stateResult.shouldUnlock;
                    progressMade = stateResult.progressMade;
                } else {
                    shouldUnlock = checkActionAchievements(newAch, action, payload, updateCounter);
                }

                if (shouldUnlock && !newAch.isUnlocked) {
                    newAch.isUnlocked = true; 
                    newAch.unlockDate = 'Hoy';
                    unlockedAchievements.push(newAch.name);
                }

                if (progressMade || (shouldUnlock && !ach.isUnlocked)) hasChanges = true;
                return newAch;
            });

            if (unlockedAchievements.length > 0 && !silent) {
                setTimeout(() => {
                    unlockedAchievements.forEach(name => showToast(`¡Logro desbloqueado: ${name}!`, 'success'));
                }, 500);
            }

            return hasChanges ? { ...prev, achievements: newAchievements } : prev;
        });
    }, [setAppState, showToast, isProUser]);


    useEffect(() => {
        if (!isLoggedIn) {
            streakToastShown.current = false; 
            return;
        }

        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        
        setAppState(prev => {
            if (prev.streak.lastLoginDate === todayStr) return prev; 

            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            const newStreak = (prev.streak.lastLoginDate === yesterdayStr) ? prev.streak.current + 1 : 1;
            const newLongest = Math.max(prev.streak.longest, newStreak);
            
            return { ...prev, streak: { current: newStreak, longest: newLongest, lastLoginDate: todayStr } };
        });
    }, [isLoggedIn, setAppState]);

    useEffect(() => {
        const todayStr = new Date().toISOString().split('T')[0];
        
        if (isLoggedIn && activePage === 'Inicio' && appState.streak.lastLoginDate === todayStr && !streakToastShown.current) {
            const newStreak = appState.streak.current;
            if (newStreak > 0) {
                setTimeout(() => {
                    showToast(newStreak > 1 ? `¡Racha extendida a ${newStreak} días! 🔥` : '¡Nueva racha iniciada!', newStreak > 1 ? 'success' : 'info');
                }, 500);
                streakToastShown.current = true; 
            }
        }
    }, [isLoggedIn, activePage, appState.streak, showToast]);


    useEffect(() => {
        if (!isLoggedIn) {
            return;
        }

        if (isInitialMount.current) {
            updateAchievementProgress('STATE_UPDATE', undefined, true);
            isInitialMount.current = false;
        } else {
            updateAchievementProgress('STATE_UPDATE');
        }
    }, [isLoggedIn, appState.stats.points, appState.streak.current, appState.learningPaths, isProUser, updateAchievementProgress]);


    useEffect(() => {
        const rechargeEnergy = () => {
            setAppState(prev => {
                const maxEnergy = isProUser ? 10 : 5;
                if (prev.energy >= maxEnergy) return prev;
                const now = Date.now();
                const ENERGY_RECHARGE_RATE = 15 * 60 * 1000;
                const timeDiff = now - prev.lastEnergyRecharge;
                const energyToRecharge = Math.floor(timeDiff / ENERGY_RECHARGE_RATE);
                if (energyToRecharge > 0) {
                    const newEnergy = Math.min(prev.energy + energyToRecharge, maxEnergy);
                    const newLastRecharge = prev.lastEnergyRecharge + (energyToRecharge * ENERGY_RECHARGE_RATE);
                    return { ...prev, energy: newEnergy, lastEnergyRecharge: newLastRecharge };
                }
                return prev;
            });
        };
        rechargeEnergy();
        const energyInterval = setInterval(rechargeEnergy, 60 * 1000);
        return () => clearInterval(energyInterval);
    }, [setAppState, isProUser]);

    const handleLogin = (loggedInUser) => {
        if (loggedInUser) {
            setUser(loggedInUser);
            const freshState = {
                ...INITIAL_APP_STATE, 
                stats: { points: 0, impact: 0, recycling: 0, rank: mockUsers.length + 2 },
                missions: INITIAL_APP_STATE.missions.map(m => ({
                    ...m,
                    progress: m.progress ? { ...m.progress, current: 0 } : undefined
                })),
                history: [],
                streak: { current: 0, longest: 0, lastLoginDate: '' },
                unlockedAvatars: ['avatar-default'],
                unlockedAvatarFrames: ['frame-none'],
                unlockedProfileTitles: ['title-novice'],
                achievements: allAchievements.map(ach => ({
                    ...ach, 
                    isUnlocked: false, 
                    progress: ach.progress ? { ...ach.progress, current: 0 } : undefined
                })),
                learningPaths: learningPaths.map(path => ({
                    ...path, 
                    isCompleted: false,
                    steps: path.steps.map((step, idx) => ({...step, status: idx === 0 ? 'available' : 'locked'}))
                })),
            };
            setAppState(freshState);
            setProUser(false); 
        }
        setLoggedIn(true);
    };

    const handleLogout = () => {
        setUser(MOCK_USER); 
        setAppState(INITIAL_APP_STATE); 
        setProUser(false); 
        setLoggedIn(false);
    };

    const handleProClick = () => {
        if (isProUser) {
            showToast("¡Ya eres un miembro Pro! Gracias por tu apoyo.", 'info');
        } else {
            setShowProModal(true);
        }
    };
    
    const updatePoints = useCallback((points, description) => {
        setAppState(prev => {
            const newHistoryItem = {
                id: `h${Date.now()}`,
                icon: points > 0 ? 'fa-solid fa-recycle' : 'fa-solid fa-bag-shopping',
                description: description || (points > 0 ? 'Puntos ganados' : 'Puntos canjeados'),
                timestamp: 'Ahora',
                points: points
            };
            if (points > 0) {
                showToast(`+${points} puntos: ${description}`, 'success');
            }
            return {
                ...prev,
                stats: { ...prev.stats, points: prev.stats.points + points },
                history: [newHistoryItem, ...prev.history].slice(0, 50)
            };
        });
    }, [setAppState, showToast]);
    
    const consumeEnergy = useCallback((callback) => {
        setAppState(prev => {
            if (prev.energy > 0) {
                const maxEnergy = isProUser ? 10 : 5;
                callback(true);
                const newLastRecharge = prev.energy === maxEnergy ? Date.now() : prev.lastEnergyRecharge;
                return { ...prev, energy: prev.energy - 1, lastEnergyRecharge: newLastRecharge };
            }
            callback(false);
            return prev;
        });
    }, [setAppState, isProUser]);

    const updateMissionProgress = useCallback((action, payload) => {
        setAppState(prev => {
            const completedMissions = [];
            let missionProgressChanged = false;
    
            const updatedMissions = prev.missions.map(mission => {
                let missionToUpdate = { ...mission };
                let isCompleted = false;
    
                const updateProgress = () => {
                    if (missionToUpdate.progress) {
                        if (missionToUpdate.progress.current >= missionToUpdate.progress.total) return;
    
                        const newProgress = { ...missionToUpdate.progress, current: missionToUpdate.progress.current + 1 };
                        missionToUpdate = { ...missionToUpdate, progress: newProgress };
                        missionProgressChanged = true;
                        if (newProgress.current >= missionToUpdate.progress.total) {
                            isCompleted = true;
                        }
                    } else {
                        isCompleted = true;
                    }
                };
    
                switch (action) {
                    case 'SCAN_ITEM': if (missionToUpdate.id === 'm5_new') updateProgress(); break;
                    case 'COMPLETE_LESSON':
                        if (missionToUpdate.id === 'm7_new') updateProgress();
                        if (missionToUpdate.id === 'm2' && payload?.lessonId === 'l3') isCompleted = true;
                        break;
                    case 'POST_COMMUNITY': if (missionToUpdate.id === 'm3' || missionToUpdate.id === 'm14_new') isCompleted = true; break;
                    case 'REDEEM_REWARD': if (missionToUpdate.id === 'm6_new') isCompleted = true; break;
                    case 'CALCULATE_FOOTPRINT': if (missionToUpdate.id === 'm11_new') isCompleted = true; break;
                    case 'UPCYCLE_ITEM': if (missionToUpdate.id === 'm13_new') isCompleted = true; break;
                }
    
                if (isCompleted) {
                    completedMissions.push(missionToUpdate);
                    return null;
                }
                return missionToUpdate;
            }).filter((m) => m !== null);
    
            if (completedMissions.length === 0 && !missionProgressChanged) {
                return prev;
            }
            
            let pointsToAdd = 0;
            const newHistoryItems = [];
            completedMissions.forEach(mission => {
                pointsToAdd += mission.points;
                newHistoryItems.push({
                    id: `h-m-${mission.id}-${Date.now()}`,
                    icon: 'fa-solid fa-flag-checkered',
                    description: `Misión: ${mission.description}`,
                    timestamp: 'Ahora',
                    points: mission.points
                });
                showToast(`¡Misión completada: ${mission.description}!`, 'success');
            });
    
            return {
                ...prev,
                stats: { ...prev.stats, points: prev.stats.points + pointsToAdd },
                history: [...newHistoryItems, ...prev.history].slice(0, 50),
                missions: updatedMissions,
            };
        });
    }, [setAppState, showToast]);
    
    const completeLearningStep = useCallback((pathId, stepId) => {
        setAppState(prev => {
            const newPaths = prev.learningPaths.map(path => {
                if (path.id === pathId) {
                    let stepCompleted = false;
                    const newSteps = path.steps.map((step) => {
                        if (step.id === stepId && step.status !== 'completed') {
                            stepCompleted = true;
                            updatePoints(step.points, `Paso completado: ${step.title}`);
                            if (step.type === 'lesson') {
                                updateAchievementProgress('COMPLETE_LESSON');
                                updateMissionProgress('COMPLETE_LESSON', { lessonId: step.itemId });
                            }
                            return { ...step, status: 'completed' };
                        }
                        return step;
                    });

                    if (!stepCompleted) return path;

                    const completedStepIndex = newSteps.findIndex(s => s.id === stepId);
                    if (completedStepIndex !== -1 && completedStepIndex + 1 < newSteps.length) {
                        newSteps[completedStepIndex + 1].status = 'available';
                    }

                    const isPathComplete = newSteps.every(s => s.status === 'completed');

                    if (isPathComplete && !path.isCompleted) {
                         showToast(`¡Ruta de aprendizaje "${path.title}" completada!`, 'success');
                         updatePoints(path.rewardPoints, `Recompensa de ruta: ${path.title}`);
                         return { ...path, steps: newSteps, isCompleted: true };
                    }
                    
                    return { ...path, steps: newSteps };
                }
                return path;
            });
            return { ...prev, learningPaths: newPaths };
        });
    }, [setAppState, updatePoints, showToast, updateMissionProgress, updateAchievementProgress]);

    const handlePurchasePro = () => {
        setProUser(true);
        setShowProModal(false);
        showToast("¡Felicidades! Ahora eres un EcoScore Pro.", 'success');
        updatePoints(500, 'Bono por suscripción Pro');
    };

    const selectBadge = useCallback((achievementId) => {
        setUser(prevUser => {
            const currentBadges = prevUser.displayedBadges || [];
            const isSelected = currentBadges.includes(achievementId);
            let newBadges;

            if (isSelected) {
                newBadges = currentBadges.filter(id => id !== achievementId);
                showToast('Insignia removida de tu perfil.', 'info');
            } else {
                if (currentBadges.length < 3) {
                    newBadges = [...currentBadges, achievementId];
                    showToast('Insignia mostrada en tu perfil.', 'success');
                } else {
                    newBadges = [...currentBadges.slice(1), achievementId];
                    showToast('Insignia actualizada en tu perfil.', 'success');
                }
            }
            return { ...prevUser, displayedBadges: newBadges };
        });
    }, [setUser, showToast]);

    const contextValue = {
        user,
        onUserUpdate: setUser,
        isProUser,
        onProClick: handleProClick,
        appState,
        setAppState,
        updatePoints,
        showToast,
        consumeEnergy,
        activeGame,
        setActiveGame,
        completeLearningStep,
        selectBadge,
        updateMissionProgress,
        updateAchievementProgress,
    };

    if (!isLoggedIn) {
        return React.createElement(LoginPage, { onLogin: handleLogin });
    }

    return (
        React.createElement(AppContext.Provider, { value: contextValue },
            React.createElement(AppLayout, { onLogout: handleLogout, activePage: activePage, setActivePage: setActivePage }),
            showProModal && React.createElement(ProModal, { onClose: () => setShowProModal(false), onConfirm: handlePurchasePro }),
            React.createElement(GameManager, null)
        )
    );
}

const App = () => (
    React.createElement('div', { className: `font-sans` },
      React.createElement(ToastProvider, null,
        React.createElement(AppContent, null)
      )
    )
);
// --- END OF FILE: App.tsx ---

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  React.createElement(React.StrictMode, null,
    React.createElement(App, null)
  )
);
// --- END OF SCRIPT ---
    </script>
  </body>
</html>
